open import prelude
open import data-model
import command
import pomset
import seqcomp
import parcomp
import semantics

module augmentation (Event : Set) (MM : MemoryModel(Event)) where

  open MemoryModel MM
  open command(Event)(MM)
  open pomset(Event)(DM)
  open seqcomp(Event)(DM)
  open parcomp(Event)(DM)
  open semantics(Event)(MM)

  record _â‰²p_ (P Pâ€² : PomsetWithPreconditions) : Setâ‚ where

    open PomsetWithPreconditions P using (E ; â„“ ; Îº ; _â‰¤_ ; â†“)
    open PomsetWithPreconditions Pâ€² using () renaming (E to Eâ€² ; â„“ to â„“â€² ; Îº to Îºâ€² ; _â‰¤_ to _â‰¤â€²_; â‰¤-refl to â‰¤â€²-refl ; â†“ to â†“â€²)

    field Eâ€²âŠ†E : (Eâ€² âŠ† E)
    field EâŠ†Eâ€² : (E âŠ† Eâ€²)
    field â„“=â„“â€² : âˆ€ e â†’ (e âˆˆ E) â†’ (â„“(e) â‰¡ â„“â€²(e))
    field Îºâ€²âŠ¨Îº : âˆ€ e â†’ (e âˆˆ E) â†’ (Îºâ€²(e) âŠ¨ Îº(e))
    field â‰¤âŠ†â‰¤â€² : âˆ€ d e â†’ (d â‰¤ e) â†’ (d â‰¤â€² e)

    â†“âŠ†â†“' : âˆ€ e â†’ (e âˆˆ E) â†’ (â†“(e) âŠ† â†“â€²(e))
    â†“âŠ†â†“' e eâˆˆE d (dâˆˆE , dâ‰¤e) = (EâŠ†Eâ€² d dâˆˆE , â‰¤âŠ†â‰¤â€² d e dâ‰¤e)
    
  record _â‰²Ï„_ (P Pâ€² : PomsetWithPredicateTransformers) : Setâ‚ where

    open PomsetWithPredicateTransformers P using (PwP ; Ï„)
    open PomsetWithPredicateTransformers Pâ€² using () renaming (PwP to PwPâ€² ; Ï„ to Ï„â€²)

    field PwPâ‰²PwPâ€² : (PwP â‰²p PwPâ€²)
    open _â‰²p_ PwPâ‰²PwPâ€² public
    
    field Ï„â€²âŠ¨Ï„ : âˆ€ C Ï• â†’ (Ï„â€²(C)(Ï•) âŠ¨ Ï„(C)(Ï•))
    
  sem-resp-â‰²Ï„ : âˆ€ {P Pâ€²} C â†’ (P â‰²Ï„ Pâ€²) â†’ (P âˆˆ âŸ¦ C âŸ§) â†’ (Pâ€² âˆˆ âŸ¦ C âŸ§)
  sem-resp-â‰²p : âˆ€ {P Pâ€²} G â†’ (P â‰²p Pâ€²) â†’ (P âˆˆ âŸª G âŸ«) â†’ (Pâ€² âˆˆ âŸª G âŸ«)

  sem-resp-â‰²Ï„ {Pâ‚€} {Pâ€²â‚€} skip Pâ‚€â‰²Pâ€²â‚€ Pâ‚€âˆˆSKIP = Pâ€²â‚€âˆˆSKIP where

    open SKIP Pâ‚€âˆˆSKIP using (Eâ‚€âŠ†âˆ… ; Ï„â‚€Ï•âŠ¨Ï•)
    open _â‰²Ï„_ Pâ‚€â‰²Pâ€²â‚€ using () renaming (Eâ€²âŠ†E to Eâ€²â‚€âŠ†Eâ‚€ ; Ï„â€²âŠ¨Ï„ to Ï„â€²â‚€âŠ¨Ï„â‚€)
      
    Pâ€²â‚€âˆˆSKIP : Pâ€²â‚€ âˆˆ SKIP
    Pâ€²â‚€âˆˆSKIP = record
                { Eâ‚€âŠ†âˆ… = Î» e eâˆˆEâ€²â‚€ â†’ Eâ‚€âŠ†âˆ… e (Eâ€²â‚€âŠ†Eâ‚€ e eâˆˆEâ€²â‚€)
                ; Ï„â‚€Ï•âŠ¨Ï• = Î» C Ï• â†’ âŠ¨-trans (Ï„â€²â‚€âŠ¨Ï„â‚€ C Ï•) (Ï„â‚€Ï•âŠ¨Ï• C Ï•) }

  sem-resp-â‰²Ï„ {Pâ‚€} {Pâ€²â‚€} (Câ‚ âˆ™ Câ‚‚) Pâ‚€â‰²Pâ€²â‚€ Pâ‚€âˆˆâŸ¦Câ‚âŸ§â—âŸ¦Câ‚‚âŸ§ = Pâ€²â‚€âˆˆâŸ¦Câ‚âŸ§â—âŸ¦Câ‚‚âŸ§ where

    open _â—_ Pâ‚€âˆˆâŸ¦Câ‚âŸ§â—âŸ¦Câ‚‚âŸ§
    open PomsetWithPredicateTransformers Pâ‚ using () renaming (Ï„ to Ï„â‚ ; Ï„-resp-âŠ† to Ï„â‚-resp-âŠ†)
    open PomsetWithPredicateTransformers Pâ‚‚ using () renaming (E to Eâ‚‚ ; Îº to Îºâ‚‚)
    open PomsetWithPredicateTransformers Pâ‚€ using () renaming (â†“ to â†“â‚€)
    open PomsetWithPredicateTransformers Pâ€²â‚€ using () renaming (â†“ to â†“â€²â‚€)
    open _â‰²Ï„_ Pâ‚€â‰²Pâ€²â‚€ using () renaming (Eâ€²âŠ†E to Eâ€²â‚€âŠ†Eâ‚€ ; EâŠ†Eâ€² to Eâ‚€âŠ†Eâ€²â‚€ ; â„“=â„“â€² to â„“â‚€=â„“â€²â‚€ ; Îºâ€²âŠ¨Îº to Îºâ€²â‚€âŠ¨Îºâ‚€ ; â‰¤âŠ†â‰¤â€² to â‰¤â‚€âŠ†â‰¤â€²â‚€ ; Ï„â€²âŠ¨Ï„ to Ï„â€²â‚€âŠ¨Ï„â‚€ ; â†“âŠ†â†“' to â†“â‚€âŠ†â†“'â‚€) 

    rhsâ€²â‚€ : Event â†’ Formula
    rhsâ€²â‚€(e) = Ï„â‚(â†“â€²â‚€(e))(Îºâ‚‚(e))
   
    rhsâ‚€âŠ¨rhsâ€²â‚€ : âˆ€ e â†’ (e âˆˆ Eâ‚‚) â†’ (rhsâ‚€(e) âŠ¨ rhsâ€²â‚€(e))
    rhsâ‚€âŠ¨rhsâ€²â‚€ e eâˆˆEâ‚‚ = Ï„â‚-resp-âŠ† (â†“â‚€âŠ†â†“'â‚€ e (Eâ‚‚âŠ†Eâ‚€ e eâˆˆEâ‚‚))
    
    Pâ€²â‚€âˆˆâŸ¦Câ‚âŸ§â—âŸ¦Câ‚‚âŸ§ : Pâ€²â‚€ âˆˆ (âŸ¦ Câ‚ âŸ§ â— âŸ¦ Câ‚‚ âŸ§)
    Pâ€²â‚€âˆˆâŸ¦Câ‚âŸ§â—âŸ¦Câ‚‚âŸ§ = record
                      { Pâ‚ = Pâ‚
                      ; Pâ‚‚ = Pâ‚‚
                      ; Pâ‚âˆˆğ’«â‚ = Pâ‚âˆˆğ’«â‚
                      ; Pâ‚‚âˆˆğ’«â‚‚ = Pâ‚‚âˆˆğ’«â‚‚
                      ; Eâ‚€âŠ†Eâ‚âˆªEâ‚‚ = Î» e eâˆˆEâ€²â‚€ â†’ Eâ‚€âŠ†Eâ‚âˆªEâ‚‚ e (Eâ€²â‚€âŠ†Eâ‚€ e eâˆˆEâ€²â‚€)
                      ; Eâ‚âŠ†Eâ‚€ = Î» e eâˆˆEâ‚ â†’ Eâ‚€âŠ†Eâ€²â‚€ e (Eâ‚âŠ†Eâ‚€ e eâˆˆEâ‚)
                      ; Eâ‚‚âŠ†Eâ‚€ = Î» e eâˆˆEâ‚‚ â†’ Eâ‚€âŠ†Eâ€²â‚€ e (Eâ‚‚âŠ†Eâ‚€ e eâˆˆEâ‚‚)
                      ; â‰¤â‚âŠ†â‰¤â‚€ = Î» d e dâ‰¤â‚e â†’ â‰¤â‚€âŠ†â‰¤â€²â‚€ d e (â‰¤â‚âŠ†â‰¤â‚€ d e dâ‰¤â‚e)
                      ; â‰¤â‚‚âŠ†â‰¤â‚€ = Î» d e dâ‰¤â‚‚e â†’ â‰¤â‚€âŠ†â‰¤â€²â‚€ d e (â‰¤â‚‚âŠ†â‰¤â‚€ d e dâ‰¤â‚‚e)
                      ; Îºâ‚€âŠ¨lhsâ‚€ = Î» e eâˆˆEâ‚ eâˆ‰Eâ‚‚ â†’ âŠ¨-trans (Îºâ€²â‚€âŠ¨Îºâ‚€ e (Eâ‚âŠ†Eâ‚€ e eâˆˆEâ‚)) (Îºâ‚€âŠ¨lhsâ‚€ e eâˆˆEâ‚ eâˆ‰Eâ‚‚)
                      ; Îºâ‚€âŠ¨rhsâ‚€ = Î» e eâˆ‰Eâ‚ eâˆˆEâ‚‚ â†’ âŠ¨-trans (Îºâ€²â‚€âŠ¨Îºâ‚€ e (Eâ‚‚âŠ†Eâ‚€ e eâˆˆEâ‚‚)) (âŠ¨-trans (Îºâ‚€âŠ¨rhsâ‚€ e eâˆ‰Eâ‚ eâˆˆEâ‚‚) (rhsâ‚€âŠ¨rhsâ€²â‚€ e  eâˆˆEâ‚‚))
                      ; Îºâ‚€âŠ¨lhsâ‚€âˆ¨rhsâ‚€ = Î» e eâˆˆEâ‚ eâˆˆEâ‚‚ â†’ âŠ¨-trans (Îºâ€²â‚€âŠ¨Îºâ‚€ e (Eâ‚‚âŠ†Eâ‚€ e eâˆˆEâ‚‚)) (âŠ¨-trans (Îºâ‚€âŠ¨lhsâ‚€âˆ¨rhsâ‚€ e eâˆˆEâ‚ eâˆˆEâ‚‚) (âŠ¨-resp-âˆ¨ âŠ¨-refl (rhsâ‚€âŠ¨rhsâ€²â‚€ e  eâˆˆEâ‚‚)))
                      ; â„“â‚€=â„“â‚ = Î» e eâˆˆEâ‚ â†’ â‰¡-trans (â‰¡-symm (â„“â‚€=â„“â€²â‚€ e (Eâ‚âŠ†Eâ‚€ e eâˆˆEâ‚))) (â„“â‚€=â„“â‚ e eâˆˆEâ‚)
                      ; â„“â‚€=â„“â‚‚ =  Î» e eâˆˆEâ‚‚ â†’ â‰¡-trans (â‰¡-symm (â„“â‚€=â„“â€²â‚€ e (Eâ‚‚âŠ†Eâ‚€ e eâˆˆEâ‚‚))) (â„“â‚€=â„“â‚‚ e eâˆˆEâ‚‚)
                      ; Ï„â‚€Ï•âŠ¨Ï„â‚Ï„â‚‚Ï• = Î» C Ï• â†’ âŠ¨-trans (Ï„â€²â‚€âŠ¨Ï„â‚€ C Ï•) (Ï„â‚€Ï•âŠ¨Ï„â‚Ï„â‚‚Ï• C Ï•)
                      }
    
  sem-resp-â‰²Ï„ {Pâ‚€} {Pâ€²â‚€} (if Ïˆ then Câ‚ else Câ‚‚) Pâ‚€â‰²Pâ€²â‚€ Pâ‚€âˆˆIF = Pâ€²â‚€âˆˆIF where

    open IF Pâ‚€âˆˆIF
    open _â‰²Ï„_ Pâ‚€â‰²Pâ€²â‚€ using () renaming (Eâ€²âŠ†E to Eâ€²â‚€âŠ†Eâ‚€ ; EâŠ†Eâ€² to Eâ‚€âŠ†Eâ€²â‚€ ; â„“=â„“â€² to â„“â‚€=â„“â€²â‚€ ; Îºâ€²âŠ¨Îº to Îºâ€²â‚€âŠ¨Îºâ‚€ ; â‰¤âŠ†â‰¤â€² to â‰¤â‚€âŠ†â‰¤â€²â‚€ ; Ï„â€²âŠ¨Ï„ to Ï„â€²â‚€âŠ¨Ï„â‚€)
    
    Pâ€²â‚€âˆˆIF : Pâ€²â‚€ âˆˆ (IF Ïˆ âŸ¦ Câ‚ âŸ§ âŸ¦ Câ‚‚ âŸ§)
    Pâ€²â‚€âˆˆIF = record
               { Pâ‚ = Pâ‚
               ; Pâ‚‚ = Pâ‚‚
               ; Pâ‚âˆˆğ’«â‚ = Pâ‚âˆˆğ’«â‚
               ; Pâ‚‚âˆˆğ’«â‚‚ = Pâ‚‚âˆˆğ’«â‚‚
               ; Eâ‚€âŠ†Eâ‚âˆªEâ‚‚ = âŠ†-trans Eâ€²â‚€âŠ†Eâ‚€ Eâ‚€âŠ†Eâ‚âˆªEâ‚‚
               ; Eâ‚âŠ†Eâ‚€ = âŠ†-trans Eâ‚âŠ†Eâ‚€ Eâ‚€âŠ†Eâ€²â‚€
               ; Eâ‚‚âŠ†Eâ‚€ = âŠ†-trans Eâ‚‚âŠ†Eâ‚€ Eâ‚€âŠ†Eâ€²â‚€
               ; â‰¤â‚âŠ†â‰¤â‚€ = Î» d e dâ‰¤â‚e â†’ â‰¤â‚€âŠ†â‰¤â€²â‚€ d e (â‰¤â‚âŠ†â‰¤â‚€ d e dâ‰¤â‚e)
               ; â‰¤â‚‚âŠ†â‰¤â‚€ = Î» d e dâ‰¤â‚‚e â†’ â‰¤â‚€âŠ†â‰¤â€²â‚€ d e (â‰¤â‚‚âŠ†â‰¤â‚€ d e dâ‰¤â‚‚e)
               ; Îºâ‚€âŠ¨lhsâ‚€ = Î» e eâˆˆEâ‚ eâˆ‰Eâ‚‚ â†’ âŠ¨-trans (Îºâ€²â‚€âŠ¨Îºâ‚€ e (Eâ‚âŠ†Eâ‚€ e eâˆˆEâ‚)) (Îºâ‚€âŠ¨lhsâ‚€ e eâˆˆEâ‚ eâˆ‰Eâ‚‚)
               ; Îºâ‚€âŠ¨rhsâ‚€ = Î» e eâˆ‰Eâ‚ eâˆˆEâ‚‚ â†’ âŠ¨-trans (Îºâ€²â‚€âŠ¨Îºâ‚€ e (Eâ‚‚âŠ†Eâ‚€ e eâˆˆEâ‚‚)) (Îºâ‚€âŠ¨rhsâ‚€ e eâˆ‰Eâ‚ eâˆˆEâ‚‚)
               ; Îºâ‚€âŠ¨lhsâ‚€âˆ¨rhsâ‚€ =  Î» e eâˆˆEâ‚ eâˆˆEâ‚‚ â†’ âŠ¨-trans (Îºâ€²â‚€âŠ¨Îºâ‚€ e (Eâ‚‚âŠ†Eâ‚€ e eâˆˆEâ‚‚)) (Îºâ‚€âŠ¨lhsâ‚€âˆ¨rhsâ‚€ e eâˆˆEâ‚ eâˆˆEâ‚‚)
               ; â„“â‚€=â„“â‚ = Î» e eâˆˆEâ‚ â†’ â‰¡-trans (â‰¡-symm (â„“â‚€=â„“â€²â‚€ e (Eâ‚âŠ†Eâ‚€ e eâˆˆEâ‚))) (â„“â‚€=â„“â‚ e eâˆˆEâ‚)
               ; â„“â‚€=â„“â‚‚ = Î» e eâˆˆEâ‚‚ â†’ â‰¡-trans (â‰¡-symm (â„“â‚€=â„“â€²â‚€ e (Eâ‚‚âŠ†Eâ‚€ e eâˆˆEâ‚‚))) (â„“â‚€=â„“â‚‚ e eâˆˆEâ‚‚)
               ; Ï„â‚€Ï•âŠ¨Ï„â‚Ï• = Î» C Ï• â†’ âŠ¨-trans (âŠ¨-resp-âˆ§ âŠ¨-refl (Ï„â€²â‚€âŠ¨Ï„â‚€ C Ï•)) (Ï„â‚€Ï•âŠ¨Ï„â‚Ï• C Ï•)
               ; Ï„â‚€Ï•âŠ¨Ï„â‚‚Ï• =  Î» C Ï• â†’ âŠ¨-trans (âŠ¨-resp-âˆ§ âŠ¨-refl (Ï„â€²â‚€âŠ¨Ï„â‚€ C Ï•)) (Ï„â‚€Ï•âŠ¨Ï„â‚‚Ï• C Ï•)
               }


  sem-resp-â‰²Ï„ {P} {Pâ€²} (r :=[ L ]^ Î¼) Pâ‰²Pâ€² PâˆˆLOAD = Pâ€²âˆˆLOAD where

    open LOAD PâˆˆLOAD
    open _â‰²Ï„_ Pâ‰²Pâ€²

    Pâ€²âˆˆLOAD : Pâ€² âˆˆ LOAD r L Î¼
    Pâ€²âˆˆLOAD = record
                { v = v
                ; d=e = Î» d e dâˆˆEâ€² eâˆˆEâ€² â†’ d=e d e (Eâ€²âŠ†E d dâˆˆEâ€²) (Eâ€²âŠ†E e eâˆˆEâ€²)
                ; â„“=Rav = Î» e eâˆˆEâ€² â†’ â‰¡-trans (â‰¡-symm (â„“=â„“â€² e (Eâ€²âŠ†E e eâˆˆEâ€²))) (â„“=Rav e (Eâ€²âŠ†E e eâˆˆEâ€²))
                ; ÎºâŠ¨ÎºLOAD = Î» e eâˆˆEâ€² â†’ âŠ¨-trans (Îºâ€²âŠ¨Îº e (Eâ€²âŠ†E e eâˆˆEâ€²)) (ÎºâŠ¨ÎºLOAD e (Eâ€²âŠ†E e eâˆˆEâ€²))
                ; Ï„CâŠ¨Ï„LOADD = Î» C Ï• a e eâˆˆEâ€² eâˆˆC â†’ âŠ¨-trans (Ï„â€²âŠ¨Ï„ C Ï•) (Ï„CâŠ¨Ï„LOADD C Ï• a e (Eâ€²âŠ†E e eâˆˆEâ€²) eâˆˆC)
                ; Ï„CâŠ¨Ï„LOADI = Î» C Ï• a e eâˆˆEâ€² eâˆ‰C â†’ âŠ¨-trans (Ï„â€²âŠ¨Ï„ C Ï•) (Ï„CâŠ¨Ï„LOADI C Ï• a e (Eâ€²âŠ†E e eâˆˆEâ€²) eâˆ‰C)
                ; Ï„CâŠ¨Ï„LOADâˆ… = Î» C Ï• a s Ï‡ Ï‡âŠ¨Â¬Ïˆ â†’ âŠ¨-trans (Ï„â€²âŠ¨Ï„ C Ï•) (Ï„CâŠ¨Ï„LOADâˆ… C Ï• a s Ï‡ (Î» e eâˆˆE eâˆ‰C â†’ Ï‡âŠ¨Â¬Ïˆ e (EâŠ†Eâ€² e eâˆˆE) eâˆ‰C))
                }

  sem-resp-â‰²Ï„ {P} {Pâ€²} ([ L ]^ Î¼ := M) Pâ‰²Pâ€² PâˆˆSTORE = Pâ€²âˆˆSTORE where

    open STORE PâˆˆSTORE
    open _â‰²Ï„_ Pâ‰²Pâ€²

    Pâ€²âˆˆSTORE : Pâ€² âˆˆ STORE L Î¼ M
    Pâ€²âˆˆSTORE = record
                { v = v
                ; d=e = Î» d e dâˆˆEâ€² eâˆˆEâ€² â†’ d=e d e (Eâ€²âŠ†E d dâˆˆEâ€²) (Eâ€²âŠ†E e eâˆˆEâ€²)
                ; â„“=Wav = Î» e eâˆˆEâ€² â†’ â‰¡-trans (â‰¡-symm (â„“=â„“â€² e (Eâ€²âŠ†E e eâˆˆEâ€²))) (â„“=Wav e (Eâ€²âŠ†E e eâˆˆEâ€²))
                ; ÎºâŠ¨ÎºSTORE = Î» e eâˆˆEâ€² â†’ âŠ¨-trans (Îºâ€²âŠ¨Îº e (Eâ€²âŠ†E e eâˆˆEâ€²)) (ÎºâŠ¨ÎºSTORE e (Eâ€²âŠ†E e eâˆˆEâ€²))
                ; Ï„CâŠ¨Ï„STORED = Î» C Ï• a e eâˆˆEâ€² eâˆˆC â†’ âŠ¨-trans (Ï„â€²âŠ¨Ï„ C Ï•) (Ï„CâŠ¨Ï„STORED C Ï• a e (Eâ€²âŠ†E e eâˆˆEâ€²) eâˆˆC)
                ; Ï„CâŠ¨Ï„STOREI = Î» C Ï• a Ï‡ Ï‡âŠ¨Â¬Ïˆ â†’ âŠ¨-trans (Ï„â€²âŠ¨Ï„ C Ï•) (Ï„CâŠ¨Ï„STOREI C Ï• a Ï‡ (Î» e eâˆˆE eâˆ‰C â†’ Ï‡âŠ¨Â¬Ïˆ e (EâŠ†Eâ€² e eâˆˆE) eâˆ‰C))
                }
                
  sem-resp-â‰²Ï„ {P} {Pâ€²} (r := M) Pâ‰²Pâ€² PâˆˆLET = Pâ€²âˆˆLET where
    
    open LET PâˆˆLET
    open _â‰²Ï„_ Pâ‰²Pâ€²

    Pâ€²âˆˆLET : Pâ€² âˆˆ LET r M
    Pâ€²âˆˆLET = record
              { EâŠ†âˆ… = âŠ†-trans Eâ€²âŠ†E EâŠ†âˆ…
              ; Ï„Ï•âŠ¨Ï•[M/r] = Î» C Ï• â†’ âŠ¨-trans (Ï„â€²âŠ¨Ï„ C Ï•) (Ï„Ï•âŠ¨Ï•[M/r] C Ï•)
              }

  sem-resp-â‰²Ï„ {Pâ‚€} {Pâ€²â‚€} (fork G) Pâ‚€â‰²Pâ€²â‚€ Pâ‚€âˆˆFORK = Pâ€²â‚€âˆˆFORK where

    open FORK Pâ‚€âˆˆFORK
    open _â‰²Ï„_ Pâ‚€â‰²Pâ€²â‚€ using () renaming (Eâ€²âŠ†E to Eâ€²â‚€âŠ†Eâ‚€ ; EâŠ†Eâ€² to Eâ‚€âŠ†Eâ€²â‚€ ; â„“=â„“â€² to â„“â‚€=â„“â€²â‚€ ; Îºâ€²âŠ¨Îº to Îºâ€²â‚€âŠ¨Îºâ‚€ ; â‰¤âŠ†â‰¤â€² to â‰¤â‚€âŠ†â‰¤â€²â‚€ ; Ï„â€²âŠ¨Ï„ to Ï„â€²â‚€âŠ¨Ï„â‚€)
    
    Pâ€²â‚€âˆˆFORK : Pâ€²â‚€ âˆˆ FORK âŸª G âŸ«
    Pâ€²â‚€âˆˆFORK = record
                  { Pâ‚ = Pâ‚
                  ; Pâ‚âˆˆğ’« = Pâ‚âˆˆğ’«
                  ; Eâ‚âŠ†Eâ‚€ = âŠ†-trans Eâ‚âŠ†Eâ‚€ Eâ‚€âŠ†Eâ€²â‚€
                  ; Eâ‚€âŠ†Eâ‚ = âŠ†-trans Eâ€²â‚€âŠ†Eâ‚€ Eâ‚€âŠ†Eâ‚
                  ; â‰¤â‚âŠ†â‰¤â‚€ = Î» d e dâ‰¤â‚e â†’ â‰¤â‚€âŠ†â‰¤â€²â‚€ d e (â‰¤â‚âŠ†â‰¤â‚€ d e dâ‰¤â‚e)
                  ; Îºâ‚€âŠ¨Îºâ‚ = Î» e eâˆˆEâ‚ â†’ âŠ¨-trans (Îºâ€²â‚€âŠ¨Îºâ‚€ e (Eâ‚âŠ†Eâ‚€ e eâˆˆEâ‚)) (Îºâ‚€âŠ¨Îºâ‚ e eâˆˆEâ‚)
                  ; â„“â‚€=â„“â‚ = Î» e eâˆˆEâ‚ â†’ â‰¡-trans (â‰¡-symm (â„“â‚€=â„“â€²â‚€ e (Eâ‚âŠ†Eâ‚€ e eâˆˆEâ‚))) (â„“â‚€=â„“â‚ e eâˆˆEâ‚)
                  ; Ï„â‚€Ï•âŠ¨Ï• = Î» C Ï• â†’ âŠ¨-trans (Ï„â€²â‚€âŠ¨Ï„â‚€ C Ï•) (Ï„â‚€Ï•âŠ¨Ï• C Ï•)
                  }

  sem-resp-â‰²p {P} {Pâ€²} nil Pâ‰²Pâ€² PâˆˆNIL = Pâ€²âˆˆNIL where

    open NIL PâˆˆNIL
    open _â‰²p_ Pâ‰²Pâ€²
    
    Pâ€²âˆˆNIL : Pâ€² âˆˆ NIL
    Pâ€²âˆˆNIL = record { Eâ‚€âŠ†âˆ… = âŠ†-trans Eâ€²âŠ†E Eâ‚€âŠ†âˆ… }
    
  sem-resp-â‰²p {Pâ‚€} {Pâ€²â‚€} (thread C) Pâ‚€â‰²Pâ€²â‚€ Pâ‚€âˆˆTHREAD = Pâ€²â‚€âˆˆTHREAD where

    open THREAD Pâ‚€âˆˆTHREAD
    open _â‰²p_ Pâ‚€â‰²Pâ€²â‚€ using () renaming (Eâ€²âŠ†E to Eâ€²â‚€âŠ†Eâ‚€ ; EâŠ†Eâ€² to Eâ‚€âŠ†Eâ€²â‚€ ; â„“=â„“â€² to â„“â‚€=â„“â€²â‚€ ; Îºâ€²âŠ¨Îº to Îºâ€²â‚€âŠ¨Îºâ‚€ ; â‰¤âŠ†â‰¤â€² to â‰¤â‚€âŠ†â‰¤â€²â‚€) 
    
    Pâ€²â‚€âˆˆTHREAD : Pâ€²â‚€ âˆˆ THREAD âŸ¦ C âŸ§
    Pâ€²â‚€âˆˆTHREAD = record
                  { Pâ‚ = Pâ‚
                  ; Pâ‚âˆˆğ’« = Pâ‚âˆˆğ’«
                  ; Eâ‚âŠ†Eâ‚€ = âŠ†-trans Eâ‚âŠ†Eâ‚€ Eâ‚€âŠ†Eâ€²â‚€
                  ; Eâ‚€âŠ†Eâ‚ = âŠ†-trans Eâ€²â‚€âŠ†Eâ‚€ Eâ‚€âŠ†Eâ‚
                  ; â‰¤â‚âŠ†â‰¤â‚€ = Î» d e dâ‰¤â‚e â†’ â‰¤â‚€âŠ†â‰¤â€²â‚€ d e (â‰¤â‚âŠ†â‰¤â‚€ d e dâ‰¤â‚e)
                  ; Îºâ‚€âŠ¨Îºâ‚ = Î» e eâˆˆEâ‚ â†’ âŠ¨-trans (Îºâ€²â‚€âŠ¨Îºâ‚€ e (Eâ‚âŠ†Eâ‚€ e eâˆˆEâ‚)) (Îºâ‚€âŠ¨Îºâ‚ e eâˆˆEâ‚)
                  ; â„“â‚€=â„“â‚ = Î» e eâˆˆEâ‚ â†’ â‰¡-trans (â‰¡-symm (â„“â‚€=â„“â€²â‚€ e (Eâ‚âŠ†Eâ‚€ e eâˆˆEâ‚))) (â„“â‚€=â„“â‚ e eâˆˆEâ‚)
                  }
    
  sem-resp-â‰²p {Pâ‚€} {Pâ€²â‚€} (Gâ‚ âˆ¥ Gâ‚‚) Pâ‚€â‰²Pâ€²â‚€ Pâ‚€âˆˆâŸªGâ‚âŸ«|||âŸªGâ‚‚âŸ« = Pâ€²â‚€âˆˆâŸªGâ‚âŸ«|||âŸªGâ‚‚âŸ« where

    open _|||_ Pâ‚€âˆˆâŸªGâ‚âŸ«|||âŸªGâ‚‚âŸ«
    open _â‰²p_ Pâ‚€â‰²Pâ€²â‚€ using () renaming (Eâ€²âŠ†E to Eâ€²â‚€âŠ†Eâ‚€ ; EâŠ†Eâ€² to Eâ‚€âŠ†Eâ€²â‚€ ; â„“=â„“â€² to â„“â‚€=â„“â€²â‚€ ; Îºâ€²âŠ¨Îº to Îºâ€²â‚€âŠ¨Îºâ‚€ ; â‰¤âŠ†â‰¤â€² to â‰¤â‚€âŠ†â‰¤â€²â‚€) 

    Pâ€²â‚€âˆˆâŸªGâ‚âŸ«|||âŸªGâ‚‚âŸ« : Pâ€²â‚€ âˆˆ (âŸª Gâ‚ âŸ« ||| âŸª Gâ‚‚ âŸ«)
    Pâ€²â‚€âˆˆâŸªGâ‚âŸ«|||âŸªGâ‚‚âŸ« = record
                        { Pâ‚ = Pâ‚
                        ; Pâ‚‚ = Pâ‚‚
                        ; Pâ‚âˆˆğ’«â‚ = Pâ‚âˆˆğ’«â‚
                        ; Pâ‚‚âˆˆğ’«â‚‚ = Pâ‚‚âˆˆğ’«â‚‚
                        ; Eâ‚€âŠ†Eâ‚âŠEâ‚‚ = âŠ†-trans Eâ€²â‚€âŠ†Eâ‚€ Eâ‚€âŠ†Eâ‚âŠEâ‚‚
                        ; Eâ‚âŠ†Eâ‚€ = âŠ†-trans Eâ‚âŠ†Eâ‚€ Eâ‚€âŠ†Eâ€²â‚€
                        ; Eâ‚‚âŠ†Eâ‚€ = âŠ†-trans Eâ‚‚âŠ†Eâ‚€ Eâ‚€âŠ†Eâ€²â‚€
                        ; Eâ‚âˆ©Eâ‚‚âŠ†âˆ… = Eâ‚âˆ©Eâ‚‚âŠ†âˆ…
                        ; â‰¤â‚âŠ†â‰¤â‚€ = Î» d e dâ‰¤â‚e â†’ â‰¤â‚€âŠ†â‰¤â€²â‚€ d e (â‰¤â‚âŠ†â‰¤â‚€ d e dâ‰¤â‚e)
                        ; â‰¤â‚‚âŠ†â‰¤â‚€ = Î» d e dâ‰¤â‚‚e â†’ â‰¤â‚€âŠ†â‰¤â€²â‚€ d e (â‰¤â‚‚âŠ†â‰¤â‚€ d e dâ‰¤â‚‚e)
                        ; Îºâ‚€âŠ¨Îºâ‚ = Î» e eâˆˆEâ‚ â†’ âŠ¨-trans (Îºâ€²â‚€âŠ¨Îºâ‚€ e (Eâ‚âŠ†Eâ‚€ e eâˆˆEâ‚)) (Îºâ‚€âŠ¨Îºâ‚ e eâˆˆEâ‚)
                        ; Îºâ‚€âŠ¨Îºâ‚‚ = Î» e eâˆˆEâ‚‚ â†’ âŠ¨-trans (Îºâ€²â‚€âŠ¨Îºâ‚€ e (Eâ‚‚âŠ†Eâ‚€ e eâˆˆEâ‚‚)) (Îºâ‚€âŠ¨Îºâ‚‚ e eâˆˆEâ‚‚)
                        ; â„“â‚€=â„“â‚ =  Î» e eâˆˆEâ‚ â†’ â‰¡-trans (â‰¡-symm (â„“â‚€=â„“â€²â‚€ e (Eâ‚âŠ†Eâ‚€ e eâˆˆEâ‚))) (â„“â‚€=â„“â‚ e eâˆˆEâ‚)
                        ; â„“â‚€=â„“â‚‚ = Î» e eâˆˆEâ‚‚ â†’ â‰¡-trans (â‰¡-symm (â„“â‚€=â„“â€²â‚€ e (Eâ‚‚âŠ†Eâ‚€ e eâˆˆEâ‚‚))) (â„“â‚€=â„“â‚‚ e eâˆˆEâ‚‚)
                        }
    
    
