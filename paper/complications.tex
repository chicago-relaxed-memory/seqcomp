\section{If Closure and Address Calculation}
\label{sec:complications}

\subsection{If Closure ($\xIF$)}
Requires indexing to resolve nondeterminism.

IF closure/case analysis: $\psi_e$

\begin{definition}[$\xIF$]
  \label{def:pomsets-if}
  Update \refdef{def:pomsets-trans} to:

  If $\aPS \in \sSTOREtight[\amode]{\aLoc}{\aExp}$ then
  $(\exists\aVal:\aEvs\fun\Val)$
  $(\exists\cForm:\aEvs\fun\Formulae)$
  \begin{enumerate}
  \item[\ref{S1})] if $\cForm_\bEv\land\cForm_\aEv$ is satisfiable then $\bEv=\aEv$,
  \item[\ref{S2})] $\labelingAct(\aEv) = \DWREFP{\cVal_\aEv}{\aVal_\aEv}$,
  \item[\ref{S3})] $\labelingForm(\aEv)$ implies $\cForm_\aEv \land \aExp{=}\aVal$,
  \item[\ref{S4})] $(\forall\aEv\in\aEvs\cap\bEvs)$
    $\aTr{\bEvs}{\bForm}$ implies $\cForm_\aEv \limplies \bForm[\aExp/\aLoc]$,
  \item[\ref{S5})] 
    $\aTr{\cEvs}{\bForm}$ implies $(\!\not\exists\aEv\in\aEvs\cap\cEvs \suchthat \cForm_\aEv) \limplies \bForm[\aExp/\aLoc]$,
  \end{enumerate}

  If $\aPS \in \sLOAD[\amode]{\aReg}{\aLoc}$ then
  $(\exists\aVal:\aEvs\fun\Val)$
  $(\exists\cForm:\aEvs\fun\Formulae)$
  \begin{enumerate}
  \item[\ref{L1})] if $\cForm_\bEv\land\cForm_\aEv$ is satisfiable then $\bEv=\aEv$,
  \item[\ref{L2})] $\labelingAct(\aEv) = \DRREFP{\cVal_\aEv}{\aVal_\aEv}$,
  \item[\ref{L3})] $\labelingForm(\aEv)$ implies $\cForm_\aEv$.
  \item[\ref{L4})] $(\forall\aEv\in\aEvs\cap\bEvs)$
    $\aTr{\bEvs}{\bForm}$ implies $\cForm_\aEv \limplies \aVal_\aEv{=}\uReg{\aEv}\limplies\bForm[\uReg{\aEv}/\aReg]$, 
  \item[\ref{L5})] $(\forall\aEv\in\aEvs\setminus\cEvs)$
    $\aTr{\cEvs}{\bForm}$ implies $\cForm_\aEv \limplies (\aVal_\aEv{=}\uReg{\aEv}\lor \aLoc{=}\uReg{\aEv})\allowbreak\limplies\bForm[\uReg{\aEv}/\aReg]$,
  \item[\ref{L6})] $(\forall\bReg)$
    $\aTr{\dEvs}{\bForm}$ implies $(\!\not\exists\aEv\in\aEvs \suchthat \cForm_\aEv) \limplies \bForm[\bReg/\aReg]$. 
  \end{enumerate}  
\end{definition}

\subsection{Address Calculation ($\xADDR$)}

\begin{definition}[$\xADDR$]
  \label{def:pomsets-addr}
  Update \refdef{def:pomsets-trans} to existentially quantify over $\cVal$
  in $\sSTORE{}{}$ and $\sLOAD{}{}$:
  \begin{enumerate}
  \item[\ref{S2})] $\labelingAct(\aEv) = \DW{\REF\cVal}{\aVal}$,
  \item[\ref{L2})] $\labelingAct(\aEv) = \DR{\REF{\cVal}}{\aVal}$.
  \end{enumerate}

  \begin{enumerate}
  \item[\ref{S3})] $\labelingForm(\aEv)$ implies $\cExp{=}\cVal \land \aExp{=}\aVal$,
  \item[\ref{L3})] $\labelingForm(\aEv)$ implies $\cExp{=}\cVal$.
  \end{enumerate}

  \begin{enumerate}
  \item[\ref{S4})] $(\forall\dVal)$ $\aTr{\bEvs}{\bForm}$ implies $\cExp{=}\dVal \limplies \bForm[\aExp/\REF{\dVal}]$,
  \item[\ref{S5})] $(\forall\dVal)$ $\aTr{\cEvs}{\bForm}$ implies $\cExp{=}\dVal \limplies \bForm[\aExp/\REF{\dVal}]$,
  \item[\ref{L4})] $(\forall\dVal)$ $\aTr{\bEvs}{\bForm}$ implies $\cExp{=}\dVal \limplies \aVal{=}\aReg\limplies\bForm$, 
  \item[\ref{L5})] $(\forall\dVal)$ $\aTr{\cEvs}{\bForm}$ implies $\cExp{=}\dVal \limplies (\aVal{=}\aReg\lor \REF{\dVal}{=}\aReg)\limplies\bForm$,
  \item[\ref{L6})] $(\forall\dVal)$ $\aTr{\dEvs}{\bForm}$ implies $\cExp{=}\dVal \limplies \bForm$.
  \end{enumerate}  
\end{definition}

\begin{example}
  punning badly:
  Consider that
  \begin{math}
    \sem{\REF{r} \GETS 0\SEMI \REF{0}\GETS \BANG r}
  \end{math}
  includes both of the following pomsets (``$\BANG$'' is logical
  negation---``$\BANG \aExp$'' evaluates to $1$ if
  $\aExp$ is $0$, and $0$ otherwise):
  \begin{align*}
    \begin{gathered}
      \REF{r} \GETS 0\SEMI \REF{0}\GETS \BANG r
      \\
      \hbox{\begin{tikzinline}[node distance=1em]
          \eventl{d}{a}{r\EQ0\mathbin{\mid}\DW{\REF{0}}{0}}{}
          \eventl{e}{b}{r\EQ0\mathbin{\mid}\DW{\REF{0}}{1}}{below=of a}
          \wk{a}{b}
        \end{tikzinline}}
    \end{gathered}
    &&
    \begin{gathered}
      \REF{r} \GETS 0\SEMI \REF{0}\GETS \BANG r
      \\
      \hbox{\begin{tikzinline}[node distance=1em]
          \eventl{c}{a}{r\EQ1\mathbin{\mid}\DW{\REF{1}}{0}}{}
          \eventl{d}{b}{r\EQ1\mathbin{\mid}\DW{\REF{0}}{0}}{below=of a}
        \end{tikzinline}}
    \end{gathered}
  \end{align*}
  Thus, the disjunction closure also includes both of the following: % By using \!$\PAR$\!, it also includes:
  \begin{align*}
    \hbox{\begin{tikzinline}[node distance=1em]
        \eventl{d}{a}{r\EQ0\lor r\EQ1\mathbin{\mid}\DW{\REF{0}}{0}}{}
        \eventl{e}{b}{r\EQ0\mathbin{\mid}\DW{\REF{0}}{1}}{below=of a}
        \wk{a}{b}
      \end{tikzinline}}
    &&
    \hbox{\begin{tikzinline}[node distance=1em]
        \eventl{c}{a}{r\EQ1\mathbin{\mid}\DW{\REF{1}}{0}}{}
        \eventl{d}{b}{r\EQ0\lor r\EQ1\mathbin{\mid}\DW{\REF{0}}{0}}{below=of a}
      \end{tikzinline}}
  \end{align*}
  In this example, the $d$ events that coalesce come from inconsistent executions.
  This is possible because the $d$ events originate from different commands.
\end{example}

% \subsection{Agda}
% \begin{figure*}
%   \includegraphics[width=\textwidth]{agda.png}
% \end{figure*}
