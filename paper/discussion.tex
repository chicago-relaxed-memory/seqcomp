\section{Discussion}
\label{sec:discussion}

\subsection{Combining Address Calculation and If-Closure}

\refdef{def:semaddr} is naive with respect to merging events.  Consider the
following example:
\begin{align*}
  \begin{gathered}
    \PW{\REF{r}}{0}\SEMI \PW{\REF{0}}{\BANG r}
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \eventl{c}{a}{r\EQ1\mathbin{\mid}\DW{\REF{1}}{0}}{}
        \eventl{d}{b}{r\EQ1\mathbin{\mid}\DW{\REF{0}}{0}}{right=of a}
      \end{tikzinline}}
  \end{gathered}
  &&
  \begin{gathered}
    \PW{\REF{r}}{0}\SEMI \PW{\REF{0}}{\BANG r}
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \eventl{d}{a}{r\EQ0\mathbin{\mid}\DW{\REF{0}}{0}}{}
        \eventl{e}{b}{r\EQ0\mathbin{\mid}\DW{\REF{0}}{1}}{right=of a}
        \wki{a}{b}
      \end{tikzinline}}
  \end{gathered}
\end{align*}
Merging, we have:
% Thus, the disjunction closure also includes both of the following: % By using \!$\PAR$\!, it also includes:
\begin{align*}
  \begin{gathered}
    \IF{\aExp}\THEN
    \PW{\REF{r}}{0}\SEMI \PW{\REF{0}}{\BANG r}
    \ELSE
    \PW{\REF{r}}{0}\SEMI \PW{\REF{0}}{\BANG r}
    \FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \eventl{c}{a}{r\EQ1\mathbin{\mid}\DW{\REF{1}}{0}}{}
        \eventl{d}{b}{r\EQ0\lor r\EQ1\mathbin{\mid}\DW{\REF{0}}{0}}{right=of a}
        \eventl{e}{c}{r\EQ0\mathbin{\mid}\DW{\REF{0}}{1}}{right=of b}
        \wki{b}{c}
      \end{tikzinline}}
  \end{gathered}
\end{align*}
% \begin{align*}
%   \begin{gathered}
%     \IF{\aExp}\THEN
%     \PW{\REF{r}}{0}\SEMI \PW{\REF{0}}{\BANG r}
%     \ELSE
%     \PW{\REF{r}}{0}\SEMI \PW{\REF{0}}{\BANG r}
%     \FI
%     \\
%     \hbox{\begin{tikzinline}[node distance=1em]
%       \eventl{c}{a}{r\EQ1\mathbin{\mid}\DW{\REF{1}}{0}}{}
%       \eventl{d}{b}{r\EQ0\lor r\EQ1\mathbin{\mid}\DW{\REF{0}}{0}}{right=of a}
%     \end{tikzinline}}
%   \end{gathered}
% \end{align*}
The precondition of $\DWREF{0}{0}$ is a tautology; however, this is not
possible for $(\PW{\REF{r}}{0}\SEMI \PW{\REF{0}}{\BANG r})$ alone, using \refdef{def:semaddr}.

\refdef{def:semcaaddr}, enables this execution using if-closure.  Under this
semantics, we have:
\begin{align*}
  \begin{gathered}
    \PW{\REF{r}}{0}
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \eventl{c}{a}{r\EQ1\mathbin{\mid}\DW{\REF{1}}{0}}{}
        \eventl{d}{b}{r\EQ0\mathbin{\mid}\DW{\REF{0}}{0}}{right=of a}
      \end{tikzinline}}
  \end{gathered}
  &&
  \begin{gathered}
    \PW{\REF{0}}{\BANG r}
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \eventl{d}{b}{r\EQ1\mathbin{\mid}\DW{\REF{0}}{0}}{}
        \eventl{e}{c}{r\EQ0\mathbin{\mid}\DW{\REF{0}}{1}}{right=of b}
      \end{tikzinline}}
  \end{gathered}
\end{align*}
% These pomsets contain inconsistent preconditions.  This is disallowed in
% \jjr{}, but allowed here.
Sequencing and merging: 
\begin{align*}
  \begin{gathered}
    \PW{\REF{r}}{0}
    \SEMI
    \PW{\REF{0}}{\BANG r}
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \eventl{c}{a}{r\EQ1\mathbin{\mid}\DW{\REF{1}}{0}}{}
        \eventl{d}{b}{r\EQ0\lor r\EQ1\mathbin{\mid}\DW{\REF{0}}{0}}{right=of a}
        \eventl{e}{c}{r\EQ0\mathbin{\mid}\DW{\REF{0}}{1}}{right=of b}
        \wki{b}{c}
      \end{tikzinline}}
  \end{gathered}
\end{align*}
The precondition of $\DWP{\REF{0}}{0}$ is a tautology, as required.

\begin{definition}
  \label{def:semcaaddr}
  Let $\semcaaddr{}$ be defined as in \reffig{fig:seq}, changing
  $\sSTORE{}{}$ and $\sLOAD{}{}$:

  \noindent
  If $\aPS \in \sSTORE[\amode]{\cExp}[\ascope]{\aExp}[\aThrd]$ then
  $(\exists\cVal:\aEvs\fun\Val)$
  $(\exists\aVal:\aEvs\fun\Val)$
  $(\exists\cForm:\aEvs\fun\Formulae)$
  \begin{multicols}{2}
    \begin{enumerate}[topsep=0pt,label=(\textsc{w}\arabic*),ref=\textsc{w}\arabic*]
    \item \label{write-E-ca-addr}
      if $\cForm_\bEv\land\cForm_\aEv$ is satisfiable then $\bEv=\aEv$,
    \item \label{write-lambda-ca-addr}
      $\labelingAct(\aEv) = \DW[\amode]{\REF{\cVal}}[\ascope]{\aVal_\aEv}[\aThrd]$,
    \item \label{write-kappa-ca-addr}
      \begin{math}
        \labelingForm(\aEv) \riff
        \cForm_\aEv
        \land \cExp{=}\cVal_\aEv
        \land \aExp{=}\aVal_\aEv
      \end{math},      
    \item
    \begin{math}
      (\forall\dVal)
      \begin{aligned}[t]
        \aTr{\bEvs}{\bForm} \riff
        &\textstyle\bigwedge_{\aEv\in\aEvs}
        \cForm_\aEv
        \limplies (\cExp{=}\cVal)
        \limplies 
        \bForm[\aExp/\aLoc][\aExp{=}\aVal_\aEv/\Q{\aLoc}]
        \\[-.5ex]
        \land
        &\textstyle (\bigwedge_{\aEv\in\aEvs}\lnot\cForm_\aEv)
        \limplies (\cExp{=}\dVal)
        \limplies 
        \bForm[\aExp/\aLoc][\FALSE/\Q{\aLoc}]
      \end{aligned}
    \end{math}
    \columnbreak
    % \stepcounter{enumi}
    % \item[] \labeltext[\textsc{w}4]{}{write-tau-ca-addr}
      % \begin{enumerate}[leftmargin=0pt]
      % \item \label{write-tau-dep-ca-addr}
      %   \begin{math}
      %     \aTr{\bEvs}{\bForm} \riff 
      %     \cForm_\aEv
      %     \limplies (\cExp{=}\cVal)
      %     \limplies 
      %     \bForm[\aExp/\REF{\cVal}]
      %   \end{math},
      % \item \label{write-tau-empty-ca-addr}
      %   \begin{math}
      %     (\forall\dVal)
      %   \end{math}
      %   \begin{math}
      %     \aTr{\bEvs}{\bForm} \riff 
      %     % (\!\not\exists\aEv\in\aEvs \suchthat \cForm_\aEv)
      %     (\bigwedge_{\aEv\in\aEvs}\lnot\cForm_\aEv)
      %     \limplies (\cExp{=}\dVal)
      %     \limplies 
      %     \bForm
      %     [\aExp/\REF{\dVal}]
      %   \end{math}  
      % \end{enumerate}  
      \stepcounter{enumi}
    \item[] \labeltext[\textsc{w}5]{}{write-term-ca-addr}
      \begin{enumerate}[leftmargin=0pt]
      \item \label{write-term-nonempty-ca-addr}
        $\aTerm \riff \cForm_\aEv \limplies \cExp{=}\cVal_\aEv \land \aExp{=}\aVal_\aEv$,
      \item \label{write-term-empty-ca-addr}
        $\aTerm \riff \bigvee_{\aEv\in\aEvs}\cForm_\aEv$.
      \end{enumerate}
    \end{enumerate}
  \end{multicols}

  \medskip
  \noindent
  If $\aPS \in \sLOAD[\amode]{\aReg}[\ascope]{\cExp}[\aThrd]$ then
  $(\exists\cVal:\aEvs\fun\Val)$
  $(\exists\aVal:\aEvs\fun\Val)$
  $(\exists\cForm:\aEvs\fun\Formulae)$ 
  \begin{multicols}{2}
  \begin{enumerate}[topsep=0pt,label=(\textsc{r}\arabic*),ref=\textsc{r}\arabic*]
  \item \label{read-E-ca-addr}
    if $\cForm_\bEv\land\cForm_\aEv$ is satisfiable then $\bEv=\aEv$,
  \item \label{read-lambda-ca-addr}
    $\labelingAct(\aEv) = \DR[\amode]{\REF{\cVal}}[\ascope]{\aVal_\aEv}[\aThrd]$
  \item \label{read-kappa-ca-addr}
    \begin{math}
      \labelingForm(\aEv) \riff
      \cForm_\aEv
      \land \cExp{=}\cVal_\aEv
      \land \Q{\REF{\cVal}}
    \end{math},
    \stepcounter{enumi}
  \item \label{read-tau-ca-addr}
    \begin{math}
      \begin{aligned}[t]
        (\forall\bReg)
        \aTr{\bEvs}{\bForm} \riff
        &\textstyle\bigwedge_{\aEv\in\aEvs\cap\bEvs}
        \cForm_\aEv
        \limplies (\cExp{=}\cVal_\aEv\limplies\aVal_\aEv{=}\uReg{\aEv})
        \limplies \bForm[\uReg{\aEv}/\aReg]
        \\[-.5ex]
        \land
        &\textstyle\bigwedge_{\aEv\in\aEvs\setminus\bEvs}
        \cForm_\aEv 
        \limplies
        \PBR{(\cExp{=}\cVal_\aEv\limplies\aVal_\aEv{=}\uReg{\aEv}) \lor (\cExp{=}\cVal_\aEv\limplies\REF{\cVal}{=}\uReg{\aEv})}
        \limplies
        \bForm[\uReg{\aEv}/\aReg]
        \\[-.5ex]
        \land
        &\textstyle (\bigwedge_{\aEv\in\aEvs}\lnot\cForm_\aEv)
        \limplies 
        \bForm[\bReg/\aReg],
      \end{aligned}
    \end{math}
  % \item[] \labeltext[\textsc{r}4]{}{read-tau-ca-addr}
  %   \begin{enumerate}[leftmargin=0pt]
  %   \item \label{read-tau-dependent-ca-addr}
  %     \begin{math}
  %       (\forall\aEv\in\aEvs\cap\bEvs)
  %     \end{math}
  %     \begin{math}
  %       \aTr{\bEvs}{\bForm} \riff
  %       \cForm_\aEv
  %       \limplies (\cExp{=}\cVal_\aEv\limplies\aVal_\aEv{=}\uReg{\aEv})
  %       \limplies \bForm[\uReg{\aEv}/\aReg]
  %     \end{math},      
  %   \item \label{read-tau-independent-ca-addr}
  %     \begin{math}
  %       (\forall\aEv\in\aEvs\setminus\bEvs)
  %     \end{math}
  %     \begin{math}
  %       \aTr{\bEvs}{\bForm} \riff
  %       \cForm_\aEv 
  %       \limplies
  %       \PBR{(\cExp{=}\cVal_\aEv\limplies\aVal_\aEv{=}\uReg{\aEv}) \lor (\cExp{=}\cVal_\aEv\limplies\REF{\cVal}{=}\uReg{\aEv})}
  %       \limplies
  %       \bForm[\uReg{\aEv}/\aReg]
  %     \end{math},      
  %   \item \label{read-tau-empty-ca-addr}
  %     \begin{math}
  %       (\forall\bReg)
  %     \end{math}
  %     \begin{math}
  %       \aTr{\bEvs}{\bForm} \riff 
  %       (\bigwedge_{\aEv\in\aEvs}\lnot\cForm_\aEv)
  %       \limplies 
  %       \bForm[\bReg/\aReg],
  %     \end{math}  
  %   \end{enumerate}  
    \columnbreak
  \item \label{read-term-ca-addr}
    if $\aEvs=\emptyset$ and $\amode\neq\mRLX$ then $\aTerm \riff \FALSE$. 
  \end{enumerate}
  \end{multicols}
  % \medskip Similarly, let $\frf{\semaddr{}}$ be defined as for $\frf{\semrr{}}$
  % in \refdef{def:sem:frf}, with these definitions of $\sSTORE{}{}$ and
  % $\sLOAD{}{}$.
\end{definition}

\input{oopsla.tex}

\subsection{Substitutions}
\label{sec:substitutions}

In $\sLOAD{}{}$, it is also possible to collapse $\aLoc$ and $\aReg$ via substitution:
\begin{enumerate}
\item[{\labeltext[\textsc{r}4a$'$]{(\textsc{r}4a$'$)}{read-tau-dep-sub}}]
  if $(\aEvs\cap\bEvs)\neq\emptyset$ then
  \begin{math}
    \aTr{\bEvs}{\bForm} \riff
    \aVal{=}\aReg
    \limplies \bForm[\aReg/\aLoc]
  \end{math},    
\item[{\labeltext[\textsc{r}4b$'$]{(\textsc{r}4b$'$)}{read-tau-ind-sub}}]
  if $\aEvs\neq\emptyset$ and $(\aEvs\cap\bEvs)=\emptyset$ then
  \begin{math}
    \aTr{\bEvs}{\bForm} \riff
    \PBR{\aVal{=}\aReg \lor \aLoc{=}\aReg} \limplies
    \bForm[\aReg/\aLoc],
  \end{math}
\item[{\labeltext[\textsc{r}4c$'$]{(\textsc{r}4c$'$)}{read-tau-empty-sub}}]
  if $\aEvs=\emptyset$ then
  \begin{math}
    \aTr{\bEvs}{\bForm} \riff
    % \PBR{\aVal{=}\aReg \lor \aLoc{=}\aReg} \limplies
    \bForm[\aReg/\aLoc],
  \end{math}
\end{enumerate}
Perhaps surprisingly, this semantics is incomparable with that of
\reffig{fig:seq}.  Consider the following:
\begin{gather*}
  \IF{r\land s\;\mathsf{even}}\THEN \PW{y}{1}\FI\SEMI
  \IF{r\land s}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=0.5em and 1.5em]
      \event{a3}{r\land s\;\mathsf{even}\mid\DW{y}{1}}{}
      \event{a4}{r\land s\mid\DW{z}{1}}{right=of a3}
    \end{tikzinline}}
\end{gather*}
Prepending $\PRP{x}{s}$, we get the same result regardless of whether we
substitute $[s/x]$, since $x$ does not occur in either precondition.  Here
we show the independent case:
\begin{gather*}
  \PR{x}{s}\SEMI
  \IF{r\land s\;\mathsf{even}}\THEN \PW{y}{1}\FI\SEMI
  \IF{r\land s}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=0.5em and 1.5em]
      \event{a2}{\DR{x}{2}}{}
      \event{a3}{(2{=}s\lor x{=}s)\limplies (r\land s\;\mathsf{even})\mid\DW{y}{1}}{right=of a2}
      \event{a4}{(2{=}s\lor x{=}s)\limplies (r\land s)\mid\DW{z}{1}}{right=of a3}
    \end{tikzinline}}
\end{gather*}
Since the preconditions mention $x$, prepending $\PRP{x}{r}$, we now get
different results depending on whether we perform the substitution.  Without
any substitution, we have:
\begin{gather*}
  \PR{x}{r}\SEMI
  \PR{x}{s}\SEMI
  \IF{r\land s\;\mathsf{even}}\THEN \PW{y}{1}\FI\SEMI
  \IF{r\land s}\THEN \PW{z}{1}\FI
  \\[-2ex]
  \hbox{\begin{tikzinline}[node distance=0.5em and 1.5em]
      \event{a1}{\DR{x}{1}}{}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{1{=}r\limplies  (2{=}s\lor x{=}s)\limplies (r\land s\;\mathsf{even})\mid\DW{y}{1}}{right=of a2}
      \event{a4}{1{=}r\limplies  (2{=}s\lor x{=}s)\limplies (r\land s)\mid\DW{z}{1}}{right=of a3}
      \po[out=12,in=168]{a1}{a3}
      \po[out=10,in=170]{a1}{a4}
    \end{tikzinline}}
\end{gather*}
Prepending $\PWP{x}{0}$, which substitutes $[0/x]$, the precondition of
$\DWP{y}{1}$ becomes
$(1{=}r\limplies (2{=}s\lor0{=}s)\limplies (r\land s\;\mathsf{even}))$, which
is a tautology, whereas the precondition of $\DW{z}{1}$ becomes
$(1{=}r\limplies(2{=}s\lor0{=}s)\limplies (r\land s))$, which is not.  In
order to be top-level, $\DWP{z}{1}$ must be dependency ordered after
$\DRP{x}{2}$; in this case the precondition becomes
$(1{=}r\limplies2{=}s\limplies (r\land s))$, which is a tautology.
\begin{gather*}
  % \PW{x}{0}\SEMI
  % \PR{x}{r}\SEMI
  % \PR{x}{s}\SEMI
  % \IF{r\land s\;\mathsf{even}}\THEN \PW{y}{1}\FI\SEMI
  % \IF{r\land s}\THEN \PW{z}{1}\FI
  % \\
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a0}{\DW{x}{0}}{}
      \event{a1}{\DR{x}{1}}{right=of a0}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \event{a4}{\DW{z}{1}}{right=of a3}
      % \wk{a0}{a1}
      % \wk[out=-20,in=-160]{a0}{a2}
      \po[out=20,in=160]{a1}{a3}
      \po[out=20,in=160]{a1}{a4}
      \po[out=-20,in=-160]{a2}{a4}
    \end{tikzinline}}
\end{gather*}
The situation reverses with the substitution $[r/x]$:
\begin{gather*}
  \PR{x}{r}\SEMI
  \PR{x}{s}\SEMI
  \IF{r\land s\;\mathsf{even}}\THEN \PW{y}{1}\FI\SEMI
  \IF{r\land s}\THEN \PW{z}{1}\FI
  \\[-2ex]
  \hbox{\begin{tikzinline}[node distance=0.5em and 1.5em]
      \event{a1}{\DR{x}{1}}{}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{1{=}r\limplies  (2{=}s\lor r{=}s)\limplies (r\land s\;\mathsf{even})\mid\DW{y}{1}}{right=of a2}
      \event{a4}{1{=}r\limplies  (2{=}s\lor r{=}s)\limplies (r\land s)\mid\DW{z}{1}}{right=of a3}
      \po[out=12,in=168]{a1}{a3}
      \po[out=10,in=170]{a1}{a4}
    \end{tikzinline}}
\end{gather*}
Prepending $\PWP{x}{0}$:
%\vspace{-.5\baselineskip}
\begin{gather*}
  % \PW{x}{0}\SEMI
  % \PR{x}{r}\SEMI
  % \PR{x}{s}\SEMI
  % \IF{r\land s\;\mathsf{even}}\THEN \PW{y}{1}\FI\SEMI
  % \IF{r\land s}\THEN \PW{z}{1}\FI
  % \\
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a0}{\DW{x}{0}}{}
      \event{a1}{\DR{x}{1}}{right=of a0}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \event{a4}{\DW{z}{1}}{right=of a3}
      % \wk{a0}{a1}
      % \wk[out=-20,in=-160]{a0}{a2}
      \po[out=20,in=160]{a1}{a3}
      \po[out=20,in=160]{a1}{a4}
      \po{a2}{a3}
    \end{tikzinline}}
\end{gather*}
The dependency has changed from $\DRP{x}{2}\xpo\DWP{z}{1}$ to
$\DRP{x}{2}\xpo\DWP{y}{1}$.  The resulting sets of pomsets are
incomparable.


Thinking in terms of hardware, the difference is whether reads update the
cache, thus clobbering preceding writes.  With $[r/x]$, reads clobber the
cache, whereas without the substitution, they do not.  Since most caches work
this way, the model with $[r/x]$ is likely preferred for modeling hardware.
However, this substitution only makes sense in a model with read-read
coherence and read-read dependencies, which we will see is not the case for Arm.  By
leaving out the substitution, we also ensure that downgraded reads are
fulfilled by preceding writes, not reads.





% \begin{figure*}[t]
%   \showRAtrue
%   \begin{center}
%     \begin{minipage}{.91\textwidth}
%       \input{fig-no-q-or-addr.tex}
%     \end{minipage}
%   \end{center}
%   \caption{Simplified Quiescence Semantics w/o Address Calculation
%     (See %\refdef{def:QSx} for $\QS{}{\amode}$, $\QL{}{\amode}$, and
%     \refdef{def:dlx} for $\DLX{\aLoc}{\amode}{\bmode}$, $\DS{\aLoc}{\amode}$)
%   } 
%   \label{fig:no-q-or-addr}
% \end{figure*}    
% \begin{figure*}
%   \begin{center}
%     \begin{minipage}{.91\textwidth}
%       \input{fig-full.tex}
%       % \input{fig-full-where.tex}
%       % \input{fig-full-noco.tex}
%     \end{minipage}
%   \end{center}
%   \caption{Full Semantics with Address Calculation
%     (See \refdef{def:QS} for $\QS{\aLoc}{\amode}$, $\QL{\aLoc}{\amode}$
%     and \refdef{def:DS} for $\DL{\aLoc}{\amode}$, $\DS{\aLoc}{\amode}$)
%   }
%   \label{fig:full}
% \end{figure*}    

%\section{Discussion}
\subsection{Downset Closure}
\label{sec:downset}

% We would like the semantics to be closed with respect to \emph{augments} and
% \emph{downsets}.

% Augments include more order and stronger formulae; in examples, we typically
% consider pomsets that are augment-minimal.  One intuitive reading of augment
% closure is that adding order can only cause preconditions to weaken.
% \begin{definition}
%   \label{def:augment}
%   $\aPS_2$ is an \emph{augment} of $\aPS_1$ if
%   \begin{enumerate}
%   \item $\aEvs_2=\aEvs_1$,
%   \item $\labelingAct_2(\aEv)=\labelingAct_1(\aEv)$,
%   \item $\labelingForm_2(\aEv) \rimplies \labelingForm_1(\aEv)$,
%   \item $\aTr[2]{\bEvs}{\aEv} \rimplies \aTr[1]{\bEvs}{\aEv}$,
%   \item if $\bEv\le_2\aEv$ then $\bEv\le_1\aEv$.
%   \end{enumerate}
% \end{definition}

% \begin{proposition}
%   %   Suppose $\aPS_1\in\sem{\aCmd}$.
%   If $\aPS_1\in\sem{\aCmd}$ and $\aPS_2$  augments $\aPS_1$ then $\aPS_2\in\sem{\aCmd}$.
%   % \item If $\aPS_2$ is a downset of $\aPS_1$ then $\aPS_2\in\sem{\aCmd}$.
%   % \end{enumerate}
% \end{proposition}

We would like the semantics to be closed with respect to \emph{downsets}.
Downsets include a subset of initial events, similar to \emph{prefixes} for
strings.
\begin{definition}
  \label{def:downset}
  $\aPS_2$ is an \emph{downset} of $\aPS_1$ if
  \begin{multicols}{2}
    \begin{enumerate}
    \item $\aEvs_2\subseteq\aEvs_1$,
    \item $(\forall \aEv\in\aEvs_2)$ $\labelingAct_2(\aEv)=\labelingAct_1(\aEv)$,
    \item $(\forall \aEv\in\aEvs_2)$ $\labelingForm_2(\aEv)\riff\labelingForm_1(\aEv)$,
    \item $(\forall \aEv\in\aEvs_2)$ $\aTr[2]{\bEvs}{\aEv}\riff\aTr[1]{\bEvs}{\aEv}$,
    \item $\aTerm[2] \rimplies \aTerm[1]$,
      \stepcounter{enumi}
    \item[] 
      \begin{enumerate}[leftmargin=0pt]
      \item $(\forall \bEv\in\aEvs_2)$ $(\forall \aEv\in\aEvs_2)$ $\bEv\le_2\aEv$ iff $\bEv\le_1\aEv$,
      \item $(\forall \bEv\in\aEvs_1)$ $(\forall \aEv\in\aEvs_2)$ if
        $\bEv\le_1\aEv$ then $\bEv\in\aEvs_2$,
      \end{enumerate}
    \item $(\forall \bEv\in\aEvs_2)$ $(\forall \aEv\in\aEvs_2)$ $\bEv\rrfx_2\aEv$ iff $\bEv\rrfx_1\aEv$.
    \end{enumerate}
  \end{multicols}
\end{definition}

Downset closure fails due to for two reasons.  The key property is that the
empty set transformer should behave the same as the independent transformer.

First, downset closure fails for read-read independency \textsection\ref{sec:read-read}.
  % For \xRRD{}, \refdef{def:pomsets-rr} states:
  % \begin{enumerate}
  % \item[\ref{L4})]
  %   $\aTr{\bEvs}{\bForm} \rimplies \aVal{=}\aReg\limplies\bForm$, 
  % \item[\ref{L5})]
  %   $\aTr{\cEvs}{\bForm} \rimplies (\aVal{=}\aReg\lor\RW)\limplies\bForm$,
  % \item[\ref{L6})] 
  %   $\aTr{\dEvs}{\bForm} \rimplies \bForm$, when $\aEvs=\emptyset$.
  % \end{enumerate}
  % This semantics is not downset closed due to the lack of read-read dependencies.
  % In both cases, for subsequent writes, \ref{L5} is the same as \ref{L6}.  For
  % subsequent reads, \ref{L5} is the same as \ref{L4}.
Consider
\begin{gather*}
  \begin{gathered}[t]
    \PR{x}{r}\SEMI\IF{\BANG r}\THEN\PR{y}{s}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a}{\DR{x}{0}}{}
        \event{b}{\DR{y}{0}}{right=of a}
      \end{tikzinline}}
  \end{gathered}    
\end{gather*}
The semantics of this program includes the singleton pomset $\DRP{x}{0}$,
but not the singleton pomset $\DRP{y}{0}$.
To get $\DRP{x}{0}$, we combine:
\begin{align*}
  \begin{gathered}[t]
    \PR{x}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a}{\DR{x}{0}}{}
      \end{tikzinline}}
  \end{gathered}    
  &&
  \begin{gathered}[t]
    \IF{\BANG r}\THEN\PR{y}{s}\FI
    \\
    \emptyset
  \end{gathered}    
\end{align*}
Attempting to get $\DRP{y}{0}$, we instead get:
\begin{align*}
  \begin{gathered}[t]
    \PR{x}{r}
    \\
    \emptyset
  \end{gathered}    
  &&
  \begin{gathered}[t]
    \IF{\BANG r}\THEN\PR{y}{s}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{b}{r\EQ0\mid\DR{y}{0}}{}
      \end{tikzinline}}
  \end{gathered}    
\end{align*}
Since $r$ appears only once in the program, this pomset cannot contribute
to a top-level pomset.


Second, the semantics is not downset closed because the independency reasoning of
\ref{read-tau-ind} is only applicable for pomsets where the ignored read is present!
Revisiting \jmm{} causality test case 1 from the end of \textsection\ref{sec:ex:control}:
\begin{align*}
  \begin{gathered}[t]
    \PW{x}{0} 
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a0}{\DW{x}{0}}{}
        \xform{xi}{\bForm[0/x]}{below=of a0}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \PR{x}{r} 
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a1}{\DR{x}{1}}{}
        \xform{xi}{(1{=}r\lor x{=}r)\limplies\bForm}{below=of a1}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \IF{r{\geq}0}\THEN \PW{y}{1} \FI
    \SEMI
    \PW{z}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a2}{r{\geq}0\mid\DW{y}{1}}{}      
        \event{a3}{r{=}1\mid\DW{z}{1}}{right=of a2}      
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
% Composing:
\begin{align*}
  \begin{gathered}[t]
    \PW{x}{0} 
    \SEMI\PR{x}{r} 
    \SEMI\IF{r{\geq}0}\THEN \PW{y}{1} \FI
    \SEMI
    \PW{z}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a0}{\DW{x}{0}}{}
        \event{a1}{\DR{x}{1}}{right=of a0}
        \event{a2}{(1{=}r\lor 0{=}r)\limplies r{\geq}0\mid\DW{y}{1}}{right=of a1}      
        \event{a3}{1{=}r\limplies r{=}1\mid\DW{z}{1}}{right=of a2}
        \po[out=-15,in=-165]{a1}{a3}
        \wki{a0}{a1}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
The precondition of $\DWP{y}{1}$ is a tautology.

Taking the empty set for the read, however,
the precondition of $\DWP{y}{1}$ is not a tautology:
\begin{align*}
  \begin{gathered}[t]
    \PW{x}{0} 
    \SEMI\PR{x}{r} 
    \SEMI\IF{r{\geq}0}\THEN \PW{y}{1} \FI
    \SEMI
    \PW{z}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a0}{\DW{x}{0}}{}
        % \event{a1}{\DR{x}{1}}{right=of a0}
        \event{a2}{r{\geq}0\mid\DW{y}{1}}{right=6em of a0}      
        \event{a3}{r{=}1\mid\DW{z}{1}}{right=of a2}
        % \wk{a0}{a1}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
One way to deal with the second issue would be to allow general access
elimination to merge $\DWP{x}{0}$ and $\DRP{x}{0}$:
\begin{align*}
  \begin{gathered}[t]
    \PW{x}{0} 
    \SEMI\PR{x}{r} 
    \SEMI\IF{r{\geq}0}\THEN \PW{y}{1} \FI
    \SEMI
    \PW{z}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a0}{\DW{x}{0}}{}
        %\event{a1}{\DR{x}{1}}{right=of a0}
        \event{a2}{(0{=}r\lor 0{=}r)\limplies r{\geq}0\mid\DW{y}{1}}{right=6em of a0}      
        \event{a3}{r{=}1\mid\DW{z}{1}}{right=of a2}
        %\po[out=-15,in=-165]{a1}{a3}
        %\wki{a0}{a1}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
We leave the elaboration of this idea to future work.

\begin{comment}
  if in L6 we said [x/r], that says we know read the local version...  ignoring
  the value read...  Perhaps there is some intervening stuff that stops you
  from seeing the local state, such as release-acquire

  We could potentially get rid of [x/r] If you do two reads, your not allowed
  to be independent of the second based on the value that was read in the first
  read.

  x=0; r=x; if (r=1) { s=x; if (s=?) {y=1}}
  read 1 then 2.


  In order for the write to be independent of second read what does its
  precondition have to be.
  [r/x] then s==1
  no sub then s==0

  (s=? | Wy1)

  if (phi) z=1
  phi = s is even
  phi = s < 2

  With substitution you are saying you know that the ``local copy'' of x is the
  same as r.  Sitting in the local cache.  Read might have gone to main
  memory, but if it did it has updated the cache line so that the local copy is
  what I just read.

  If second read is a cache hit, then I know that I am seeing the same value.

  If we take substitution out then 
\end{comment}

\subsection{Logical Encoding of Delay for \PwTmcaTITLE{}}
\label{sec:delay}

\PwTmca{} satisfies one direction of
\reflem{lem:if}\eqref{lem:ifelse:if:if1}--\eqref{lem:ifelse:if:if2}
\begin{enumerate}
\item[\eqref{lem:ifelse:if:if1}]
  \begin{math} 
    \xIFTHEN{\aForm}{\aPSS_1}{\aPSS_2}
    \supseteq
    \xSEMI{
      \xIFTHEN{\aForm}{\aPSS_1}{}
    }{
      \xIFTHEN{\lnot\aForm}{\aPSS_2}{}
    }.
  \end{math}
  
\item[\eqref{lem:ifelse:if:if2}]
  \begin{math} 
    \xIFTHEN{\aForm}{\aPSS_1}{\aPSS_2}
    \supseteq
    \xSEMI{
      \xIFTHEN{\lnot\aForm}{\aPSS_2}{}
    }{
      \xIFTHEN{\aForm}{\aPSS_1}{}
    }.
  \end{math}
\end{enumerate}
In order to validate the reverse inclusions, we could require that
\ref{seq-le-delays} not impose order when
$\labelingForm_1(\bEv) \land \labelingForm_2(\aEv)$ is unsatisfiable.
Thus, following on \textsection\ref{sec:false}, we would also like this:
\begin{enumerate}
\item[{\labeltext[\textsc{s}6b$'$]{(\textsc{s}6b$'$)}{seq-le-delays'}}] if
  $\labeling_1(\bEv) \rdelays \labeling_2(\aEv)$ and
  $\labelingForm_1(\bEv) \land \labelingForm_2'(\aEv)$ is
  $\labeling$-consistent then $\bEv\le\aEv$.
\end{enumerate}

However, \eqref{seq-le-delays'} fails associativity.
Example where $\cForm_\labeling=(r{=}0)$
\begin{align*}
  \begin{gathered}    
    \PR{y}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DR{y}{0}}{}
      \end{tikzinline}}
  \end{gathered}  
  &&
  \begin{gathered}    
    \IF{r\OR s}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{b}{r{\neq}0\lor s{\neq}0\mid\DW{x}{1}}{}
      \end{tikzinline}}
  \end{gathered}    
  &&
  \begin{gathered}    
    \IF{\BANG s}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{c}{s{=}0\mid\DW{x}{2}}{}
      \end{tikzinline}}
  \end{gathered}    
\end{align*}
Associating right, order is required since
$((r{\neq}0 \lor s{\neq}0)\land s{=}0)$ is satisfiable (take $r{=}1$ and $s{=}0$):
\begin{align*}
  \begin{gathered}    
    \PR{y}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DR{y}{0}}{}
      \end{tikzinline}}
  \end{gathered}    
  &&
  \begin{gathered}    
    \IF{r\OR s}\THEN\PW{x}{1}\FI
    \SEMI
    \IF{\BANG s}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{b}{r{\neq}0\lor s{\neq}0\mid\DW{x}{1}}{}
        \event{c}{s{=}0\mid\DW{x}{2}}{right=of b}
        \wki{b}{c}
      \end{tikzinline}}
  \end{gathered}    
\end{align*}
\begin{align*}
  \begin{gathered}    
    \PR{y}{r}
    \SEMI
    \IF{r\OR s}\THEN\PW{x}{1}\FI
    \SEMI
    \IF{\BANG s}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DR{y}{0}}{}
        \event{b}{r{=}0\limplies (r{\neq}0\lor s{\neq}0)\mid\DW{x}{1}}{right=of a}
        \event{c}{s{=}0\mid\DW{x}{2}}{right=of b}
        \po{a}{b}
        \wki{b}{c}
      \end{tikzinline}}
  \end{gathered}    
\end{align*}
Associating left, order is not required between the writes since
$(s{\neq}0\land s{=}0)$ is unsatisfiable:
\begin{align*}
  \begin{gathered}    
    \PR{y}{r}
    \SEMI
    \IF{r\OR s}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DR{y}{0}}{}
        \event{b}{r{=}0\limplies (r{\neq}0\lor s{\neq}0)\mid\DW{x}{1}}{right=of a}
        \po{a}{b}
      \end{tikzinline}}
  \end{gathered}    
  &&
  \begin{gathered}    
    \IF{\BANG s}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{c}{s{=}0\mid\DW{x}{2}}{}
      \end{tikzinline}}
  \end{gathered}    
\end{align*}
\begin{align*}
  \begin{gathered}    
    \PR{y}{r}
    \SEMI
    \IF{r\OR s}\THEN\PW{x}{1}\FI
    \SEMI
    \IF{\BANG s}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DR{y}{0}}{}
        \event{b}{r{=}0\limplies (r{\neq}0\lor s{\neq}0)\mid\DW{x}{1}}{right=of a}
        \event{c}{s{=}0\mid\DW{x}{2}}{right=of b}
        \po{a}{b}
      \end{tikzinline}}
  \end{gathered}    
\end{align*}

This motivates the logic-based presentation of $\rdelay$.

In the data model, we require additional symbols: $\Q{\mSC}$, $\Qr{\aLoc}$,
and $\Qw{\aLoc}$.  We refer to these collectively as \emph{quiescence
  symbols}.

We update the \refdef{def:pomset} of complete pomset to substitute true for every
quiescence symbol:
\begin{definition}
  A \PwT{} is \emph{complete} if
  \begin{multicols}{2}
    \begin{enumerate}[,label=(\textsc{c}\arabic*),ref=\textsc{c}\arabic*]
      \setcounter{enumi}{\value{Bkappa}}
    \item \label{top-kappa-q}
      $\labelingForm(\aEv)[\TRUE/\Q{}]$ is a tautology,
      \setcounter{enumi}{\value{Bterm}}
    \item \label{top-term-q} $\aTerm{}[\TRUE/\Q{}]$ is a tautology.
    \end{enumerate}
  \end{multicols}
\end{definition}

We define some helper notation:
\begin{definition}
  \label{def:QS}
  Let $\Qr{*}=\textstyle\bigwedge_\bLoc \Qr{\bLoc}$, and similarly for $\Qw{*}$.\\
  Let formulae $\QS{\aLoc}{\amode}$, $\QL{\aLoc}{\amode}$, and $\QF{}{\amode}$ be defined:
  \begin{scope}
    \small
    \begin{align*}
      \QS{\aLoc}{\mRLX}&=\Qr{\aLoc}\land\Qw{\aLoc}
      &\QL{\aLoc}{\mRLX}&=\Qw{\aLoc}
      &\QF{}{\fREL}&=\Qr{*}\land\Qw{*} 
      \\
      \QS{\aLoc}{\mREL}&= \Qr{*}\land\Qw{*} 
      &\QL{\aLoc}{\mACQ}&=\Qw{\aLoc}
      &\QF{}{\fACQ} &=\Qr{*}
      \\
      \QS{\aLoc}{\mSC}&= \Qr{*}\land\Qw{*} \land \Qsc
      &\QL{\aLoc}{\mSC}&=\Qw{\aLoc}\land\Qsc      
      &\QF{}{\fSC} &= \Qr{*}\land\Qw{*} \land\Qsc
    \end{align*}
  \end{scope}
  % \end{definition}
% \begin{definition}
  Let $[\aForm/\Qr{*}]$ substitute $\aForm$ for every $\Qr{\bLoc}$, and similarly for $\Qw{*}$.\\
  Let substitutions $[\aForm/\QS{\aLoc}{\amode}]$, $[\aForm/\QL{\aLoc}{\amode}]$, and  $[\aForm/\QF{}{\amode}]$ be defined:
  \begin{scope}
    \small
    \begin{align*}
      [\aForm/\QS{\aLoc}{\mRLX}] &= [\aForm/\Qw{\aLoc}]
      &{} [\aForm/\QL{\aLoc}{\mRLX}] &= [\aForm/\Qr{\aLoc}]
      &{} [\aForm/\QF{}{\fREL}] &= [\aForm/\Qw{*}]
      \\
      [\aForm/\QS{\aLoc}{\mREL}] &= [\aForm/\Qw{\aLoc}]
      &{} [\aForm/\QL{\aLoc}{\mACQ}] &= [\aForm/\Qr{*},\aForm/\Qw{*}]
      &{} [\aForm/\QF{}{\fACQ}] &= [\aForm/\Qr{*},\aForm/\Qw{*}]
      \\
      [\aForm/\QS{\aLoc}{\mSC}] &= [\aForm/\Qw{\aLoc},\aForm/\Qsc]
      &{} [\aForm/\QL{\aLoc}{\mSC}] &= [\aForm/\Qr{*},\aForm/\Qw{*},\aForm/\Qsc]
      &{} [\aForm/\QF{}{\fSC}] &= [\aForm/\Qr{*},\aForm/\Qw{*},\aForm/\Qsc]
    \end{align*}
  \end{scope}
\end{definition}
Update the following rules from \reffig{fig:seq}.
(The change is similar for address calculation and if-closure.)
\begin{enumerate}[topsep=0pt,label=(\textsc{w}\arabic*),ref=\textsc{w}\arabic*]
  \setcounter{enumi}{\value{Bkappa}}
\item \label{write-kappa-q}
  \begin{math}
    \labelingForm(\aEv) \riff
    \aExp{=}\aVal
    \land
    \QS{\aLoc}{\amode}
  \end{math},    
  \stepcounter{enumi}      
\item[] \labeltext[\textsc{w}5]{}{write-tau-q}
  \begin{enumerate}[leftmargin=0pt]
  \item \label{write-tau-nonempty-q}
    if $\aEvs\neq\emptyset$ then 
    \makebox[0cm][l]{%
      \begin{math}
        \aTr{\bEvs}{\bForm} \riff 
        \bForm
        [\aExp/\aLoc][\aExp{=}\aVal/\QS{\aLoc}{\amode}],
      \end{math}}
  \item \label{write-tau-empty-q}
    if $\aEvs=\emptyset$ then 
    \begin{math}
      \aTr{\bEvs}{\bForm} \riff 
      \bForm
      [\aExp/\aLoc][\FALSE/\QS{\aLoc}{\amode}],
    \end{math}
  \end{enumerate}
\end{enumerate}
\begin{enumerate}[topsep=0pt,label=(\textsc{r}\arabic*),ref=\textsc{r}\arabic*]
  \setcounter{enumi}{\value{Bkappa}}
\item \label{read-kappa-q}
  \begin{math}
    \labelingForm(\aEv) \riff \QL{\aLoc}{\amode},
  \end{math}
  \stepcounter{enumi}
\item[] \labeltext[\textsc{r}4]{}{read-tau-q}
  \begin{enumerate}[leftmargin=0pt]
  \item \label{read-tau-dep-q}
    if $\aEvs\neq\emptyset$ and $(\aEvs\cap\bEvs)\neq\emptyset$ then
    \makebox[0pt][l]{\begin{math}
        \aTr{\bEvs}{\bForm} \riff
        \aVal{=}\aReg
        \limplies \bForm,
      \end{math}}
  \item \label{read-tau-ind-q}
    if $\aEvs\neq\emptyset$ and $(\aEvs\cap\bEvs)=\emptyset$ then
    \makebox[0pt][l]{\begin{math}
        \aTr{\bEvs}{\bForm} \riff
        \PBR{\aVal{=}\aReg \lor \aLoc{=}\aReg}
        \limplies \bForm [\FALSE/\QL{\aLoc}{\amode}],
      \end{math}}
  \item \label{read-tau-empty-q}
    if $\aEvs=\emptyset$ then
    \begin{math}
      \aTr{\bEvs}{\bForm} \riff
      \bForm [\FALSE/\QL{\aLoc}{\amode}],
    \end{math}
  \end{enumerate}
\end{enumerate}    
\begin{enumerate}[topsep=0pt,label=(\textsc{f}\arabic*),ref=\textsc{f}\arabic*]
  \setcounter{enumi}{\value{Bkappa}}
\item \label{fence-kappa-q}
  $\labelingForm(\aEv) \riff \QF{\aLoc}{\amode}$,
  \stepcounter{enumi}
\item[] \labeltext[\textsc{f}4]{}{fence-tau-q}
  \begin{enumerate}[leftmargin=0pt]
  \item \label{fence-tau-dep-q}
    if $\aEvs\neq\emptyset$ then
    \begin{math}
      \aTr{\bEvs}{\bForm} \riff
      \bForm,
    \end{math}
  \item \label{fence-tau-ind-q}
    if $\aEvs=\emptyset$ then
    \begin{math}
      \aTr{\bEvs}{\bForm} \riff
      \bForm [\FALSE/\QF{\aLoc}{\amode}].
    \end{math}
  \end{enumerate}
\end{enumerate}
  
The quiescence formulae indicate what must precede an event.
For example, all preceding accesses must be ordered before a releasing write,
whereas only writes on $x$ must be ordered before a releasing read on $x$.

The quiescence substitutions update quiescence symbols in subsequent code.
For subsequent independent code, $\ref{write-kappa-q}$ and $\ref{read-kappa-q}$ substitute false.
In complete pomsets, we substitute true for .
%
For example, we substitute $\FALSE$ for $\QS{\aLoc}{\mREL}$ in the independent
case for a releasing write; this ensures that subsequent writes to $\aLoc$
follow the releasing write in top-level pomsets.  Similarly, we substitute
$\FALSE$ for $\QL{\aLoc}{\mACQ}$ in the independent case for an acquiring
write; this ensures that all subsequent accesses follow the acquiring read in
top-level pomsets.

\todo{Fix these examples}
\begin{example}
  \label{ex:q1}
  The following pomsets show the effect of quiescence for each access mode.
  \input{fig-q1.tex}
\end{example}

\begin{example}
  The definition enforces publication.  Consider:
  \begin{align*}
    \begin{gathered}
      \PW{x}{1}
      \\
      \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
          \event{a1}{1{=}1\land\QS{\aLoc}{\mRLX}\mid\DW{x}{1}}{}
          \xform{x1d}{1{=}1\land\bForm}{below=of a1}
          \xform{x1i}{\bForm[\FALSE/\QS{\aLoc}{\mRLX}]}{below=of x1d}
          \xos{a1}{x1d}
        \end{tikzinline}}
    \end{gathered}
    &&
    \begin{gathered}
      \PW[\mREL]{y}{1}
      \\
      \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
          \raevent{a2}{1{=}1\land\QS{\bLoc}{\mREL}\mid\DW{y}{2}}{}
          \xform{x2d}{1{=}1\land\bForm}{below=of a2}
          \xform{x2i}{\bForm[\FALSE/\QS{\bLoc}{\mREL}]}{below=of x2d}
          \xos{a2}{x2d}
        \end{tikzinline}}
    \end{gathered}
  \end{align*}
  Since $\QS{\bLoc}{\mREL}[\FALSE/\QS{\aLoc}{\mRLX}]$ is $\FALSE$,
  composing these without order simplifies to:
  \begin{gather*}
    \PW{x}{1}\SEMI \PW[\mREL]{y}{1}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
          \event{a1}{\QS{\aLoc}{\mRLX}\mid\DW{x}{1}}{}
          \xform{x1d}{\bForm}{below right=of a1}
          \xform{x2i}{\bForm[\FALSE/\QS{\bLoc}{\mREL}]}{below=of a1}
          \xo{a1}{x1d}
          \raevent{a2}{\FALSE\mid\DW{\bLoc}{1}}{above right=of x1d}
          %\xform{x2d}{\bForm}{below left=of a2}
          \xform{x1i}{\bForm[\FALSE/\QS{\aLoc}{\mRLX}]}{below=of a2}
          \xform{xii}{\bForm[\FALSE/\QS{\bLoc}{\mREL}][\FALSE/\QS{\aLoc}{\mRLX}]}{below right=of a2}
          \xo{a2}{x1d}
          \xos[xleft]{a1}{x2i}
          \xos{a2}{x1i}
        \end{tikzinline}}
  \end{gather*}
  In order to get a satisfiable precondition for $\DWP{y}{1}$, we must
  introduce order:
  \begin{gather*}
    % \PW{x}{1}\SEMI \PW[\mREL]{y}{1}
    % \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
          \event{a1}{\QS{\aLoc}{\mRLX}\mid\DW{x}{1}}{}
          \xform{x1d}{\bForm}{below right=of a1}
          \xform{x2i}{\bForm[\FALSE/\QS{\bLoc}{\mREL}]}{below=of a1}
          \xo{a1}{x1d}
          \raevent{a2}{\QS{\bLoc}{\mREL}\mid\DW{\bLoc}{1}}{above right=of x1d}
          %\xform{x2d}{\bForm}{below left=of a2}
          \xform{x1i}{\bForm[\FALSE/\QS{\aLoc}{\mRLX}]}{below=of a2}
          \xform{xii}{\bForm[\FALSE/\QS{\bLoc}{\mREL}][\FALSE/\QS{\aLoc}{\mRLX}]}{below right=of a2}
          \xo{a2}{x1d}
          \xos[xleft]{a1}{x2i}
          \xos{a2}{x1i}
          \sync{a1}{a2}
        \end{tikzinline}}
  \end{gather*}
\end{example}

\begin{example}
  \label{ex:subscription}
  The definition enforces subscription.  Consider:
  \begin{align*}
    \begin{gathered}
      \PR[\mACQ]{y}{r}
      \\
      \hbox{\begin{tikzinline}[node distance=.5em and .5em]
          \raevent{a1}{\QL{\bLoc}{\mACQ}\mid\DR{y}{1}}{}
          \xform{x1d}{r{=}1\limplies\bForm}{below=of a1}
          \xform{x1i}{\bForm[\FALSE/\QL{\bLoc}{\mACQ}]}{right=of x1d}
          \xos[xleft]{a1}{x1d}
        \end{tikzinline}}
    \end{gathered}
    &&
    \begin{gathered}
      \PR{x}{s}
      \\
      \hbox{\begin{tikzinline}[node distance=.5em and .5em]
          \event{a2}{\QL{\aLoc}{\mRLX}\mid\DR{x}{1}}{}
          \xform{x2d}{s{=}1\limplies\bForm}{below=of a2}
          \xform{x2i}{\bForm[\FALSE/\QL{\aLoc}{\mRLX}]}{right=of x2d}
          \xos[xleft]{a2}{x2d}
        \end{tikzinline}}
    \end{gathered}
  \end{align*}
  Since $\QL{\aLoc}{\mRLX}[\FALSE/\QL{\bLoc}{\mACQ}]$ is $\FALSE$,
  composing these without order simplifies to:
  \begin{gather*}
    \PR[\mACQ]{y}{r}\SEMI \PR{x}{s}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
          \raevent{a1}{\QL{\bLoc}{\mACQ}\mid\DR{y}{1}}{}
          \xform{x1d}{r{=}1\limplies\bForm[\FALSE/\QL{\aLoc}{\mRLX}]}{below=of a1}
          \xform{xdd}{r{=}1\limplies s{=}1\limplies\bForm}{right=of x1d}
          \xform{xii}{\bForm[\FALSE/\QL{\bLoc}{\mACQ}][\FALSE/\QL{\aLoc}{\mRLX}]}{above=of xdd}
          \xform{x2d}{s{=}1\limplies\bForm[\FALSE/\QL{\bLoc}{\mACQ}]}{right=of xdd}
          \event{a2}{\FALSE\mid\DR{x}{1}}{above=of x2d}
          \xos[xleft]{a1}{x1d}
          \xos{a2}{x2d}
          \xo{a1}{xdd}
          \xo{a2}{xdd}
        \end{tikzinline}}
  \end{gather*}
  In order to get a satisfiable precondition for $\DRP{x}{1}$, we must
  introduce order:
  \begin{gather*}
    % \PR[\mACQ]{y}{r}\SEMI \PR{x}{s}
    % \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
          \raevent{a1}{\QL{\bLoc}{\mACQ}\mid\DR{y}{1}}{}
          \xform{x1d}{r{=}1\limplies\bForm[\FALSE/\QL{\aLoc}{\mRLX}]}{below=of a1}
          \xform{xdd}{r{=}1\limplies s{=}1\limplies\bForm}{right=of x1d}
          \xform{xii}{\bForm[\FALSE/\QL{\bLoc}{\mACQ}][\FALSE/\QL{\aLoc}{\mRLX}]}{above=of xdd}
          \xform{x2d}{s{=}1\limplies\bForm[\FALSE/\QL{\bLoc}{\mACQ}]}{right=of xdd}
          \event{a2}{\QL{\aLoc}{\mRLX}\mid\DR{x}{1}}{above=of x2d}
          \xos[xleft]{a1}{x1d}
          \xos{a2}{x2d}
          \xo{a1}{xdd}
          \xo{a2}{xdd}
          \sync[out=15,in=165]{a1}{a2}
        \end{tikzinline}}
  \end{gather*}
\end{example}

\begin{example}
Even in its logical form, \ref{seq-le-delays'} is incompatible with the
ability to strengthen preconditions using augment closure, which is allowed
in \cite{DBLP:journals/pacmpl/JagadeesanJR20}.  Consider the following.
\begin{align*}
  \begin{gathered}[t]
    \IF{r}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a1}{r{\neq}0\mid\DW{x}{2}}{}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \PW{x}{1}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a2}{            \DW{x}{1}}{}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \PW{x}{2}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a3}{            \DW{x}{2}}{}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \IF{\BANG r}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a4}{r{=}0   \mid\DW{x}{1}}{}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
% \begin{align*}
%   \begin{gathered}[t]
%     \IF{r}\THEN\PW{x}{2}\FI
%     \SEQ
%     \PW{x}{1}
%     \SEQ
%     \PW{x}{2}
%     \SEQ
%     \IF{\BANG r}\THEN\PW{x}{1}\FI
%     \\
%     \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
%         \event{a1}{r{\neq}0\mid\DW{x}{2}}{}
%         \event{a2}{            \DW{x}{1}}{right=of a1}
%         \event{a3}{            \DW{x}{2}}{right=of a2}
%         \event{a4}{r{=}0   \mid\DW{x}{1}}{right=of a3}
%       \end{tikzinline}}    
%   \end{gathered}
% \end{align*}
Augmenting the middle preconditions and then using sequential composition, we have:
\begin{align*}
  \begin{gathered}[t]
    \IF{r}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a1}{r{\neq}0\mid\DW{x}{2}}{}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \PW{x}{1}
    \SEQ
    \PW{x}{2}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a2}{r{\neq}0\mid\DW{x}{1}}{}
        \event{a3}{r{=}0   \mid\DW{x}{2}}{right=of a1}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \IF{\BANG r}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a4}{r{=}0   \mid\DW{x}{1}}{}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
Note that \ref{seq-le-delays'} does not require any order between the two
writes of the middle pomset.
% \begin{align*}
%   \begin{gathered}[t]
%     \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
%         \event{a1}{r{\neq}0\mid\DW{x}{2}}{}
%         \event{a2}{r{=}0   \mid\DW{x}{1}}{right=of a1}
%         \event{a3}{r{\neq}0\mid\DW{x}{2}}{right=of a2}
%         \event{a4}{r{=}0   \mid\DW{x}{1}}{right=of a3}
%       \end{tikzinline}}    
%   \end{gathered}
% \end{align*}
Merging left and right, we have:
\begin{align*}
  \begin{gathered}[t]
    \IF{r}\THEN\PW{x}{2}\FI
    \SEQ
    \PW{x}{1}
    \SEQ
    \PW{x}{2}
    \SEQ
    \IF{\BANG r}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a1}{\DW{x}{2}}{}
        \event{a4}{\DW{x}{1}}{right=of a1}
        \wki{a1}{a4}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
As shown by the following single-threaded code, allowing this outcome would violate \drfsc{}.
\begin{align*}
  \begin{gathered}[t]
    \PW{y}{1}
    \SEQ
    \PR{y}{r}
    \SEQ
    \IF{r}\THEN\PW{x}{2}\FI
    \SEQ
    \PW{x}{1}
    \SEQ
    \PW{x}{2}
    \SEQ
    \IF{\BANG r}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a1}{\DW{x}{2}}{}
        \event{a4}{\DW{x}{1}}{right=of a1}
        \wki{a1}{a4}
        \event{b2}{\DR{y}{1}}{left=of a1}
        \event{b1}{\DW{y}{1}}{left=of b2}
        \rf{b1}{b2}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}

It is for this reason that we use \emph{weakest} preconditions, rather than
preconditions.
% Note that as a result, we fail to validate the following
% refinement:
% \begin{math}
%   \aPSS_1
%   \not\supseteq
%   \xIFTHEN{\aForm}{\aPSS_1}{}.
% \end{math}
\end{example}





% \subsection{Post-Hoc Verification of Fulfillment for \PwTmcaTITLE{2}}
% \label{sec:post-hoc}

