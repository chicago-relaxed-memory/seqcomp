\begin{comment}
Dead Store Elimination (Still) Considered Harmful

DSE "removes stores that have no effect on the program result, either
because the stored value is overwritten or because it is never read again."

The example they give is of the second type: "because it is never read
again".  To validate this, we would need a more complex model of memory
using provenance for pointers...

Section 3.3.3 (Volatile Function Pointer) has a lovely example of
if-introduction: Compilers are not allowed to get rid of calls through
virtual functions, but they can use if-introduction and then get rid of the
static call that they introduce on one side of the if/else...

Possibly interesting references:

[28] N. Benton. Simple relational correctness proofs for static analyses and program transformations. In ACM SIGPLAN Notices, volume 39, pages 14–25, 2004.
[29] C. Deng and K. S. Namjoshi. Securing a compiler transformation. In Proceedings of the 23rd Static Analysis Symposium, SAS ’16, pages 170– 188, 2016.
[30] V. D’Silva, M. Payer, and D. Song. The correctness-security gap in compiler optimization. In Security and Privacy Workshops, SPW ’15, pages 73–87, 2015.
[31] X. Leroy. Formal certification of a compiler backend or: programming a compiler with a proof assistant. In ACM SIGPLAN Notices, volume 41, pages 42–54, 2006.
\end{comment}

% \subsection{Post-Hoc Verification of Fulfillment for \PwTmcaTITLE{2}}
% \label{sec:post-hoc}

\subsection{Register Consistency}
\label{sec:false}

% \todo{Drop \ref{pom-kappa-sat} and m5b---they are wrong.  Move this into a
%   discussion of the proof of compilation correctness.}

% If a precondition is false, you can be pretty sure it's useless.  In this
% subsection, we develop a criterion for eliminating such useless pomsets.

% To achieve this, we would like to bolt a requirement into the definition of
% pomsets in order to weed out the useless ones.  Something like this:
% \begin{enumerate}
% \item[{\labeltext[\textsc{m}3a$'$]{(\textsc{m}3a$'$)}{pom-kappa-sat'}}]
%   $\labelingForm(\aEv)$ is satisfiable.
% \end{enumerate}
% For associativity, \eqref{pom-kappa-sat'} would in turn require

In addition to the three criteria of \refdef{def:trans}
\citet{DBLP:journals/cacm/Dijkstra75} requires
\begin{enumerate}
\item[{\labeltext[\textsc{x}4$'$]{(\textsc{x}4$'$)}{tr-false'}}]
  $\aTr{}{\FALSE}\riff\FALSE$.
\end{enumerate}
% \citet{DBLP:journals/cacm/Dijkstra75} requires exactly \ref{tr-false'}.
% Problem solved!  
Unfortunately, our transformer for read actions
\eqref{read-tau-dep} does not obey \ref{tr-false'}, since $\FALSE$ is not
equivalent to $v{=}r\limplies\FALSE$.

In this subsection, we refine this requirement to one that does hold.  The
main insight is to pull values for registers from the actions of pomset itself.
%
% \eqref{tr-false'} is too strong.
% We say $\aForm$ \emph{conjunctively depends on $\uReg{\aEv}$}
% if $\aForm\rnotimplies\aForm[\aVal/\uReg{\aEv}]$
% %or $\aForm[\aVal/\uReg{\aEv}]\rnotimplies\aForm$,
% for some $\aVal$.
% We say that $\aForm$ \emph{cannot contribute to a top-level tautology} if
% $\aForm\riff\bigvee_{\aEv\in\aEvs}\aForm_\aEv$ where (for every $\aEv$) either
% $\aForm_\aEv\riff\FALSE$ or $\aForm_\aEv$ conjunctively depends on $\uReg{\aEv}$.
%
% We require the following:
% \begin{enumerate}
% \item[{\labeltext[\textsc{x}4]{(\textsc{x}4)}{tr-false}}]
%   $\aTr{}{\FALSE}$ cannot contribute to a top-level tautology.
% \end{enumerate}
%
% When put in \DNF, $\aTr{}{\FALSE}$ look like this (taking independent case
% for both reads):
% \begin{gather*}
%   \IF{r}\THEN \PR{x}{s_d} \ELSE \PR{y}{s_e} \FI
%   \\
%   (r{\neq}0 \land s_d{\neq}v_d \land s_d{\neq}x)
%   \lor  
%   (r{=}0 \land s_e{\neq}v_e \land s_e{\neq}y)  
% \end{gather*}
%
Thus, we define $\regForm{\labeling}$ to capture the \emph{register state} of a pomset.
\begin{definition}  
  \label{def:labeling:consistent}
  Let 
  \begin{math}
    \regForm{\labeling}=
    \textstyle\bigwedge_{\{(\aEv,\aVal)\in(\aEvs\times\Val)\mid\labeling(\aEv)=\DRP{}{\aVal}\}}(\uReg{\aEv}\EQ\aVal)
    \textwhere \aEvs=\fdom(\labeling)
  \end{math}.
  
  We say that $\aForm$ is \emph{$\labeling$-consistent} if $\aForm\land\regForm{\labeling}$ is satisfiable.
  We say that it is \emph{$\labeling$-inconsistent} otherwise.
\end{definition}


%tau maps (things incompatible with chi) to (things incompatible with chi)
Using this, we define the constraint on predicate transformers that we want.
We also need to update the definition of predicate transformer families to
carry the labeling.
\begin{definition}
  \label{def:trans'}
  A \emph{$\labeling$-predicate transformer} is a %monotone
  function
  $\aTr{}{}:\Formulae\fun\Formulae$ such that
  \begin{enumerate}[,label=(\textsc{x}\arabic*),ref=\textsc{x}\arabic*]
  % \item \label{tr-implies'}
  %   \labeltextXX{2}{x}{tr-and'}
  %   \labeltextXX{3}{x}{tr-or'} as in \refdef{def:trans},
  \item[\eqref{tr-and}]
    \eqref{tr-or}\;
    \eqref{tr-implies}\; as in \refdef{def:trans},
  \item[{\labeltext[\textsc{x}4]{(\textsc{x}4)}{tr-false}}] 
    % \item[\eqref{tr-false}]
    if $\bForm$ is $\labeling$-inconsistent then $\aTr{}{\bForm}$ is $\labeling$-inconsistent.
  \end{enumerate}

  \label{def:family'}
  A \emph{family of $\labeling$-predicate transformers} over consists of a
  $\labeling$-predicate transformer $\aTr{\bEvs}{}$ for each
  $\bEvs\subseteq\AllEvents$, such that if $\cEvs \cap \aEvs \subseteq \bEvs$
  then $\aTr{\cEvs}{\bForm} \rimplies \aTr{\bEvs}{\bForm}$.

  
  \begin{enumerate}[,label=(\textsc{m}\arabic*),ref=\textsc{m}\arabic*]
  \setcounter{enumi}{\value{Btau}}
  \item \label{pom-tau'}
    $\aTr{}{}:2^{\AllEvents}\fun\Formulae \fun\Formulae$ is a \emph{family of $\labeling$-predicate transformers}, 
  \end{enumerate}
\end{definition}

% Given these definitions, we can add the following requirement to the model,
% which enables us to prune pomsets that include $\labeling$-inconsistent
% preconditions and termination conditions.
% \begin{multicols}{2}
%   \begin{enumerate}
%     % \item[{\labeltext[\textsc{x}4]{(\textsc{x}4)}{tr-false}}] if $\bForm$ is
%     %   $\labeling$-inconsistent, then $\aTr{}{\bForm}$ is $\labeling$-inconsistent.
%   \item[{\labeltext[\textsc{m}3a]{(\textsc{m}3a)}{pom-kappa-sat}}]
%     $\labelingForm(\aEv)$ is $\labeling$-consistent,
%   \item[{\labeltext[\textsc{m}5b]{(\textsc{m}5b)}{pom-term-sat}}]
%     $\aTerm$ is $\labeling$-consistent.
%   \end{enumerate}
% \end{multicols}
% With this modification, dead-code elimination
% (\reflem{lem:if}\ref{lem:if:dead}) can be changed from an inclusion to an equation:
% \begin{displaymath}
%   \xIFTHEN{\aForm}{\aPSS_1}{\aPSS_2}
%   =
%   \aPSS_1
%   \;\text{if $\aForm$ is a tautology.}
% \end{displaymath}



\subsection{Comparison with Sequential Predicate Transformers}

We compare traditional transformers to the dependent-case transformers of
\reffig{fig:seq}. %; thus we consider only totally ordered executions.
% Because
% we only consider the dependent case, we drop the superscript $\aEvs$ on
% $\aTr{\aEvs}{}$ throughout this section.  We also assume that each register
% appears at most once in a program, as we did throughout
% \textsection\ref{sec:model}--\ref{sec:arm}.

% Because of augment closure, we are not interested in isolating the
% \emph{weakest} precondition.  Thus we think of transformers as Hoare triples.
% In addition, 
All programs in our language are strongly normalizing, so we
need not distinguish strong and weak correctness.  In this setting, the Hoare
triple $\hoare{\aForm}{\aCmd}{\bForm}$ holds exactly when
$\aForm \limplies \fwp{\aCmd}{\bForm}$.

Hoare triples do not distinguish thread-local variables from shared
variables.  Thus, the assignment rule applies to all types of storage. The
rules can be written as on the left below:
\begin{align*}
\begin{aligned}
  \fwp{\PW{\aLoc}{\aExp}}{\bForm} &= \bForm[\aExp/\aLoc]
  \\
  \fwp{\LET{\aReg}{\aExp}}{\bForm} &= \bForm[\aExp/\aReg]
  \\
  \fwp{\PR{\aLoc}{\aReg}}{\bForm} &= \aLoc{=}\aReg\limplies\bForm
\end{aligned}
&&
\begin{aligned}
  \trd{\PW{\aLoc}{\aExp}}{\bForm} &= \bForm[\aExp/\aLoc]
  \\
  \trd{\LET{\aReg}{\aExp}}{\bForm} &= \bForm[\aExp/\aReg]
  \\
  \trd{\PR{\aLoc}{\aReg}}{\bForm} &= \aVal{=}\aReg\limplies\bForm &&
  \textwhere \labelingAct(\aEv)=\DR{\aLoc}{\aVal}
\end{aligned}
\end{align*}
Here we have chosen an alternative formulation for the read rule, which is
equivalent to the more traditional $\bForm[\aLoc/\aReg]$, as long as registers
are assigned at most once in a program.  Our predicate transformers for the
dependent case are shown on the right above.  Only the read rule differs from
the traditional one.

For programs where every register is bound and every read is fulfilled, our
dependent transformers are the same as the traditional ones.  Thus, when
comparing to weakest preconditions, let us only consider totally-ordered
executions of our semantics where every read could be fulfilled by prepending
some writes.  For example, we ignore pomsets of $\PW{x}{2}\SEMI\PR{x}{r}$
that read $1$ for $x$.

For example, let $\aCmd_i$ be defined:
% as follows.
\begin{align*}
  \aCmd_1&=\PR{x}{s}\SEMI\PW{x}{s{+}r}
  &  
  \aCmd_2&=\PW{x}{t}\SEMI\aCmd_1
  &  
  \aCmd_3&=\LET{t}{2}\SEMI\LET{r}{5}\SEMI\aCmd_2
\end{align*}
% \begin{itemize}
% \item
%   \begin{math}
%     \fwp{\LET{\aReg}{\aExp}}{\bForm} = \bForm[\aExp/\aReg]
%   \end{math}
% \item
%   \begin{math}
%     \fwp{\PR{\aLoc}{\aReg}\;\,}{\bForm} = %\bForm[x/r]
%     %     (\forall\bReg)
%     %     \aLoc{=}\bReg\limplies\bForm [\bReg/\aLoc]
%     \aLoc{=}\aReg\limplies\bForm
%   \end{math}
% \item
%   \begin{math}
%     \fwp{\PW{\aLoc}{\aExp}}{\bForm} = \bForm[\aExp/\aLoc]
%   \end{math}
% \end{itemize}
% General relation between Hoare triples and $\fwp{}{}$:
% \begin{itemize}
% \item $\hoare{\fwp{\aCmd}{\bForm}}{\aCmd}{\bForm}$,
% \item If $\hoare{\aForm}{\aCmd}{\bForm}$ and $\aCmd$ terminates when starting
%   in any state satisfying $\aForm$, then $\aForm \limplies \fwp{\aCmd}{\bForm}$.
% \end{itemize}
The following pomset appears in the semantics of $\aCmd_2$.  A pomset for
$\aCmd_3$ can be derived by substituting $[2/t,\allowbreak5/r]$.  A pomset
for $\aCmd_1$ can be derived by eliminating the initial write.
\begin{gather*}
  % \begin{gathered}[t]
  %   \PW{x}{3}
  %   \\
  %   \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
  %     \event{c}{\DW{x}{3}}{}
  %     \xform{xd}{\bForm}{below=of c}
  %     \xo[xright]{c}{xd}
  %   \end{tikzinline}}
  % \end{gathered}
  % \qquad\quad
  % \begin{gathered}[t]
  %   \PR{x}{s}\SEMI\PW{x}{s{+}r}
  %   \\
  %   \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
  %     \event{a}{\DR{x}{2}}{}
  %     \event{b}{2{=}s\limplies(s{+}r){=}7\mid\DW{x}{7}}{right=of a}%6.5em of a}
  %     \po{a}{b}
  %     \xform{xdd}{2{=}s \limplies \bForm[s{+}r/x]}{below right=.5em and -1em of a}
  %       %     \xform{xdd}{2{=}s \limplies \bForm[s{+}r/x]}{above=of a}
  %       %     \xform{xdi}{2{=}s \limplies \bForm[s{+}r/x]}{below=of a}
  %       %     \xform{xii}{(2{=}s\lor x{=}s)\limplies\bForm[s{+}r/x]}{above=of b}
  %       %     \xform{xid}{(2{=}s\lor x{=}s)\limplies\bForm[s{+}r/x]}{below=of b}
  %       %     \xo[xright]{a}{xdi}
  %       %     \xo[xright]{b}{xid}
  %     \xo[xright]{a}{xdd}
  %     \xo[xright]{b}{xdd}
  %   \end{tikzinline}}
  % \end{gathered}
  % \\[1ex]
  \begin{gathered}[t]
    % \LET{t}{2}\SEMI
    % \LET{r}{5}\SEMI
    \PW{x}{t}\SEMI
    \PR{x}{s}\SEMI\PW{x}{s{+}r}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a}{\DR{x}{2}}{}
        \event{b}{2{=}s\limplies(s{+}r){=}7\mid\DW{x}{7}}{right=of a}
        \event{c}{t{=}2\mid\DW{x}{2}}{left=of a}
        \xform{xdd}{2{=}s \limplies \bForm[s{+}r/x]}{right=of b}%below right=.5em and -1em of a}
        %\xo{a}{xdd}
        \xo{b}{xdd}
        % \xo{c}{xdd}
        \po{a}{b}
        \rf{c}{a}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
The predicate transformers are:
% \begin{align*}
%   \fwp{\aCmd_1}{\bForm} &= x{=}s\limplies\bForm[s{+}r/x] 
%   \\
%   \fwp{\aCmd_2}{\bForm} &= t\,{=}s\limplies\bForm[s{+}r/x] 
%   \\
%   \fwp{\aCmd_3}{\bForm} &= 2{=}s\limplies\bForm[s{+}5/x] 
%   \\
%   \trd{\aCmd_1}{\bForm} = \trd{\aCmd_2}{\bForm} &= 2{=}s\limplies\bForm[s{+}r/x] 
%   \\
%   \trd{\aCmd_3}{\bForm} &= 2{=}s\limplies\bForm[s{+}5/x] 
% \end{align*}
\begin{scope}
  \small
  \begin{align*}
    \fwp{\aCmd_1}{\bForm} &= x{=}s\limplies\bForm[s{+}r/x] 
    &
    \trd{\aCmd_1}{\bForm} &= 2{=}s\limplies\bForm[s{+}r/x] 
    \\
    \fwp{\aCmd_2}{\bForm} &= t\,{=}s\limplies\bForm[s{+}r/x] 
    &
    \trd{\aCmd_2}{\bForm} &= 2{=}s\limplies\bForm[s{+}r/x] 
    \\
    \fwp{\aCmd_3}{\bForm} &= 2{=}s\limplies\bForm[s{+}5/x] 
    &
    \trd{\aCmd_3}{\bForm} &= 2{=}s\limplies\bForm[s{+}5/x] 
  \end{align*}
\end{scope}

% % Let $\rho:\Reg\fun\Val$ and $\chi:\Loc\fun\Val$ be substitutions.
% Let $\aState$ and $\rho$ range over substitutions $(\Reg\cup\Loc)\fun\Val$.
% Treating substitutions as states, the big-step operational semantics of
% programs can be defined as a relation $\bigstep{\aState}{\aCmd}{\bState}$.
% % Ie, $\aForm\aState$ implies $\bForm\bState$.
% \begin{align}
%   \label{wp1}
%   \bigstep{[5/r,2/x]}{\aCmd_1&}{[5/r,2/s,7/x]}
%   \\
%   \label{wp2}
%   \bigstep{[\NEG5/r,2/x]}{\aCmd_1&}{[\NEG5/r,2/s,\NEG3/x]}
% \end{align}

% Then the semantics of Hoare triples guarantees that if
% $\aForm\limplies\fwp{\aCmd}{\bForm}$, $\bigstep{\aState}{\aCmd}{\rho}$ and
% $\aForm\aState$ is a tautology then $\bForm\bState$ is a tautology.
% \begin{align*}
%   \fwp{\aCmd_1}{x{>}0} &= (x{+}r{>}0) 
% \end{align*}
% In \eqref{wp1}, the pre- and post-conditions are satisfied.
% In \eqref{wp2}, they are not.


% \begin{itemize}  
% \item Suppose $\bigstep{\aState}{\aCmd}{\rho}$ and $\aForm\limplies\fwp{\aCmd}{\bForm}$.\\
%   If $\aForm\aState$ is a tautology then $\bForm\bState$ is a tautology.\\
%   Ie, $\aForm\aState$ implies $\bForm\bState$.
% \item Suppose $\bigstep{\aState}{\aCmd}{\rho}$ and $\hoare{\aForm}{\aCmd}{\bForm}$.\\
%   If $\aForm\aState$ is a tautology then $\bForm\bState$ is a tautology.\\
%   Ie, $\aForm\aState$ implies $\bForm\bState$.
% \item Suppose $\bigstep{\aState}{\aCmd}{\rho}$ and $\aForm=\fwp{\aCmd}{\bForm}$.\\
%   $\aForm\aState$ is a tautology if and only if $\bForm\bState$ is a tautology.\\
%   Ie, $\aForm\aState$ iff $\bForm\bState$.
% % \item Weakest: If $\aForm'\aState$ is a tautology, then $\aForm$ implies $\aForm'$.
% \end{itemize}
% Weakest preconditions are \emph{sound} in that if $\aForm$ holds in the
% initial state $\aState$, then $\bForm$ holds in the final state $\bState$.
% Formally, 


\begin{comment}
  If $\aPS\in\sem{\aCmd}$ is top-level and quiescent then 
  $\aTr{\aEvs}{\bForm}$ implies $\fwp{\aCmd}{\bForm}$.

  For any substitution $\aSub=[{v_1/r_1},\ldots, {v_n/r_n}]$ there is some
  $\aPS\in\sem{\aCmd}$ %that is top-level and quiescent
  such that all preconditions in $\aPS\aSub$ are tautologies then 
  $\fwp{\aCmd}{\bForm}\aSub$
\end{comment}


% For a language where all programs are
% terminating, we have for any statement $\aCmd$:
% \begin{align*}
%   \hoare{\aForm}{\aCmd}{\bForm} 
%   \;\;\Leftrightarrow\;\;
%   \aForm \textimplies \fwp{\aCmd}{\bForm}
% \end{align*}
% Interpretation is that if $\aState\models\fwp{\aCmd}{\bForm}$ and
% $\bigstep{\aState}{\aCmd}{\rho}$
% then $\bState\models\bForm$.

% Let $\aCmd_0$ be
% \begin{math}
%   \PW{\aLoc_1}{\aVal_1}\SEMI\cdots\SEMI \PW{\aLoc_n}{\aVal_n}, 
% \end{math}
% such that $\fwp{\aCmd_0}{\aForm}$ is a tautology, and $\aLoc_i=\aLoc_j$
% implies $i=j$.

% Let $\aSub_\aPS=[{\aVal_1/\aLoc_1},\ldots, {\aVal_n/\aLoc_n}]$ be the final
% state of $\aPS$.

% Let $\aState$ and $\rho$ range over substitutions $\Loc\fun\Exp$.
% If we leave the registers free, we have:
% \begin{align}
%   \label{wp1x}
%   \bigstep{[2/x]}{\aCmd&}{[6/x]}
% \end{align}

% Using \refdef{def:pomsets-trans}:
% \begin{align*}
%   \begin{gathered}[t]
%     %     \PR{x}{s}\SEMI\PW{x}{s{+}r}
%     \PR{x}{s}
%     \\
%     \hbox{\begin{tikzinline}[node distance=.5em and 1em]
%       \event{a}{\DR{x}{2}}{}
%       \xform{xi}{\bForm}{above=of a}
%       \xform{xd}{2{=}s \limplies \bForm}{below=of a}
%       \xo[xright]{a}{xd}
%     \end{tikzinline}}
%   \end{gathered}
%   &&
%   \begin{gathered}[t]
%     \PW{x}{s{+}r}
%     \\
%     \hbox{\begin{tikzinline}[node distance=.5em and 1em]
%       \event{a}{(s{+}r){=}7\mid\DW{x}{7}}{}
%       \xform{xi}{\bForm}{above=of a}
%       \xform{xd}{\bForm}{below=of a}
%       \xo[xright]{a}{xd}
%     \end{tikzinline}}
%   \end{gathered}
% \end{align*}
% Composing
% \begin{align*}
%   \begin{gathered}[t]
%     \PR{x}{s}\SEMI\PW{x}{s{+}r}
%     \\
%     \hbox{\begin{tikzinline}[node distance=.5em and 1em]
%       \event{a}{\DR{x}{2}}{}
%       \event{b}{(s{+}r){=}7\mid\DW{x}{7}}{right=of a}
%       \xform{xdd}{2{=}s \limplies \bForm}{above=of a}
%       \xform{xdi}{2{=}s \limplies \bForm}{below=of a}
%       \xform{xii}{\bForm}{above=of b}
%       \xform{xid}{\bForm}{below=of b}
%       \xo[xright]{a}{xdi}
%       \xo[xright]{b}{xid}
%       \xo[xright]{a}{xdd}
%       \xo[xright]{b}{xdd}
%     \end{tikzinline}}
%   \end{gathered}
% \end{align*}

% Using \refdef{def:pomsets-lir}:
% \begin{align*}
%   \begin{gathered}[t]
%     %     \PR{x}{s}\SEMI\PW{x}{s{+}r}
%     \PR{x}{s}
%     \\
%     \hbox{\begin{tikzinline}[node distance=.5em and 1em]
%       \event{a}{\DR{x}{2}}{}
%       \xform{xi}{(2{=}s\lor x{=}s)\limplies \bForm}{above=of a}
%       \xform{xd}{2{=}s \limplies \bForm}{below=of a}
%       \xo[xright]{a}{xd}
%     \end{tikzinline}}
%   \end{gathered}
%   &&
%   \begin{gathered}[t]
%     \PW{x}{s{+}r}
%     \\
%     \hbox{\begin{tikzinline}[node distance=.5em and 1em]
%       \event{a}{(s{+}r){=}7\mid\DW{x}{7}}{}
%       \xform{xi}{\bForm[s{+}r/x]}{above=of a}
%       \xform{xd}{\bForm[s{+}r/x]}{below=of a}
%       \xo[xright]{a}{xd}
%     \end{tikzinline}}
%   \end{gathered}
% \end{align*}
% Composing

% For example, let $\aCmd_1=\PR{x}{r}$ and $\aCmd_2=\PW{x}{r{+}1}$ and
% $\aCmd=\aCmd_1\SEMI \aCmd_2$.
% \begin{align*}
%   \fwp{\aCmd_2}{x{>}1}&=(r{+}1{>}1) = (r{>}0)
%   \\
%   \fwp{\aCmd_1}{r{>}0}=\fwp{\aCmd_0}{x{>}1}&=(x{>}0)
% \end{align*}
% Let $\aPS_i\in\sem{\aCmd_i}$.
% \begin{align*}
%   \aTr[2]{\aEvs_2}{x{>}1}&=(r{+}1{>}1) = (r{>}0)
%   \\
%   \aTr[0]{\aEvs_0}{x{>}1}&=(0{=}\aReg \limplies r{>}0)
%   \\
%   \aTr[0]{\aEvs_0}{x{>}1}&=(1{=}\aReg \limplies r{>}0)
%   \\
%   \aTr[0]{\aEvs_0}{x{>}1}&=(2{=}\aReg \limplies r{>}0)
% \end{align*}

% \begin{proposition}
%   If $\aPS\in\sem{\aCmd}$ is top-level and quiescent then 
%   $\aTr{\aEvs}{\aForm}$ implies $\fwp{\aCmd}{\aForm}$.

%   For any substitution $\aSub=[{\aVal_1/\aReg_1},\ldots, {\aVal_n/\aReg_n}]$ there is some
%   $\aPS\in\sem{\aCmd}$ %that is top-level and quiescent
%   such that all preconditions in $\aPS\aSub$ are tautologies then 
%   $\fwp{\aCmd}{\aForm}\aSub$
% \end{proposition}


\subsection{Combining Address Calculation and If-Closure}


\subsection{The Need for Respect}
In \reffig{fig:seq}, we choose the weakest precondition.  Because of this,
associativity requires that \ref{seq-le} is $\PBR{{\lt}\rextends{\lt_1}{\lt_2}}$
rather than $\PBR{{\lt}\rsupset{\lt_1}{\lt_2}}$.  Consider
\begin{math}
  \PBR{
    \PR{x}{r}
    \SEMI
    \PW{y}{\aExp}
    \SEMI
    \SKIP
  }.
\end{math}
Associating to the left, we might have:
\begin{align*}
  \aPS_{12}=
  \hbox{\begin{tikzinline}[node distance=1em]
      \eventr{d}{d}{\DR{x}{}}{}
      \eventr{e}{e}{\aForm\mid \DW{y}{}}{right=of d}
    \end{tikzinline}}
  &&
  \aPS_{3}= \emptyset
  &&
  \aPS=
  \hbox{\begin{tikzinline}[node distance=1em]
      \eventr{d}{d}{\DR{x}{}}{}
      \eventr{e}{e}{\aForm\mid \DW{y}{}}{right=of d}
      \po{d}{e}
    \end{tikzinline}}
\end{align*}
When building $\aPS_{12}$, we would have had $\Cdown{e}=\emptyset$, and thus
$\aForm$ must have been constructed using the independent transformer
\ref{read-tau-ind}.  Attempting to repeat this, associating to the right:
\begin{align*}
  \aPS_{1}=
  \hbox{\begin{tikzinline}[node distance=1em]
      \eventr{d}{d}{\DR{x}{}}{}
    \end{tikzinline}}
  &&
  \aPS_{23}=
  \hbox{\begin{tikzinline}[node distance=1em]
      \eventr{e}{e}{\aForm'\mid \DW{y}{}}{}
    \end{tikzinline}}
  &&
  \aPS'=
  \hbox{\begin{tikzinline}[node distance=1em]
      \eventr{d}{d}{\DR{x}{}}{}
      \eventr{e}{e}{\aForm'\mid \DW{y}{}}{right=of d}
      \po{d}{e}
    \end{tikzinline}}
\end{align*}
In $\aPS'$, however, $\Cdown{e}=\{d\}$, and thus $\aForm'$ must be
constructed using the dependent transformer \ref{read-tau-dep}.
Since
\begin{math}
  \PBR{
    \PBR{\aVal{=}\aReg \lor \aLoc{=}\aReg}
    \limplies \bForm
  }
  \not\riff
  \PBR{
    \aVal{=}\aReg
    \limplies \bForm
  },
\end{math}
associativity fails.

If we allow stronger preconditions, as in
\cite{DBLP:journals/pacmpl/JagadeesanJR20}, then we could use inclusion
rather than $\rextendsdef{}{}$.  To arrive at this semantics, one would
replace every occurrence of $\riff$ in \reffig{fig:seq} with $\rimplies$.
Then $\PBR{{\lt}\rextends{\lt_1}{\lt_2}}$ can be replaced by
$\PBR{{\lt}\rsupset{\lt_1}{\lt_2}}$.

\subsection{Write Substitutions}
\todo{Discuss.}

Alan example of why substitute M/x rather than v/x in the write rule:
\begin{gather*}
  \PR{y}{r}\SEMI \PW{x}{r}\SEMI \PR{x}{s} \SEMI \PW{z}{s}
  \\
  \hbox{\begin{tikzinline}[node distance=.8em and 1em]
      \event{a1}{\DR{y}{1}}{}
      \event{a2}{\DW{x}{1}}{right=of a1}
      \event{a3}{\DR{x}{1}}{right=of a2}
      \event{a4}{\DW{z}{1}}{right=of a3}
      % \po[out=15,in=165]{a1}{a4}
      \po{a1}{a2}
    \end{tikzinline}}
\end{gather*}
We lost the order from $\DR{y}{1}$ to $\DW{z}{1}$.
\begin{gather*}
  \PR{x}{s}\SEMI \PW{z}{s}
  \\
  \hbox{\begin{tikzinline}[node distance=.8em and 1em]
      \event{a3}{\DR{x}{1}}{}
      \event{a4}{x\EQ1\mid\DW{z}{1}}{right=of a3}
    \end{tikzinline}}
\end{gather*}
\begin{gather*}
  \PW{x}{r} \SEMI \PR{x}{s}\SEMI \PW{z}{s}
  \\
  \hbox{\begin{tikzinline}[node distance=.8em and 1em]
      \event{a2}{\DW{x}{1}}{}
      \event{a3}{\DR{x}{1}}{right=of a2}
      \event{a4}{1\EQ1\mid\DW{z}{1}}{right=of a3}
    \end{tikzinline}}
  \\
  \hbox{\begin{tikzinline}[node distance=.8em and 1em]
      \event{a2}{\DW{x}{1}}{}
      \event{a3}{\DR{x}{1}}{right=of a2}
      \event{a4}{r\EQ1\mid\DW{z}{1}}{right=of a3}
    \end{tikzinline}}
\end{gather*}


\subsection{Read Substitutions}
\label{sec:substitutions}

In $\sLOAD{}{}$, it is also possible to collapse $\aLoc$ and $\aReg$ via substitution:
\begin{enumerate}
\item[{\labeltext[\textsc{r}4a$'$]{(\textsc{r}4a$'$)}{read-tau-dep-sub}}]
  if $(\aEvs\cap\bEvs)\neq\emptyset$ then
  \begin{math}
    \aTr{\bEvs}{\bForm} \riff
    \aVal{=}\aReg
    \limplies \bForm[\aReg/\aLoc]
  \end{math},    
\item[{\labeltext[\textsc{r}4b$'$]{(\textsc{r}4b$'$)}{read-tau-ind-sub}}]
  if $\aEvs\neq\emptyset$ and $(\aEvs\cap\bEvs)=\emptyset$ then
  \begin{math}
    \aTr{\bEvs}{\bForm} \riff
    \PBR{\aVal{=}\aReg \lor \aLoc{=}\aReg} \limplies
    \bForm[\aReg/\aLoc],
  \end{math}
\item[{\labeltext[\textsc{r}4c$'$]{(\textsc{r}4c$'$)}{read-tau-empty-sub}}]
  if $\aEvs=\emptyset$ then
  \begin{math}
    \aTr{\bEvs}{\bForm} \riff
    % \PBR{\aVal{=}\aReg \lor \aLoc{=}\aReg} \limplies
    \bForm[\aReg/\aLoc],
  \end{math}
\end{enumerate}
Perhaps surprisingly, this semantics is incomparable with that of
\reffig{fig:seq}.  Consider the following:
\begin{gather*}
  \IF{r\land s\;\mathsf{even}}\THEN \PW{y}{1}\FI\SEMI
  \IF{r\land s}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=0.5em and 1.5em]
      \event{a3}{r\land s\;\mathsf{even}\mid\DW{y}{1}}{}
      \event{a4}{r\land s\mid\DW{z}{1}}{right=of a3}
    \end{tikzinline}}
\end{gather*}
Prepending $\PRP{x}{s}$, we get the same result regardless of whether we
substitute $[s/x]$, since $x$ does not occur in either precondition.  Here
we show the independent case:
\begin{gather*}
  \PR{x}{s}\SEMI
  \IF{r\land s\;\mathsf{even}}\THEN \PW{y}{1}\FI\SEMI
  \IF{r\land s}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=0.5em and 1.5em]
      \event{a2}{\DR{x}{2}}{}
      \event{a3}{(2{=}s\lor x{=}s)\limplies (r\land s\;\mathsf{even})\mid\DW{y}{1}}{right=of a2}
      \event{a4}{(2{=}s\lor x{=}s)\limplies (r\land s)\mid\DW{z}{1}}{right=of a3}
    \end{tikzinline}}
\end{gather*}
Since the preconditions mention $x$, prepending $\PRP{x}{r}$, we now get
different results depending on whether we perform the substitution.  Without
any substitution, we have:
\begin{gather*}
  \PR{x}{r}\SEMI
  \PR{x}{s}\SEMI
  \IF{r\land s\;\mathsf{even}}\THEN \PW{y}{1}\FI\SEMI
  \IF{r\land s}\THEN \PW{z}{1}\FI
  \\[-2ex]
  \hbox{\begin{tikzinline}[node distance=0.5em and 1.5em]
      \event{a1}{\DR{x}{1}}{}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{1{=}r\limplies  (2{=}s\lor x{=}s)\limplies (r\land s\;\mathsf{even})\mid\DW{y}{1}}{right=of a2}
      \event{a4}{1{=}r\limplies  (2{=}s\lor x{=}s)\limplies (r\land s)\mid\DW{z}{1}}{right=of a3}
      \po[out=12,in=168]{a1}{a3}
      \po[out=10,in=170]{a1}{a4}
    \end{tikzinline}}
\end{gather*}
Prepending $\PWP{x}{0}$, which substitutes $[0/x]$, the precondition of
$\DWP{y}{1}$ becomes
$(1{=}r\limplies (2{=}s\lor0{=}s)\limplies (r\land s\;\mathsf{even}))$, which
is a tautology, whereas the precondition of $\DW{z}{1}$ becomes
$(1{=}r\limplies(2{=}s\lor0{=}s)\limplies (r\land s))$, which is not.  In
order to be top-level, $\DWP{z}{1}$ must be dependency ordered after
$\DRP{x}{2}$; in this case the precondition becomes
$(1{=}r\limplies2{=}s\limplies (r\land s))$, which is a tautology.
\begin{gather*}
  % \PW{x}{0}\SEMI
  % \PR{x}{r}\SEMI
  % \PR{x}{s}\SEMI
  % \IF{r\land s\;\mathsf{even}}\THEN \PW{y}{1}\FI\SEMI
  % \IF{r\land s}\THEN \PW{z}{1}\FI
  % \\
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a0}{\DW{x}{0}}{}
      \event{a1}{\DR{x}{1}}{right=of a0}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \event{a4}{\DW{z}{1}}{right=of a3}
      % \wk{a0}{a1}
      % \wk[out=-20,in=-160]{a0}{a2}
      \po[out=20,in=160]{a1}{a3}
      \po[out=20,in=160]{a1}{a4}
      \po[out=-20,in=-160]{a2}{a4}
    \end{tikzinline}}
\end{gather*}
The situation reverses with the substitution $[r/x]$:
\begin{gather*}
  \PR{x}{r}\SEMI
  \PR{x}{s}\SEMI
  \IF{r\land s\;\mathsf{even}}\THEN \PW{y}{1}\FI\SEMI
  \IF{r\land s}\THEN \PW{z}{1}\FI
  \\[-2ex]
  \hbox{\begin{tikzinline}[node distance=0.5em and 1.5em]
      \event{a1}{\DR{x}{1}}{}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{1{=}r\limplies  (2{=}s\lor r{=}s)\limplies (r\land s\;\mathsf{even})\mid\DW{y}{1}}{right=of a2}
      \event{a4}{1{=}r\limplies  (2{=}s\lor r{=}s)\limplies (r\land s)\mid\DW{z}{1}}{right=of a3}
      \po[out=12,in=168]{a1}{a3}
      \po[out=10,in=170]{a1}{a4}
    \end{tikzinline}}
\end{gather*}
Prepending $\PWP{x}{0}$:
%\vspace{-.5\baselineskip}
\begin{gather*}
  % \PW{x}{0}\SEMI
  % \PR{x}{r}\SEMI
  % \PR{x}{s}\SEMI
  % \IF{r\land s\;\mathsf{even}}\THEN \PW{y}{1}\FI\SEMI
  % \IF{r\land s}\THEN \PW{z}{1}\FI
  % \\
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a0}{\DW{x}{0}}{}
      \event{a1}{\DR{x}{1}}{right=of a0}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \event{a4}{\DW{z}{1}}{right=of a3}
      % \wk{a0}{a1}
      % \wk[out=-20,in=-160]{a0}{a2}
      \po[out=20,in=160]{a1}{a3}
      \po[out=20,in=160]{a1}{a4}
      \po{a2}{a3}
    \end{tikzinline}}
\end{gather*}
The dependency has changed from $\DRP{x}{2}\xpo\DWP{z}{1}$ to
$\DRP{x}{2}\xpo\DWP{y}{1}$.  The resulting sets of pomsets are
incomparable.


Thinking in terms of hardware, the difference is whether reads update the
cache, thus clobbering preceding writes.  With $[r/x]$, reads clobber the
cache, whereas without the substitution, they do not.  Since most caches work
this way, the model with $[r/x]$ is likely preferred for modeling hardware.
However, this substitution only makes sense in a model with read-read
coherence and read-read dependencies, which is not the case for \armeight{}.  





% \begin{figure*}[t]
%   \showRAtrue
%   \begin{center}
%     \begin{minipage}{.91\textwidth}
%       \input{fig-no-q-or-addr.tex}
%     \end{minipage}
%   \end{center}
%   \caption{Simplified Quiescence Semantics w/o Address Calculation
%     (See %\refdef{def:QSx} for $\QS{}{\amode}$, $\QL{}{\amode}$, and
%     \refdef{def:dlx} for $\DLX{\aLoc}{\amode}{\bmode}$, $\DS{\aLoc}{\amode}$)
%   } 
%   \label{fig:no-q-or-addr}
% \end{figure*}    
% \begin{figure*}
%   \begin{center}
%     \begin{minipage}{.91\textwidth}
%       \input{fig-full.tex}
%       % \input{fig-full-where.tex}
%       % \input{fig-full-noco.tex}
%     \end{minipage}
%   \end{center}
%   \caption{Full Semantics with Address Calculation
%     (See \refdef{def:QS} for $\QS{\aLoc}{\amode}$, $\QL{\aLoc}{\amode}$
%     and \refdef{def:DS} for $\DL{\aLoc}{\amode}$, $\DS{\aLoc}{\amode}$)
%   }
%   \label{fig:full}
% \end{figure*}    

%\section{Discussion}
\subsection{Downset Closure}
\label{sec:downset}

% We would like the semantics to be closed with respect to \emph{augments} and
% \emph{downsets}.

% Augments include more order and stronger formulae; in examples, we typically
% consider pomsets that are augment-minimal.  One intuitive reading of augment
% closure is that adding order can only cause preconditions to weaken.
% \begin{definition}
%   \label{def:augment}
%   $\aPS_2$ is an \emph{augment} of $\aPS_1$ if
%   \begin{enumerate}
%   \item $\aEvs_2=\aEvs_1$,
%   \item $\labelingAct_2(\aEv)=\labelingAct_1(\aEv)$,
%   \item $\labelingForm_2(\aEv) \rimplies \labelingForm_1(\aEv)$,
%   \item $\aTr[2]{\bEvs}{\aEv} \rimplies \aTr[1]{\bEvs}{\aEv}$,
%   \item if $\bEv\le_2\aEv$ then $\bEv\le_1\aEv$.
%   \end{enumerate}
% \end{definition}

% \begin{proposition}
%   %   Suppose $\aPS_1\in\sem{\aCmd}$.
%   If $\aPS_1\in\sem{\aCmd}$ and $\aPS_2$  augments $\aPS_1$ then $\aPS_2\in\sem{\aCmd}$.
%   % \item If $\aPS_2$ is a downset of $\aPS_1$ then $\aPS_2\in\sem{\aCmd}$.
%   % \end{enumerate}
% \end{proposition}

We would like the semantics to be closed with respect to \emph{downsets}.
Downsets include a subset of initial events, similar to \emph{prefixes} for
strings.
\begin{definition}
  \label{def:downset}
  $\aPS_2$ is an \emph{downset} of $\aPS_1$ if
  \begin{multicols}{2}
    \begin{enumerate}
    \item $\aEvs_2\subseteq\aEvs_1$,
    \item $(\forall \aEv\in\aEvs_2)$ $\labelingAct_2(\aEv)=\labelingAct_1(\aEv)$,
    \item $(\forall \aEv\in\aEvs_2)$ $\labelingForm_2(\aEv)\riff\labelingForm_1(\aEv)$,
    \item $(\forall \aEv\in\aEvs_2)$ $\aTr[2]{\bEvs}{\aEv}\riff\aTr[1]{\bEvs}{\aEv}$,
    \item $\aTerm[2] \rimplies \aTerm[1]$,
      \stepcounter{enumi}
    \item[] 
      \begin{enumerate}[leftmargin=0pt]
      \item $(\forall \bEv\in\aEvs_2)$ $(\forall \aEv\in\aEvs_2)$ $\bEv\lt_2\aEv$ iff $\bEv\lt_1\aEv$,
      \item $(\forall \bEv\in\aEvs_1)$ $(\forall \aEv\in\aEvs_2)$ if
        $\bEv\lt_1\aEv$ then $\bEv\in\aEvs_2$,
      \end{enumerate}
    \item $(\forall \bEv\in\aEvs_2)$ $(\forall \aEv\in\aEvs_2)$ $\bEv\rrfx_2\aEv$ iff $\bEv\rrfx_1\aEv$.
    \end{enumerate}
  \end{multicols}
\end{definition}

Downset closure fails due to for two reasons.  The key property is that the
empty set transformer should behave the same as the independent transformer.

First, downset closure fails for read-read independency \textsection\ref{sec:read-read}.
  % For \xRRD{}, \refdef{def:pomsets-rr} states:
  % \begin{enumerate}
  % \item[\ref{L4})]
  %   $\aTr{\bEvs}{\bForm} \rimplies \aVal{=}\aReg\limplies\bForm$, 
  % \item[\ref{L5})]
  %   $\aTr{\cEvs}{\bForm} \rimplies (\aVal{=}\aReg\lor\RW)\limplies\bForm$,
  % \item[\ref{L6})] 
  %   $\aTr{\dEvs}{\bForm} \rimplies \bForm$, when $\aEvs=\emptyset$.
  % \end{enumerate}
  % This semantics is not downset closed due to the lack of read-read dependencies.
  % In both cases, for subsequent writes, \ref{L5} is the same as \ref{L6}.  For
  % subsequent reads, \ref{L5} is the same as \ref{L4}.
Consider
\begin{gather*}
  \begin{gathered}[t]
    \PR{x}{r}\SEMI\IF{\BANG r}\THEN\PR{y}{s}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a}{\DR{x}{0}}{}
        \event{b}{\DR{y}{0}}{right=of a}
      \end{tikzinline}}
  \end{gathered}    
\end{gather*}
The semantics of this program includes the singleton pomset $\DRP{x}{0}$,
but not the singleton pomset $\DRP{y}{0}$.
To get $\DRP{x}{0}$, we combine:
\begin{align*}
  \begin{gathered}[t]
    \PR{x}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a}{\DR{x}{0}}{}
      \end{tikzinline}}
  \end{gathered}    
  &&
  \begin{gathered}[t]
    \IF{\BANG r}\THEN\PR{y}{s}\FI
    \\
    \emptyset
  \end{gathered}    
\end{align*}
Attempting to get $\DRP{y}{0}$, we instead get:
\begin{align*}
  \begin{gathered}[t]
    \PR{x}{r}
    \\
    \emptyset
  \end{gathered}    
  &&
  \begin{gathered}[t]
    \IF{\BANG r}\THEN\PR{y}{s}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{b}{r\EQ0\mid\DR{y}{0}}{}
      \end{tikzinline}}
  \end{gathered}    
\end{align*}
Since $r$ appears only once in the program, this pomset cannot contribute
to a top-level pomset.


Second, the semantics is not downset closed because the independency reasoning of
\ref{read-tau-ind} is only applicable for pomsets where the ignored read is present!
Revisiting \jmm{} causality test case 1 from the end of \textsection\ref{sec:ex:control}:
\begin{align*}
  \begin{gathered}[t]
    \PW{x}{0} 
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a0}{\DW{x}{0}}{}
        \xform{xi}{\bForm[0/x]}{below=of a0}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \PR{x}{r} 
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a1}{\DR{x}{1}}{}
        \xform{xi}{(1{=}r\lor x{=}r)\limplies\bForm}{below=of a1}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \IF{r{\geq}0}\THEN \PW{y}{1} \FI
    \SEMI
    \PW{z}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a2}{r{\geq}0\mid\DW{y}{1}}{}      
        \event{a3}{r{=}1\mid\DW{z}{1}}{right=of a2}      
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
% Composing:
\begin{align*}
  \begin{gathered}[t]
    \PW{x}{0} 
    \SEMI\PR{x}{r} 
    \SEMI\IF{r{\geq}0}\THEN \PW{y}{1} \FI
    \SEMI
    \PW{z}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a0}{\DW{x}{0}}{}
        \event{a1}{\DR{x}{1}}{right=of a0}
        \event{a2}{(1{=}r\lor 0{=}r)\limplies r{\geq}0\mid\DW{y}{1}}{right=of a1}      
        \event{a3}{1{=}r\limplies r{=}1\mid\DW{z}{1}}{right=of a2}
        \po[out=-15,in=-165]{a1}{a3}
        \wki{a0}{a1}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
The precondition of $\DWP{y}{1}$ is a tautology.

Taking the empty set for the read, however,
the precondition of $\DWP{y}{1}$ is not a tautology:
\begin{align*}
  \begin{gathered}[t]
    \PW{x}{0} 
    \SEMI\PR{x}{r} 
    \SEMI\IF{r{\geq}0}\THEN \PW{y}{1} \FI
    \SEMI
    \PW{z}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a0}{\DW{x}{0}}{}
        % \event{a1}{\DR{x}{1}}{right=of a0}
        \event{a2}{r{\geq}0\mid\DW{y}{1}}{right=6em of a0}      
        \event{a3}{r{=}1\mid\DW{z}{1}}{right=of a2}
        % \wk{a0}{a1}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
One way to deal with the second issue would be to allow general access
elimination to merge $\DWP{x}{0}$ and $\DRP{x}{0}$:
\begin{align*}
  \begin{gathered}[t]
    \PW{x}{0} 
    \SEMI\PR{x}{r} 
    \SEMI\IF{r{\geq}0}\THEN \PW{y}{1} \FI
    \SEMI
    \PW{z}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a0}{\DW{x}{0}}{}
        %\event{a1}{\DR{x}{1}}{right=of a0}
        \event{a2}{(0{=}r\lor 0{=}r)\limplies r{\geq}0\mid\DW{y}{1}}{right=6em of a0}      
        \event{a3}{r{=}1\mid\DW{z}{1}}{right=of a2}
        %\po[out=-15,in=-165]{a1}{a3}
        %\wki{a0}{a1}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
We leave the elaboration of this idea to future work.

\begin{comment}
  if in L6 we said [x/r], that says we know read the local version...  ignoring
  the value read...  Perhaps there is some intervening stuff that stops you
  from seeing the local state, such as release-acquire

  We could potentially get rid of [x/r] If you do two reads, your not allowed
  to be independent of the second based on the value that was read in the first
  read.

  x=0; r=x; if (r=1) { s=x; if (s=?) {y=1}}
  read 1 then 2.


  In order for the write to be independent of second read what does its
  precondition have to be.
  [r/x] then s==1
  no sub then s==0

  (s=? | Wy1)

  if (phi) z=1
  phi = s is even
  phi = s < 2

  With substitution you are saying you know that the ``local copy'' of x is the
  same as r.  Sitting in the local cache.  Read might have gone to main
  memory, but if it did it has updated the cache line so that the local copy is
  what I just read.

  If second read is a cache hit, then I know that I am seeing the same value.

  If we take substitution out then 
\end{comment}

\subsection{Logical Encoding of Delay for \PwTmcaTITLE{}}
\label{sec:delay}

\todo{Remove this section?}

In this subsection, we develop a logical encoding of $\rdelay$, which can
replace \ref{seq-le-delays} in \PwTmca{1}.  It is not obvious how to repeat
this trick for \PwTmca{2}, due to thread-local reads-from
and thread-local blockers (\ref{seq-le-delays-rf} and \ref{seq-le-rf-rf} in \refdef{def:pwt:mca2}).

As motivation, recall that we stated 
\reflem{lem:if}\eqref{lem:ifelse:if:if1}--\eqref{lem:ifelse:if:if2} as inclusions:
\begin{enumerate}
\item[\eqref{lem:ifelse:if:if1}]
  \begin{math} 
    \xIFTHEN{\aForm}{\aPSS_1}{\aPSS_2}
    \supseteq
    \xSEMI{
      \xIFTHEN{\aForm}{\aPSS_1}{}
    }{
      \xIFTHEN{\lnot\aForm}{\aPSS_2}{}
    }.
  \end{math}
  
\item[\eqref{lem:ifelse:if:if2}]
  \begin{math} 
    \xIFTHEN{\aForm}{\aPSS_1}{\aPSS_2}
    \supseteq
    \xSEMI{
      \xIFTHEN{\lnot\aForm}{\aPSS_2}{}
    }{
      \xIFTHEN{\aForm}{\aPSS_1}{}
    }.
  \end{math}
\end{enumerate}
\PwTmca{} does not satisfy the reverse inclusion.
The culprit is $\rdelay$, which introduces order regardless of whether
preconditions are disjoint.  As an example, 
\begin{math}
  \sem{\IF{r}
  \THEN \PW{x}{1}
  \ELSE \PW{x}{2}
  \FI}
\end{math}
has an execution with
\begin{math}
  (r{=}0\mid\DW{x}{2})
  \xwki
  (r{\neq}0\mid\DW{x}{1}),
\end{math}
(using augmentation), whereas
\begin{math}
  \sem{
    \IF{r} \THEN \PW{x}{1}\FI
    \SEMI
    \IF{\BANG r} \THEN \PW{x}{2}\FI
  \FI}
\end{math}
has no such execution.

\todo{Put an example for \PwTpo{}.}

In order to validate the reverse inclusions, we could require that
\ref{seq-le-delays} not impose order when
$\labelingForm_1(\bEv) \land \labelingForm_2(\aEv)$ is unsatisfiable.
Thus, following on \textsection\ref{sec:false}, we would also like this:
\begin{enumerate}
\item[{\labeltext[\textsc{s}6b$'$]{(\textsc{s}6b$'$)}{seq-le-delays'}}] if
  $\labeling_1(\bEv) \rdelays \labeling_2(\aEv)$ and
  $\labelingForm_1(\bEv) \land \labelingForm_2'(\aEv)$ is
  $\labeling$-consistent then $\bEv\le\aEv$.
\end{enumerate}

However, \eqref{seq-le-delays'} fails associativity.
Example where $\cForm_\labeling=(r{=}0)$
\begin{align*}
  \begin{gathered}    
    \PR{y}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DR{y}{0}}{}
      \end{tikzinline}}
  \end{gathered}  
  &&
  \begin{gathered}    
    \IF{r\OR s}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{b}{r{\neq}0\lor s{\neq}0\mid\DW{x}{1}}{}
      \end{tikzinline}}
  \end{gathered}    
  &&
  \begin{gathered}    
    \IF{\BANG s}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{c}{s{=}0\mid\DW{x}{2}}{}
      \end{tikzinline}}
  \end{gathered}    
\end{align*}
Associating right, order is required since
$((r{\neq}0 \lor s{\neq}0)\land s{=}0)$ is satisfiable (take $r{=}1$ and $s{=}0$):
\begin{align*}
  \begin{gathered}    
    \PR{y}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DR{y}{0}}{}
      \end{tikzinline}}
  \end{gathered}    
  &&
  \begin{gathered}    
    \IF{r\OR s}\THEN\PW{x}{1}\FI
    \SEMI
    \IF{\BANG s}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{b}{r{\neq}0\lor s{\neq}0\mid\DW{x}{1}}{}
        \event{c}{s{=}0\mid\DW{x}{2}}{right=of b}
        \wki{b}{c}
      \end{tikzinline}}
  \end{gathered}    
\end{align*}
\begin{align*}
  \begin{gathered}    
    \PR{y}{r}
    \SEMI
    \IF{r\OR s}\THEN\PW{x}{1}\FI
    \SEMI
    \IF{\BANG s}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DR{y}{0}}{}
        \event{b}{r{=}0\limplies (r{\neq}0\lor s{\neq}0)\mid\DW{x}{1}}{right=of a}
        \event{c}{s{=}0\mid\DW{x}{2}}{right=of b}
        \po{a}{b}
        \wki{b}{c}
      \end{tikzinline}}
  \end{gathered}    
\end{align*}
Associating left, order is not required between the writes since
$(s{\neq}0\land s{=}0)$ is unsatisfiable:
\begin{align*}
  \begin{gathered}    
    \PR{y}{r}
    \SEMI
    \IF{r\OR s}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DR{y}{0}}{}
        \event{b}{r{=}0\limplies (r{\neq}0\lor s{\neq}0)\mid\DW{x}{1}}{right=of a}
        \po{a}{b}
      \end{tikzinline}}
  \end{gathered}    
  &&
  \begin{gathered}    
    \IF{\BANG s}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{c}{s{=}0\mid\DW{x}{2}}{}
      \end{tikzinline}}
  \end{gathered}    
\end{align*}
\begin{align*}
  \begin{gathered}    
    \PR{y}{r}
    \SEMI
    \IF{r\OR s}\THEN\PW{x}{1}\FI
    \SEMI
    \IF{\BANG s}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DR{y}{0}}{}
        \event{b}{r{=}0\limplies (r{\neq}0\lor s{\neq}0)\mid\DW{x}{1}}{right=of a}
        \event{c}{s{=}0\mid\DW{x}{2}}{right=of b}
        \po{a}{b}
      \end{tikzinline}}
  \end{gathered}    
\end{align*}

This motivates the logic-based presentation of $\rdelay$.

In the data model, we require additional symbols: $\Q{\mSC}$, $\Qr{\aLoc}$,
and $\Qw{\aLoc}$.  We refer to these collectively as \emph{quiescence
  symbols}.

We update the \refdef{def:pomset} of complete pomset to substitute true for every
quiescence symbol (notation $[\TRUE/\Q{}]$):
\begin{definition}
  A \PwT{} is \emph{complete} if
  \begin{multicols}{2}
    \begin{enumerate}[,label=(\textsc{c}\arabic*),ref=\textsc{c}\arabic*]
      \setcounter{enumi}{\value{Bkappa}}
    \item \label{top-kappa-q}
      $\labelingForm(\aEv)[\TRUE/\Q{}]$ is a tautology,
      \setcounter{enumi}{\value{Bterm}}
    \item \label{top-term-q} $\aTerm{}[\TRUE/\Q{}]$ is a tautology.
    \end{enumerate}
  \end{multicols}
\end{definition}

We define some helper notation:
\begin{definition}
  \label{def:QS}
  Let $\Qr{*}=\textstyle\bigwedge_\bLoc \Qr{\bLoc}$, and similarly for $\Qw{*}$.\\
  Let formulae $\QS{\aLoc}{\amode}$, $\QL{\aLoc}{\amode}$, and $\QF{}{\amode}$ be defined:
  \begin{scope}
    \small
    \begin{align*}
      \QS{\aLoc}{\mRLX}&=\Qr{\aLoc}\land\Qw{\aLoc}
      &\QL{\aLoc}{\mRLX}&=\Qw{\aLoc}
      &\QF{}{\fREL}&=\Qr{*}\land\Qw{*} 
      \\
      \QS{\aLoc}{\mREL}&= \Qr{*}\land\Qw{*} 
      &\QL{\aLoc}{\mACQ}&=\Qw{\aLoc}
      &\QF{}{\fACQ} &=\Qr{*}
      \\
      \QS{\aLoc}{\mSC}&= \Qr{*}\land\Qw{*} \land \Qsc
      &\QL{\aLoc}{\mSC}&=\Qw{\aLoc}\land\Qsc      
      &\QF{}{\fSC} &= \Qr{*}\land\Qw{*} \land\Qsc
    \end{align*}
  \end{scope}
  % \end{definition}
% \begin{definition}
  Let $[\aForm/\Qr{*}]$ substitute $\aForm$ for every $\Qr{\bLoc}$, and similarly for $\Qw{*}$.\\
  Let substitutions $[\aForm/\QS{\aLoc}{\amode}]$, $[\aForm/\QL{\aLoc}{\amode}]$, and  $[\aForm/\QF{}{\amode}]$ be defined:
  \begin{scope}
    \small
    \begin{align*}
      [\aForm/\QS{\aLoc}{\mRLX}] &= [\aForm/\Qw{\aLoc}]
      &{} [\aForm/\QL{\aLoc}{\mRLX}] &= [\aForm/\Qr{\aLoc}]
      &{} [\aForm/\QF{}{\fREL}] &= [\aForm/\Qw{*}]
      \\
      [\aForm/\QS{\aLoc}{\mREL}] &= [\aForm/\Qw{\aLoc}]
      &{} [\aForm/\QL{\aLoc}{\mACQ}] &= [\aForm/\Qr{*},\aForm/\Qw{*}]
      &{} [\aForm/\QF{}{\fACQ}] &= [\aForm/\Qr{*},\aForm/\Qw{*}]
      \\
      [\aForm/\QS{\aLoc}{\mSC}] &= [\aForm/\Qw{\aLoc},\aForm/\Qsc]
      &{} [\aForm/\QL{\aLoc}{\mSC}] &= [\aForm/\Qr{*},\aForm/\Qw{*},\aForm/\Qsc]
      &{} [\aForm/\QF{}{\fSC}] &= [\aForm/\Qr{*},\aForm/\Qw{*},\aForm/\Qsc]
    \end{align*}
  \end{scope}
\end{definition}
Update the following rules from \reffig{fig:seq}.  (The change is similar for
address calculation and if-closure.)

\todo{This is buggy.  Need to enforce order for
  coherence/synchronization/dependency into a write and
  coherence/synchronization, but not dependency, into reads.  Lack of
  read-read dependency is bad here.  Note that the write rules should mention
  D---see the agda version of write.}
\begin{enumerate}[topsep=0pt,label=(\textsc{w}\arabic*),ref=\textsc{w}\arabic*]
  \setcounter{enumi}{\value{Bkappa}}
\item \label{write-kappa-q}
  \begin{math}
    \labelingForm(\aEv) \riff
    \aExp{=}\aVal
    \land
    \QS{\aLoc}{\amode}
  \end{math},    
  \stepcounter{enumi}      
\item[] \labeltext[\textsc{w}5]{}{write-tau-q}
  \begin{enumerate}[leftmargin=0pt]
  \item \label{write-tau-nonempty-q}
    if $\aEvs\neq\emptyset$ then 
    \makebox[0cm][l]{%
      \begin{math}
        \aTr{\bEvs}{\bForm} \riff 
        \bForm
        [\aExp/\aLoc][(\aExp{=}\aVal\land\QS{\aLoc}{\amode})/\QS{\aLoc}{\amode}],
      \end{math}}
  \item \label{write-tau-empty-q}
    if $\aEvs=\emptyset$ then 
    \begin{math}
      \aTr{\bEvs}{\bForm} \riff 
      \bForm
      [\aExp/\aLoc][\FALSE/\QS{\aLoc}{\amode}],
    \end{math}
  \end{enumerate}
\end{enumerate}
\begin{enumerate}[topsep=0pt,label=(\textsc{r}\arabic*),ref=\textsc{r}\arabic*]
  \setcounter{enumi}{\value{Bkappa}}
\item \label{read-kappa-q}
  \begin{math}
    \labelingForm(\aEv) \riff \QL{\aLoc}{\amode},
  \end{math}
  \stepcounter{enumi}
\item[] \labeltext[\textsc{r}4]{}{read-tau-q}
  \begin{enumerate}[leftmargin=0pt]
  \item \label{read-tau-dep-q}
    if $\aEv\in\aEvs\cap\bEvs$ then
    %if $\aEv\in\aEvs$ and $\aEv\in\bEvs$ then
    %if $\aEvs\neq\emptyset$ and $(\aEvs\cap\bEvs)\neq\emptyset$ then
    \makebox[0pt][l]{\begin{math}
        \aTr{\bEvs}{\bForm} \riff
        \aVal{=}\aReg
        \limplies \bForm,
      \end{math}}
  \item \label{read-tau-ind-q}
    if $\aEv\in\aEvs\setminus\bEvs$ then
    %if $\aEv\in\aEvs$ and $\aEv\notin\bEvs$ then
    %if $\aEvs\neq\emptyset$ and $(\aEvs\cap\bEvs)=\emptyset$ then
    \makebox[0pt][l]{\begin{math}
        \aTr{\bEvs}{\bForm} \riff
        \PBR{\aVal{=}\aReg \lor \aLoc{=}\aReg}
        \limplies \bForm [\FALSE/\QL{\aLoc}{\amode}],
      \end{math}}
  \item \label{read-tau-empty-q}
    if $\aEvs=\emptyset$ then
    \begin{math}
      \aTr{\bEvs}{\bForm} \riff
      \bForm [\FALSE/\QL{\aLoc}{\amode}],
    \end{math}
  \end{enumerate}
\end{enumerate}    
\begin{enumerate}[topsep=0pt,label=(\textsc{f}\arabic*),ref=\textsc{f}\arabic*]
  \setcounter{enumi}{\value{Bkappa}}
\item \label{fence-kappa-q}
  $\labelingForm(\aEv) \riff \QF{\aLoc}{\amode}$,
  \stepcounter{enumi}
\item[] \labeltext[\textsc{f}4]{}{fence-tau-q}
  \begin{enumerate}[leftmargin=0pt]
  \item \label{fence-tau-dep-q}
    if $\aEvs\neq\emptyset$ then
    \begin{math}
      \aTr{\bEvs}{\bForm} \riff
      \bForm,
    \end{math}
  \item \label{fence-tau-ind-q}
    if $\aEvs=\emptyset$ then
    \begin{math}
      \aTr{\bEvs}{\bForm} \riff
      \bForm [\FALSE/\QF{\aLoc}{\amode}].
    \end{math}
  \end{enumerate}
\end{enumerate}
  
The quiescence formulae indicate what must precede an event.
For example, all preceding accesses must be ordered before a releasing write,
whereas only writes on $x$ must be ordered before a releasing read on $x$.

The quiescence substitutions update quiescence symbols in subsequent code.
For subsequent independent code, $\ref{write-kappa-q}$ and $\ref{read-kappa-q}$ substitute false.
In complete pomsets, we substitute true for .
%
For example, we substitute $\FALSE$ for $\QS{\aLoc}{\mREL}$ in the independent
case for a releasing write; this ensures that subsequent writes to $\aLoc$
follow the releasing write in top-level pomsets.  Similarly, we substitute
$\FALSE$ for $\QL{\aLoc}{\mACQ}$ in the independent case for an acquiring
write; this ensures that all subsequent accesses follow the acquiring read in
top-level pomsets.

\reffig{fig:q1} shows  the effect of quiescence for each access mode.
\begin{figure}
  \input{fig-q1.tex}
  \caption{The Effect of Quiescence for Each Access Mode}
  \label{fig:q1}
\end{figure}

\begin{example}
  The definition enforces publication.  Consider:
  \begin{align*}
    \begin{gathered}[t]
      \PW{x}{1}
      \\
      \hbox{\begin{tikzinlinesmall}[node distance=.5em and 1.5em]
          \event{a}{1{=}v\land\Qr{x}\land\Qw{x}\mid\DW{x}{v}}{}
          \xform{xi}{\bForm[1/\aLoc][\FALSE/\Qw{\aLoc}]}{above=of a}
          \xform{xd}{\bForm[1/\aLoc]}{below=of a}
          \xos{a}{xd}
        \end{tikzinlinesmall}}
    \end{gathered}
    &&
    \begin{gathered}[t]
      \PW[\mREL]{x}{1}
      \\
      \hbox{\begin{tikzinlinesmall}[node distance=.5em and 1.5em]
          \raevent{a}{1{=}v\land\Qr{*}\land\Qw{*}\mid\DW[\mREL]{x}{v}}{}
          \xform{xi}{\bForm[1/\bLoc][\FALSE/\Qw{x}]}{above=of a}
          \xform{xd}{\bForm[1/\bLoc]}{below=of a}
          \xos{a}{xd}
        \end{tikzinlinesmall}}
    \end{gathered}
  \end{align*}
  Since $\Qw{*}[\FALSE/\Qw{\aLoc}]$ is $\FALSE$, we must
  introduce order to get a satisfiable precondition for $\DWP{y}{1}$.
  % composing these without order simplifies to:
  % \begin{gather*}
  %   \PW{x}{1}\SEMI \PW[\mREL]{y}{1}
  %   \\
  %   \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
  %         \event{a1}{\QS{\aLoc}{\mRLX}\mid\DW{x}{1}}{}
  %         \xform{x1d}{\bForm}{below right=of a1}
  %         \xform{x2i}{\bForm[\FALSE/\QS{\bLoc}{\mREL}]}{below=of a1}
  %         \xo{a1}{x1d}
  %         \raevent{a2}{\FALSE\mid\DW{\bLoc}{1}}{above right=of x1d}
  %         %\xform{x2d}{\bForm}{below left=of a2}
  %         \xform{x1i}{\bForm[\FALSE/\QS{\aLoc}{\mRLX}]}{below=of a2}
  %         \xform{xii}{\bForm[\FALSE/\QS{\bLoc}{\mREL}][\FALSE/\QS{\aLoc}{\mRLX}]}{below right=of a2}
  %         \xo{a2}{x1d}
  %         \xos[xleft]{a1}{x2i}
  %         \xos{a2}{x1i}
  %       \end{tikzinline}}
  % \end{gather*}
  % In order to get a satisfiable precondition for $\DWP{y}{1}$, we must
  % introduce order:
  % \begin{gather*}
  %   % \PW{x}{1}\SEMI \PW[\mREL]{y}{1}
  %   % \\
  %   \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
  %         \event{a1}{\QS{\aLoc}{\mRLX}\mid\DW{x}{1}}{}
  %         \xform{x1d}{\bForm}{below right=of a1}
  %         \xform{x2i}{\bForm[\FALSE/\QS{\bLoc}{\mREL}]}{below=of a1}
  %         \xo{a1}{x1d}
  %         \raevent{a2}{\QS{\bLoc}{\mREL}\mid\DW{\bLoc}{1}}{above right=of x1d}
  %         %\xform{x2d}{\bForm}{below left=of a2}
  %         \xform{x1i}{\bForm[\FALSE/\QS{\aLoc}{\mRLX}]}{below=of a2}
  %         \xform{xii}{\bForm[\FALSE/\QS{\bLoc}{\mREL}][\FALSE/\QS{\aLoc}{\mRLX}]}{below right=of a2}
  %         \xo{a2}{x1d}
  %         \xos[xleft]{a1}{x2i}
  %         \xos{a2}{x1i}
  %         \sync{a1}{a2}
  %       \end{tikzinline}}
  % \end{gather*}
\end{example}

\begin{example}
  \label{ex:subscription}
  The definition enforces subscription.  Consider:
  \begin{align*}
    \begin{gathered}[t]
      \PR[\mACQ]{y}{r}
      \\
      \hbox{\begin{tikzinlinesmall}[node distance=.5em and 1.5em]
          \raevent{a}{\Qw{y}\mid\DR[\mACQ]{y}{v}}{}
          \xform{xi}{\PBR{1{=}\aReg \lor y{=}\aReg} \limplies \bForm[\FALSE/\Qr{*}][\FALSE/\Qw{*}]}{above=of a}
          \xform{xd}{v{=}r\limplies\bForm}{below=of a}
          \xos{a}{xd}
        \end{tikzinlinesmall}}
    \end{gathered}
    &&
    \begin{gathered}[t]
      \PR{x}{r}
      \\
      \hbox{\begin{tikzinlinesmall}[node distance=.5em and 1.5em]
          \event{a}{\Qw{x}\mid\DR{x}{v}}{}
          \xform{xi}{\PBR{1{=}\aReg \lor x{=}\aReg} \limplies \bForm[\FALSE/\Qr{x}]}{above=of a}
          \xform{xd}{v{=}r\limplies\bForm}{below=of a}
          \xos{a}{xd}
        \end{tikzinlinesmall}}
    \end{gathered}
  \end{align*}
  Since $\Qw{x}[\FALSE/\Qw{*}]$ is $\FALSE$, we must
  introduce order to get a satisfiable precondition for $\DWP{y}{1}$.
  % Since $\QL{\aLoc}{\mRLX}[\FALSE/\QL{\bLoc}{\mACQ}]$ is $\FALSE$,
  % composing these without order simplifies to:
  % \begin{gather*}
  %   \PR[\mACQ]{y}{r}\SEMI \PR{x}{s}
  %   \\
  %   \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
  %         \raevent{a1}{\QL{\bLoc}{\mACQ}\mid\DR{y}{1}}{}
  %         \xform{x1d}{r{=}1\limplies\bForm[\FALSE/\QL{\aLoc}{\mRLX}]}{below=of a1}
  %         \xform{xdd}{r{=}1\limplies s{=}1\limplies\bForm}{right=of x1d}
  %         \xform{xii}{\bForm[\FALSE/\QL{\bLoc}{\mACQ}][\FALSE/\QL{\aLoc}{\mRLX}]}{above=of xdd}
  %         \xform{x2d}{s{=}1\limplies\bForm[\FALSE/\QL{\bLoc}{\mACQ}]}{right=of xdd}
  %         \event{a2}{\FALSE\mid\DR{x}{1}}{above=of x2d}
  %         \xos[xleft]{a1}{x1d}
  %         \xos{a2}{x2d}
  %         \xo{a1}{xdd}
  %         \xo{a2}{xdd}
  %       \end{tikzinline}}
  % \end{gather*}
  % In order to get a satisfiable precondition for $\DRP{x}{1}$, we must
  % introduce order:
  % \begin{gather*}
  %   % \PR[\mACQ]{y}{r}\SEMI \PR{x}{s}
  %   % \\
  %   \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
  %         \raevent{a1}{\QL{\bLoc}{\mACQ}\mid\DR{y}{1}}{}
  %         \xform{x1d}{r{=}1\limplies\bForm[\FALSE/\QL{\aLoc}{\mRLX}]}{below=of a1}
  %         \xform{xdd}{r{=}1\limplies s{=}1\limplies\bForm}{right=of x1d}
  %         \xform{xii}{\bForm[\FALSE/\QL{\bLoc}{\mACQ}][\FALSE/\QL{\aLoc}{\mRLX}]}{above=of xdd}
  %         \xform{x2d}{s{=}1\limplies\bForm[\FALSE/\QL{\bLoc}{\mACQ}]}{right=of xdd}
  %         \event{a2}{\QL{\aLoc}{\mRLX}\mid\DR{x}{1}}{above=of x2d}
  %         \xos[xleft]{a1}{x1d}
  %         \xos{a2}{x2d}
  %         \xo{a1}{xdd}
  %         \xo{a2}{xdd}
  %         \sync[out=15,in=165]{a1}{a2}
  %       \end{tikzinline}}
  % \end{gather*}
\end{example}

\begin{example}
Even in its logical form, \ref{seq-le-delays'} is incompatible with the
ability to strengthen preconditions using augment closure, which is allowed
in \cite{DBLP:journals/pacmpl/JagadeesanJR20}.  Consider the following.
\begin{align*}
  \begin{gathered}[t]
    \IF{r}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a1}{r{\neq}0\mid\DW{x}{2}}{}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \PW{x}{1}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a2}{            \DW{x}{1}}{}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \PW{x}{2}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a3}{            \DW{x}{2}}{}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \IF{\BANG r}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a4}{r{=}0   \mid\DW{x}{1}}{}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
% \begin{align*}
%   \begin{gathered}[t]
%     \IF{r}\THEN\PW{x}{2}\FI
%     \SEMI
%     \PW{x}{1}
%     \SEMI
%     \PW{x}{2}
%     \SEMI
%     \IF{\BANG r}\THEN\PW{x}{1}\FI
%     \\
%     \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
%         \event{a1}{r{\neq}0\mid\DW{x}{2}}{}
%         \event{a2}{            \DW{x}{1}}{right=of a1}
%         \event{a3}{            \DW{x}{2}}{right=of a2}
%         \event{a4}{r{=}0   \mid\DW{x}{1}}{right=of a3}
%       \end{tikzinline}}    
%   \end{gathered}
% \end{align*}
If $r{=}0$ then $x$ is $1,2,1$.  If $r{\neq}0$ then $x$ is $2,1,2$.
Augmenting the middle preconditions and then using sequential composition, we have:
\begin{align*}
  \begin{gathered}[t]
    \IF{r}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a1}{r{\neq}0\mid\DW{x}{2}}{}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \PW{x}{1}
    \SEMI
    \PW{x}{2}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a2}{r{\neq}0\mid\DW{x}{1}}{}
        \event{a3}{r{=}0   \mid\DW{x}{2}}{right=of a1}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \IF{\BANG r}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a4}{r{=}0   \mid\DW{x}{1}}{}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
Note that \ref{seq-le-delays'} does not require any order between the two
writes of the middle pomset.
% \begin{align*}
%   \begin{gathered}[t]
%     \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
%         \event{a1}{r{\neq}0\mid\DW{x}{2}}{}
%         \event{a2}{r{=}0   \mid\DW{x}{1}}{right=of a1}
%         \event{a3}{r{\neq}0\mid\DW{x}{2}}{right=of a2}
%         \event{a4}{r{=}0   \mid\DW{x}{1}}{right=of a3}
%       \end{tikzinline}}    
%   \end{gathered}
% \end{align*}
Merging left and right, we have:
\begin{align*}
  \begin{gathered}[t]
    \IF{r}\THEN\PW{x}{2}\FI
    \SEMI
    \PW{x}{1}
    \SEMI
    \PW{x}{2}
    \SEMI
    \IF{\BANG r}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a1}{\DW{x}{2}}{}
        \event{a4}{\DW{x}{1}}{right=of a1}
        \wki{a1}{a4}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
As shown by the following single-threaded code, allowing this outcome would violate \drfsc{}.
\begin{align*}
  \begin{gathered}[t]
    \PW{y}{1}
    \SEMI
    \PR{y}{r}
    \SEMI
    \IF{r}\THEN\PW{x}{2}\FI
    \SEMI
    \PW{x}{1}
    \SEMI
    \PW{x}{2}
    \SEMI
    \IF{\BANG r}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a1}{\DW{x}{2}}{}
        \event{a4}{\DW{x}{1}}{right=of a1}
        \wki{a1}{a4}
        \event{b2}{\DR{y}{1}}{left=of a1}
        \event{b1}{\DW{y}{1}}{left=of b2}
        \rf{b1}{b2}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
This is one reason that we use \emph{weakest} preconditions, rather than
preconditions.

The same problem does not occur due to if-closure (at least not for complete
pomsets, where you need to have termination being a tautology, so you can't
arbitrarily choose to partition $\emptyForm\neq\TRUE$:
\begin{align*}
  \begin{gathered}[t]
    \IF{r}\THEN\PW{x}{2}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a1}{r{\neq}0\mid\DW{x}{2}}{}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \PW{x}{1}
    \SEMI
    \PW{x}{2}
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a2}{r{\neq}0\mid\DW{x}{1}}{}
        \event{a2p}{r{=}0\mid\DW{x}{1}}{below=of a2}
        \event{a3}{r{=}0\mid\DW{x}{2}}{right=of a1}
        \event{a3p}{r{\neq}0\mid\DW{x}{2}}{below=of a3}
        \wki{a2}{a3p}
        \wki{a2p}{a3}
      \end{tikzinline}}    
  \end{gathered}
  &&
  \begin{gathered}[t]
    \IF{\BANG r}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a4}{r{=}0\mid\DW{x}{1}}{}
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
Merging left and right, we have
\begin{align*}
  \begin{gathered}[t]
    \IF{r}\THEN\PW{x}{2}\FI
    \SEMI
    \PW{x}{1}
    \SEMI
    \PW{x}{2}
    \SEMI
    \IF{\BANG r}\THEN\PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1.5em]
        \event{a1a3}{\DW{x}{2}}{}
        \event{a2p}{r{=}0\mid\DW{x}{1}}{right=of a1a3}
        \event{a3p}{r{\neq}0\mid\DW{x}{2}}{right=of a2p}
        \event{a2a4}{\DW{x}{1}}{right=of a3p}
        \wki[out=165,in=10]{a2a4}{a3p}
        \wki[out=170,in=15]{a2p}{a1a3}
        \wki{a3p}{a2a4}
        \wki{a1a3}{a2p} 
      \end{tikzinline}}    
  \end{gathered}
\end{align*}
\end{example}


\subsection{Is Coherence/Delay Compatible with If-closure and Dead-Write-Removal?}

\todo{Flesh this out.}

This paper has a ``High-level abstraction for efficient computation''

With if-closure, the following equation should hold:
\begin{align*}
  &\sem{
    \IF{r}\THEN\PW{x}{2}\FI
    \SEMI
    \PW{x}{1}
    \SEMI
    \PW{x}{2}
    \SEMI
    \IF{\BANG r}\THEN\PW{x}{1}\FI
    \SEMI
    \PW{x}{3}
  }
  \\ &=
  \sem{
    \IF{\BANG r}\THEN\PW{x}{1}\FI
    \SEMI
    \PW{x}{2}
    \SEMI
    \PW{x}{1}
    \SEMI
    \IF{r}\THEN\PW{x}{2}\FI
    \SEMI
    \PW{x}{3}
  }
\end{align*}
Using dead write removal, these can be refined, respectively, to:
\begin{align*}
  &\sem{
    \PW{x}{1}
    \SEMI
    \PW{x}{2}
    \SEMI
    \PW{x}{3}
  }
  \\ &\neq
  \sem{
    \PW{x}{2}
    \SEMI
    \PW{x}{1}
    \SEMI
    \PW{x}{3}
  }
\end{align*}
What has become of coherence?

