\section{\PwTmcaTITLE{}: Additional Examples}
\label{sec:extras}

This appendix includes additional examples.  They all apply equally to
\PwTmca{1} and \PwTmca{2}.  Many of these are taken directly from
\cite{DBLP:journals/pacmpl/JagadeesanJR20}; see there for further discussion.
% \subsection{Arm}
% The following execution is allowed by Arm.
% \begin{gather*}
%   {
%   \PW{x}{1}
%   \SEMI
%   \PW[\mREL]{y}{1}
% }\PAR{
%   \PR{y}{r}
%   \SEMI
%   \PW{y}{2}
%   \SEMI
%   \PR[\mACQ]{y}{s}
%   \SEMI
%   \PR{x}{t}
% }
%   \\
%   \hbox{\begin{tikzinline}[node distance=1.5em]
%     \event{a}{\DW{x}{1}}{}
%     \raevent{b}{\DW[\mREL]{y}{1}}{right=of a}
%     \event{c}{\DR{y}{1}}{right=3em of b}
%     \event{d}{\DW{y}{2}}{right=of c}
%     \raevent{e}{\DR[\mACQ]{y}{2}}{right=of d}
%     \event{f}{\DR{x}{0}}{right=of e}
%     \lob{a}{b}
%     \rfx{b}{c}
%       %     \sync[out=15,in=165]{c}{e}
%     \lob{c}{d}
%     \rfx{d}{e}
%     \lob{e}{f}
%     \fr[out=-165,in=-15]{f}[above,pos=.45]{a}
%       %     \close[out=-15,in=-165]{b}{e}
%   \end{tikzinline}}
%   \\
%   \tag{$\rgcb$}
%   \hbox{\begin{tikzinline}[node distance=1.5em]
%     \event{a}{\DW{x}{1}}{}
%     \raevent{b}{\DW[\mREL]{y}{1}}{right=of a}
%     \event{c}{\DR{y}{1}}{right=3em of b}
%     \event{d}{\DW{y}{2}}{right=of c}
%     \raevent{e}{\DR[\mACQ]{y}{2}}{right=of d}
%     \event{f}{\DR{x}{0}}{right=of e}
%     \gcbz{a}{b}
%     \gcbz{b}{c}
%     \gcbz{c}{d}
%     \gcbz{d}{e}
%       %     \gcbz{e}{f}
%     \gcbz[out=-165,in=-15]{f}{a}
%   \end{tikzinline}}
%   \\
%   \tag{$\rcb$}
%   \hbox{\begin{tikzinline}[node distance=1.5em]
%     \event{a}{\DW{x}{1}}{}
%     \raevent{b}{\DW[\mREL]{y}{1}}{right=of a}
%     \event{c}{\DR{y}{1}}{right=3em of b}
%     \event{d}{\DW{y}{2}}{right=of c}
%     \raevent{e}{\DR[\mACQ]{y}{2}}{right=of d}
%     \event{f}{\DR{x}{0}}{right=of e}
%     \cbz{a}{b}
%     \cbz{b}{c}
%     \cbz{c}{d}
%       %     \cbz{d}{e}
%     \cbz{e}{f}
%     \cbz[out=-165,in=-15]{f}{a}
%   \end{tikzinline}}
% \end{gather*}

\subsection{Buffering}

Store buffering is allowed, as required by \tso{}.
\begin{align*}
  \taglabel{SB}
  \begin{gathered}
    \PW{x}{0}\SEMI
    \PW{y}{0}\SEMI
    (
    \PW{x}{1}\SEMI\PR{y}{\aReg}
    \PAR
    \PW{y}{1}\SEMI \PR{x}{\aReg})
    \\[-1.5ex]
    \hbox{\begin{tikzinline}[node distance=.9em]
        \event{wx0}{\DW{x}{0}}{}
        \event{wy0}{\DW{y}{0}}{right=of wx0}
        \event{wx}{\DW{x}{1}}{right=3em of wy0}
        \event{ry}{\DR{y}{0}}{right=of wx}
        \event{wy}{\DW{y}{1}}{right=3em of ry}
        \event{rx}{\DR{x}{0}}{right=of wy}
        \rf[out=15,in=165]{wy0}{ry}
        \rf[out=10,in=170]{wx0}{rx}
        \wk{ry}{wy}
        \wk[out=-165,in=-15]{rx}{wx}
      \end{tikzinline}}
  \end{gathered}
\end{align*}

Load buffering is allowed, as required by \armeight{}.
\begin{align*}
  \taglabel{LB}
  \begin{gathered}
    \PR{y}{\aReg}\SEMI \PW{x}{1}
    \PAR
    \PR{x}{\aReg}\SEMI \PW{y}{1}
    \\
    \hbox{\begin{tikzinline}[node distance=.9em]
        \event{ry}{\DR{y}{1}}{}
        \event{wx}{\DW{x}{1}}{right=of ry}
        \event{rx}{\DR{x}{1}}{right=3em of wx}
        \event{wy}{\DW{y}{1}}{right=of rx}
        \rf{wx}{rx}
        \rf[out=-165,in=-15]{wy}{ry}
      \end{tikzinline}}
  \end{gathered}
\end{align*}

\subsection{Thin-Air}
Thin air is disallowed.
\cite[TC4]{PughWebsite}:
\begin{gather*}
  \taglabel{OOTA1}
  \begin{gathered}
    % \PW{y}{0}\SEMI 
    \PW{y}{\PR{x}{}}
    \PAR
    % \PW{x}{0}\SEMI
    \PR{y}{r}\SEMI \PW{x}{r}  
    \\[-.5ex]
    \smash{\hbox{\begin{tikzinline}[node distance=1.5em]
          \event{a1}{\DR{x}{1}}{}
          \event{a2}{\DW{y}{1}}{right=of a1}
          \po{a1}{a2}
          % \event{iy}{\DW{y}{0}}{left=of a1}
          % \event{ix}{\DW{x}{0}}{right=2em of a2}
          \event{b1}{\DR{y}{1}}{right=3em of a2}
          \event{b2}{\DW{x}{1}}{right=of b1}
          \po{b1}{b2}
          \rf{a2}{b1}
          \rf[out=-170,in=-10]{b2}{a1}
          % \wk[out=-15,in=-165]{iy}{a2}
          % \wk[out=-15,in=-165]{ix}{b2}
        \end{tikzinline}}}
  \end{gathered}
\end{gather*}
The control variant (\cite[TC13]{PughWebsite}) is also disallowed:
\begin{gather*}
  \taglabel{OOTA2}
  \begin{gathered}
    \IF{x}\THEN \PW{y}{1} \FI
    \PAR
    \IF{y}\THEN \PW{x}{1} %\SEMI \PW{z}{1}
    \FI
    \\[-.5ex]
    \smash{\hbox{\begin{tikzinline}[node distance=1.5em]
          \event{rx}{\DR{x}{1}}{}
          \event{wy}{\DW{y}{1}}{right=of rx}
          \po{rx}{wy}
          % \event{y0}{\DW{y}{0}}{left=of rx}
          % \event{x0}{\DW{x}{0}}{right=2em of wy}
          \event{ry}{\DR{y}{1}}{right=3em of wy}
          \event{wx}{\DW{x}{1}}{right=of ry}
          \po{ry}{wx}
          \rf{wy}{ry}
          \rf[out=-170,in=-10]{wx}{rx}
          % \wk[out=-15,in=-165]{y0}{wy}
          % \wk[out=-15,in=-165]{x0}{wx}
        \end{tikzinline}}}
  \end{gathered}
\end{gather*}
\cite[\textsection2]{DBLP:journals/pacmpl/JagadeesanJR20}
\begin{gather}
  \taglabel{OOTA3}
  \begin{gathered}
    % \PW{x}{0} \SEMI
    % \PW{y}{0} \SEMI
    % \PBR
    {
      \PW{y}{\PR{x}{}}
      \PAR
      \PR{y}{r}\SEMI
      \IF{r}\THEN
        \PW{x}{r}\SEMI
        \PW{z}{r}
      \ELSE
        \PW{x}{2}
      \FI
    }
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        % \event{wy0}{\DW{y}{0}}{}
        % \event{wx0}{\DW{x}{0}}{left=of wy0}
        \event{rx1}{\DR{x}{1}}{}
        \event{wy1}{\DW{y}{1}}{right=of rx1}
        \event{ry1}{\DR{y}{1}}{right=3em of wy1}
        \event{wx1}{\DW{x}{1}}{right=of ry1}
        \event{wa1}{\DW{z}{1}}{right=of wx1}
        %\event{stop}{\DSTOP}{right=of wa1}
        \rf[out=-165,in=-15]{wx1}{rx1}
        \rf{wy1}{ry1}
        % \wk[out=12,in=168]{wx0}{wx1}
        % \wk[out=19,in=161]{wy0}{wy1}
        \po{rx1}{wy1}
        \po[out=20,in=160]{ry1}{wa1}
        % \sync[out=20,in=160]{wx1}{stop}
        % \sync{wa1}{stop}
        \po{ry1}{wx1}
      \end{tikzinline}}
  \end{gathered}
\end{gather}
\cite[\textsection8]{DBLP:journals/lmcs/JeffreyR19} and \cite[\textsection6]{DBLP:journals/pacmpl/JagadeesanJR20}:
\begin{gather*}
  \taglabel{OOTA4}
  \begin{gathered}
    \PW{y}{\PR{x}{}}
    \PAR
    \PR{y}{r} \SEMI \IF{b}\THEN  \PW{x}{r} \SEMI \PW{z}{r} \ELSE \PW{x}{1} \FI
    \PAR
    \PW{b}{1}
    \\[-.5ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{rx}{\DR{x}{1}}{}
        \event{wy}{\DW{y}{1}}{right=of rx}
        \po{rx}{wy}
        \event{ry}{\DR{y}{1}}{right=3em of wy} 
        \event{wx}{\DW{x}{1}}{right=of ry}
        \event{wz}{\DW{z}{1}}{right=of wx}
        \event{rb}{\DR{b}{1}}{right=of wz}
        \event{wb1}{\DW{b}{1}}{right=3em of rb}
        \po{ry}{wx}
        \rf{wb1}{rb}
        \rf{wy}{ry}
        \rf[out=-170,in=-10]{wx}{rx}
        \po{rb}{wz}
        \po[out=15,in=165]{ry}{wz}
      \end{tikzinline}}
  \end{gathered}  
\end{gather*}
\cite[\textsc{rng}]{DBLP:conf/esop/SvendsenPDLV18} is disallowed since there
is no write to fulfill $(\DR{y}{1})$.
\begin{gather*}
  \taglabel{OOTA6}
  \begin{gathered}
    ( \PW{y}{\PR{x}{}{+}1}
    \PAR
    \PW{x}{\PR{y}{}} )
    \\[-.5ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{rx}{\DR{x}{1}}{}
        \event{wy}{\DW{y}{2}}{right=of rx}
        \po{rx}{wy}
        \event{ry}{\DR{y}{1}}{right=3em of wy}
        \event{wx}{\DW{x}{1}}{right=of ry}
        \po{ry}{wx}
        \rf[out=-170,in=-10]{wx}{rx}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
\ref{OOTA7} is allowed by \PS{}, but not
\weakestmo{} \cite[Fig.~3]{DBLP:journals/pacmpl/ChakrabortyV19}:
\begin{gather*}
  \taglabel{OOTA7}
  \begin{gathered}
    \PW{x}{2}\SEMI
    \IF{\PR{x}{}\NEQ2}\THEN \PW{y}{1} \FI
    \PAR
    \PW{x}{1}\SEMI
    \PR{x}{r}\SEMI
    \IF{\PR{y}{}}\THEN \PW{x}{3} \FI
    \\[-.5ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{wx2}{\DW{x}{2}}{}
        \event{rx3}{\DR{x}{3}}{right=of wx2}
        \event{wy1}{\DW{y}{1}}{right=of rx3}
        \po{rx3}{wy1}
        \event{wx1}{\DW{x}{1}}{right=2em of wy1}
        \event{rx2}{\DR{x}{2}}{right=of wx1}
        \wk{wx1}{rx2}
        \event{ry1}{\DR{y}{1}}{right=of rx2}
        \event{wx3}{\DW{x}{3}}{right=of ry1}
        \po{ry1}{wx3}
        \wk[in=165,out=15]{rx2}{wx3}
        \rf[in=170,out=10]{wy1}{ry1}
        \rf[in=170,out=10]{wx2}{rx2}
        \rf[out=-170,in=-10]{wx3}{rx3}
        \wk[out=-170,in=-10]{wx1}{wx2}
        \wk{wx2}{rx3}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}

\ref{oota4} is similar to \ref{TC5} \cite{PughWebsite}:
\begin{comment}
r1 = x //1
y = r1

r2 = y //1
x = r2

z = 1

r3 = z //0
x = r3
\end{comment}
\begin{gather*}
  \taglabel{TC5}
  \begin{gathered}
    \PW{y}{\PR{x}{}}
    \PAR
    \PW{x}{\PR{y}{}}
    \PAR
    \PW{z}{0}\SEMI\PW{z}{1}
    \PAR
    \PW{x}{\PR{z}{}}
    \\[-.5ex]
    \smash{\hbox{\begin{tikzinline}[node distance=1.5em]
          \event{rx}{\DR{x}{1}}{}
          \event{wy}{\DW{y}{1}}{right=of rx}
          \po{rx}{wy}
          \event{ry}{\DR{y}{1}}{right=3em of wy}
          \event{wx}{\DW{x}{1}}{right=of ry}
          \po{ry}{wx}
          \event{z0}{\DW{z}{0}}{right=3em of wx}
          \event{z1}{\DW{z}{1}}{right=of z0}
          \wki{z0}{z1}
          \event{rz}{\DR{z}{0}}{right=3em of z1}
          \event{wx0}{\DW{x}{0}}{right=of rz}
          \po{rz}{wx0}
          \rf{wy}{ry}
          \rf[out=-170,in=-10]{wx}{rx}
          \rf[out=10,in=170]{z0}{rz}
        \end{tikzinline}}}
  \end{gathered}
\end{gather*}
The justification for forbidding this execution states:
\begin{quote}
  values are not allowed to come out of thin air, even if there are other
  executions in which the thin-air value would have been written to that
  variable by some not out-of-thin air means.
\end{quote}
\ref{oota4} is an interesting border case, since it is allowed by speculative
models (\textsection\ref{sec:promising}).


\todo{What's the point?}
We presented two examples of thin-air behavior involving address calculation
in \textsection\ref{sec:addr}.  The justification for \ref{TC12} states:
\begin{quotation}
  \renewcommand{\ADDRARRAY}[2]{#2}%
  \renewcommand{\REFARRAY}[2]{\REF{#2}}%
  Since no other thread accesses [either $\REFARRAY{a}{0}$ or
  $\REFARRAY{a}{1}$], the code for [the second] thread should be equivalent
  to:
  \begin{displaymath}
    \PR{y}{r}\SEMI
    \PW{\REFARRAY{a}{r}}{0}\SEMI
    \PBR{\LET{s}{\IF{r{=}0}\THEN 0 \ELSE 1\FI}}\SEMI
    \PW{x}{s}\SEMI
  \end{displaymath}
  With this code, it is clear that this is the same situation as test 4.
\end{quotation}
\ref{TC12} with all initial values $0$:
\begin{gather*}
  \taglabel{TC12}
  \begin{gathered}
    \PR{y}{r}\SEMI
    \PW{\REFARRAY{}{r}}{1}\SEMI
    %\IF{r}\THEN \PW{\REFARRAY{}{1}}{1} \ELSE \PW{\REFARRAY{}{0}}{1} \FI \SEMI
    \PR{\REFARRAY{}{0}}{s}\SEMI
    \PW{x}{\BANG s}
    \PAR
    \PW{y}{\PR{x}{}}
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        % \event{iy}{\DW{y}{0}}{left=of a1}
        % \event{ix}{\DW{x}{0}}{right=2em of a2}
        \event{b1}{\DR{y}{1}}{}
        \event{b2}{\DW{\REFARRAY{}{1}}{1}}{right=of b1}
        \event{b3}{\DR{\REFARRAY{}{0}}{0}}{right=of b2}
        \event{b4}{\aForm\bigmid\DW{x}{1}}{right=of b3}
        \po{b1}{b2}
        \po{b3}{b4}
        \event{a1}{\DR{x}{1}}{right=3em of b4}
        \event{a2}{\DW{y}{1}}{right=of a1}
        \po{a1}{a2}
        % \po[out=15,in=165]{b1}{b4}
        \rf[out=-170,in=-10]{a2}{b1}
        \rf{b4}{a1}
        % \wk[out=-15,in=-165]{iy}{a2}
        % \wk[out=-15,in=-165]{ix}{b4}
      \end{tikzinline}}
  \end{gathered}
  % \\
  % \aForm \riff
  % (\Q{y}\limplies 1{=}r \lor y{=}r)\;
  % \begin{aligned}[t]
  %   \limplies\;&
  %   (r{=}0 \land ((\Q{x}[\FALSE/\Q{x}]\limplies 1{=}s)\limplies s{=}0))
  %   \\[-1ex]
  %   \land\;&
  %   (r{\neq}0 \land ((\Q{x}[1{=}1/\Q{x}]\limplies 1{=}s)\limplies s{=}0))
  % \end{aligned}
\end{gather*}

Building the precondition $\aForm$ from right to left:
\begin{align*}
  \tag{$\PW{x}{s}$}
  \aForm_1 &\riff
  s{=}0
  \\
  \tag{Prepending $\PR{\REFARRAY{}{0}}{s}$}
  \aForm_2 &\riff
  \PBR{\Q{\REFARRAY{}{0}}\limplies 0{=}s}
  \limplies
  s{=}0
  \\
  \tag{Prepending $\IF{}$}
  \aForm_3 &\riff
  \PBR{
    r{=}1
    \limplies
    \aForm_2[1/\REFARRAY{}{1}][\TRUE/\Q{\REFARRAY{}{1}}]
  }\land\PBR{
    r{=}0
    \limplies
    \aForm_2[1/\REFARRAY{}{0}][\FALSE/\Q{\REFARRAY{}{0}}]
  }
  \\[-1ex]
  &\riff
  \PBR{
    r{=}1
    \limplies
    {
      \PBR{
        \Q{\REFARRAY{}{0}}
        \limplies
        0{=}s
      }
      \limplies
      s{=}0
    }
  } \land\PBR{
    r{=}0
    \limplies
    % \PBR{
    % \FALSE
    % \limplies
    % 0{=}s
    % }
    %   \limplies
    s{=}0
  }
  \\
  \intertext{Dependent case:}
  \tag{Prepending $\PR{y}{r}$}
  \aForm_4 &\riff
  \PBR{
    \Q{y}
    \limplies
    1{=}r
  }
  \limplies
  \aForm_3
  \\
  \tag{Prepending Initializers}
  \aForm_5 &\riff
  1{=}r
  \limplies
  \PBR{
    r{=}1
    \limplies
    \PBR{
      0{=}s
      \limplies
      s{=}0
    }
  } \land\PBR{
    r{=}0
    \limplies
    s{=}0
  }
  \\
  \intertext{Independent case:}
  \tag{Prepending $\PR{y}{r}$}
  \aForm'_4 &\riff
  \PBR{
    \Q{y}
    \limplies
    1{=}r
    \lor
    y{=}r
  }
  \limplies
  \aForm_3
  \\
  \tag{Prepending Initializers}
  \aForm'_5 &\riff
  \PBR{
    1{=}r
    \lor
    0{=}r
  }
  \limplies
  \PBR{
    r{=}1
    \limplies
    \PBR{
      0{=}s
      \limplies
      s{=}0
    }
  } \land\PBR{
    r{=}0
    \limplies
    s{=}0
  }
\end{align*}

\begin{comment}
  % \renewcommand{\ADDRARRAY}[2]{#2}%
  % \renewcommand{\REFARRAY}[2]{\REF{#2}}%
  \ref{TC12} describes another potential \oota{} behavior.
  % We write $\REFARRAY{\aExp}{\bExp}$ for $\REF{\aExp{+}\bExp}$.
  Initially, $x \EQ y \EQ 0$,  $\REFARRAY{}{0} \EQ 1$, and $\REFARRAY{}{1} \EQ 2$:
  \begin{gather*}
    \taglabel{TC12}
    \begin{gathered}
      \PW{y}{\PR{x}{}}
      \PAR
      \PR{y}{r}\SEMI
      \PW{\REFARRAY{}{r}}{0}\SEMI
      \PR{\REFARRAY{}{0}}{s}\SEMI
      \PW{x}{s}\SEMI
      \\[-1ex]
      \hbox{\begin{tikzinline}[node distance=1.5em]
          \event{a1}{\DR{x}{1}}{}
          \event{a2}{\DW{y}{1}}{right=of a1}
          \po{a1}{a2}
          % \event{iy}{\DW{y}{0}}{left=of a1}
          % \event{ix}{\DW{x}{0}}{right=2em of a2}
          \event{b1}{\DR{y}{1}}{right=3em of a2}
          \event{b2}{\DW{\REFARRAY{}{1}}{0}}{right=of b1}
          \event{b3}{\DR{\REFARRAY{}{0}}{1}}{right=of b2}
          \event{b4}{\aForm\bigmid\DW{x}{1}}{right=of b3}
          \po{b1}{b2}
          %\po[out=15,in=165]{b1}{b4}
          \rf{a2}{b1}
          \rf[out=-170,in=-10]{b4}{a1}
          % \wk[out=-15,in=-165]{iy}{a2}
          % \wk[out=-15,in=-165]{ix}{b4}
        \end{tikzinline}}
    \end{gathered}
  \end{gather*}
  Building the precondition $\aForm$ from right to left (without $\A{}$):
  \begin{align*}
    \tag{$\PW{x}{s}$}
    \aForm_1 &=
    s{=}1
    \\
    \tag{Prepending $\PR{\REFARRAY{}{0}}{s}$}
    \aForm_2 &=
    \PBR{1{=}s \lor \REFARRAY{}{0}\EQ s}
    \limplies
    s{=}1
    \\
    \tag{Prepending $\PW{\REFARRAY{}{r}}{0}$}
    \aForm_3 &=
    \PBR{
      \PBR{1{=}s \lor \REFARRAY{}{0}\EQ s}
      \limplies
      s{=}1
    }[0/\REFARRAY{}{1}]
    \\
    \tag{Prepending $\PR{y}{r}$}
    \aForm_4 &=
    \PBR{r\EQ1 \lor y\EQ1}
    \limplies 
    \PBR{1{=}s \lor \REFARRAY{}{0}\EQ s}
    \limplies
    s{=}1
    \\
    \tag{Prepending $\PW{\REFARRAY{}{0}}{1}$}
    \aForm_5 &=
    \PBR{r\EQ1 \lor y\EQ1}
    \limplies 
    \PBR{1{=}s \lor 1\EQ s)}
    \limplies
    s{=}1
  \end{align*}

  Adding $\A{}$ fixes that:
  \begin{gather*}
    %\taglabel{TC12}
    \begin{gathered}
      \PW{y}{\PR{x}{}}
      \PAR
      \PR{y}{r}\SEMI
      \PW{\REFARRAY{}{r}}{0}\SEMI
      \PR{\REFARRAY{}{0}}{s}\SEMI
      \PW{x}{s}\SEMI
      \\[-1ex]
      \hbox{\begin{tikzinline}[node distance=1.5em]
          \event{a1}{\DR{x}{1}}{}
          \event{a2}{\DW{y}{1}}{right=of a1}
          \po{a1}{a2}
          % \event{iy}{\DW{y}{0}}{left=of a1}
          % \event{ix}{\DW{x}{0}}{right=2em of a2}
          \event{b1}{\DR{y}{1}}{right=3em of a2}
          \event{b2}{\DW{\REFARRAY{}{1}}{0}}{right=of b1}
          \event{b3}{\DR{\REFARRAY{}{0}}{1}}{right=of b2}
          \event{b4}{\aForm\bigmid\DW{x}{1}}{right=of b3}
          \po{b1}{b2}
          \po[out=15,in=165]{b1}{b4}
          \rf{a2}{b1}
          \rf[out=-170,in=-10]{b4}{a1}
          % \wk[out=-15,in=-165]{iy}{a2}
          % \wk[out=-15,in=-165]{ix}{b4}
        \end{tikzinline}}
    \end{gathered}
  \end{gather*}
  A compiler should be able to refine the second thread to:
  \begin{displaymath}
    \PR{y}{r}\SEMI
    \IF{r\EQ0}\THEN
      \PW{\REFARRAY{}{0}}{0}\SEMI
      \PW{x}{0}
    \ELIF{r\EQ1}\THEN
      \PW{\REFARRAY{}{1}}{0}\SEMI
      \PW{x}{1}
    \FI
  \end{displaymath}    
  Building the precondition $\aForm$ from right to left (assuming that
  $x,y\not\in\{\REFARRAY{}{0}, \REFARRAY{}{1}\}$ and $x{\neq}y$):
  \begin{align*}
    \tag{$\PW{x}{s}$}
    \aForm_1 &=
    s{=}1
    \\
    \tag{Prepending $\PR{\REFARRAY{}{0}}{s}$}
    \aForm_2 &=
    % \PBR{1{=}s \lor \REFARRAY{}{0}\EQ s}
    \PBR{1{=}s \lor (\A{\ADDRARRAY{}{0}}\limplies\REFARRAY{}{0}\EQ s)}
    % \PBR{(\ADDRARRAY{}{0}\EQ0\limplies1{=}s) \lor ((\ADDRARRAY{}{0}\EQ0\land \A{0})\limplies\REFARRAY{}{0}\EQ s)}
    \limplies
    s{=}1
    \\
    \tag{Prepending $\PW{\REFARRAY{}{r}}{0}$}
    \aForm_3 &=
    \PBR{1{=}s \lor ((0\NEQ r\land \A{\ADDRARRAY{}{0}})\limplies\REFARRAY{}{0}\EQ s)}
    \limplies
    s{=}1
    \\
    \tag{Prepending $\PR{y}{r}$}
    \aForm_4 &=
    \PBR{r\EQ1}
    \limplies 
    \PBR{1{=}s \lor ((0\NEQ r\land \A{\ADDRARRAY{}{0}})\limplies\REFARRAY{}{0}\EQ s)}
    \limplies
    s{=}1
    \\
    \tag{Prepending $\PW{\REFARRAY{}{0}}{1}$}
    \aForm_5 &=
    \PBR{r\EQ1}
    \limplies 
    \PBR{1{=}s \lor (0\NEQ r\land\TRUE)\limplies 1\EQ s)}
    \limplies
    s{=}1
  \end{align*}
\end{comment}



\cite[\textsection6]{DBLP:journals/pacmpl/JagadeesanJR20}:
\begin{quote}
  \citeauthor{BoehmOOTA}'s [\citeyear{BoehmOOTA}] \ref{RFUB} example presents
  another potential form of \oota{} behavior.
  Our analysis shows that there is no \oota{} behavior in
  \ref{RFUB}, only a false dependency:
  \begin{gather*}
    \taglabel{RFUB}
    \sem{
      \PR{y}{r}\SEMI
      \PW{x}{r}
    }
    \not\supseteq
    \sem{
      \PR{y}{r}\SEMI
      \IF{r \NEQ 1}\THEN
        \PW{z}{1}\SEMI
        \LET{r}{1}
      \FI\SEMI
      \PW{x}{r}
    }
  \end{gather*}
  The left command is half of \ref{OOTA3} ($\PW{y}{\PR{x}{}}$). %, from \textsection\ref{sec:logic}.
  The right command is dubbed \rfub{}, for \emph{Register assignment From an
    Unexecuted Branch}.  \citeauthor{BoehmOOTA} observes that in the context
  $\PW{x}{\PR{y}{}} \PAR \hole{}$, these programs have different behaviors.  Yet the
  \oota{} example on the left never writes $1$.  Why should the unexecuted
  branch change that?  Because of the conditional, the write to $x$ in
  \ref{RFUB} is independent of the read from $y$.  It useful to considering the
  Hoare logic formulas satisfied by the two threads above: we have
  $\hoare{\TRUE}{\text{\ref{RFUB}}}{x=1}$ for the right thread of \ref{RFUB}, but not
  $\hoare{\TRUE}{\text{\ref{OOTA3}}}{x=1}$ for the right thread of \ref{OOTA3}.  The
  change in the thread from \ref{OOTA3} to \ref{RFUB} is not a valid refinement
  under Hoare logic; thus, it is expected that \ref{RFUB} may have additional
  behaviors.
\end{quote}

\rfub{} New Constructor:
\begin{gather*}
  \taglabel{RFUB-NC}
  \PW{y}{\PR{x}{}}
  \PAR
  \PR{y}{r}\SEMI
  \IF{r \EQ \NULL}\THEN
    \LET{r}{\NEW{\ClassC}{}}
  \FI\SEMI
  \PW{x}{r}\SEMI
  \INVOKE{r}{\MethodF}{}
\end{gather*}
This is similar to:
\begin{gather*}
  \PW{y}{\PR{x}{}}
  \PAR
  \PR{y}{r}\SEMI
  \IF{r \EQ 0}\THEN
    \LET{r}{\RANDOM}
  \FI\SEMI
  \PW{x}{r}\SEMI
  \IF{r}\THEN \PW{z}{1} \FI
\end{gather*}
And different from the following, which is similar to \ref{TC18}:
\begin{gather*}
  \PW{y}{\PR{x}{}}
  \PAR
  \PR{y}{r}\SEMI
  \IF{r \EQ 0}\THEN
    \LET{r}{1}
  \FI\SEMI
  \PW{x}{r}\SEMI
  \IF{r}\THEN \PW{z}{1} \FI
\end{gather*}



\subsection{Coherence}

The following execution is disallowed by fulfillment (\ref{pom-rf-match} and
\ref{pom-rf-block}).  It is also disallowed by \cXI{} and Java.
\begin{gather*}
  \tag{\textsc{coh}}
  \begin{gathered}
    \PW{x}{1}\SEMI
    \PR{x}{r}
    \PAR
    \PW{x}{2}\SEMI
    \PR{x}{s}
    \\\nonumber
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a1}{\DW{x}{1}}{}
        \event{a2}{\DR{x}{2}}{right=of a1}
        \event{b1}{\DW{x}{2}}{right=3em of a2}
        \event{b2}{\DR{x}{1}}{right=of b1}
        \wki{a1}{a2}
        \wki{b1}{b2}
        \rf{b1}{a2}
        \rf[out=20,in=160]{a1}{b2}
        \wk[out=15,in=155]{a1}{b1}
        % \wk[out=-155,in=-15]{b1}{a1}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
\ref{pom-rf-block} requires that we order one write with respect to the
other, either before the write or after the read (and therefore after the
write).  Suppose we pick $1$ before $2$, as shown.  This satisfies
\ref{pom-rf-block} for $\DRP{x}{2}$.  But to satisfy the requirement for
$\DRP{x}{1}$ we must have either $\DWP{x}{2}\lt\DWP{x}{1}$ or
$\DRP{x}{1}\lt\DWP{x}{2}$.   Either way, we have a cycle.

Our model is more coherent than Java, which permits the following:
\begin{gather*}
  \taglabel{TC16}
  \begin{gathered}
    \PR{x}{r}\SEMI \PW{x}{1}
    \PAR
    \PR{x}{s}\SEMI \PW{x}{2}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a1}{\DR{x}{2}}{}
        \event{a2}{\DW{x}{1}}{right=of a1}
        \wki{a1}{a2}
        \event{b1}{\DR{x}{1}}{right=3em of a2}
        \event{b2}{\DW{x}{2}}{right=of b1}
        \wki{b1}{b2}
        \rf{a2}{b1}
        \rf[out=-165,in=-15]{b2}{a1}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
We also forbid the following, which Java allows:
\begin{gather*}
  \taglabel{Co3}
  \begin{gathered}
    \PW{x}{1}\SEMI \PW[\mREL]{y}{1}
    \PAR
    \PW{x}{2}\SEMI \PW[\mREL]{z}{1}
    \PAR
    \PR[\mRA]{z}{r} \SEMI 
    \PR[\mRA]{y}{r} \SEMI 
    \PR{x}{r} \SEMI 
    \PR{x}{r}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a1}{\DW{x}{1}}{}
        \event{a2}{\DW[\mRA]{y}{1}}{right=of a1}
        \sync{a1}{a2}
        \event{b1}{\DW{x}{2}}{right=3em of a2}
        \event{b2}{\DW[\mRA]{\,z}{1}}{right=of b1}
        \sync{b1}{b2}
        \event{c1}{\DR[\mRA]{\,z}{1}}{right=3em of b2}
        \event{c2}{\DR[\mRA]{y}{1}}{right=of c1}
        \event{c3}{\DR{x}{2}}{right=of c2}
        \event{c4}{\DR{x}{1}}{right=of c3}
        \sync{c1}{c2}
        \sync{c2}{c3}
        \sync[out=20,in=160]{c2}{c4}
        \rf[out=8,in=172]{a2}{c2}
        \rf{b2}{c1}
        \wk[out=19,in=161]{a1}{b1}
        \wk[out=-172,in=-8]{c4}{b1}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}

The following outcome is allowed by the promising semantics
\cite{DBLP:conf/popl/KangHLVD17}, but not in \weakestmo{}
\cite[Fig.~3]{DBLP:journals/pacmpl/ChakrabortyV19}.  We disallow it:
\begin{gather*}
  \tag{\textsc{coh-cyc}}
  \begin{gathered}
    \PW{x}{2}\SEMI
    \IF{x\NEQ2}\THEN \PW{y}{1} \FI
    \PAR
    \PW{x}{1}\SEMI
    \PR{x}{r}\SEMI
    \IF{y}\THEN \PW{x}{3} \FI
    \\\nonumber
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{wx2}{\DW{x}{2}}{}
        \event{rx3}{\DR{x}{3}}{right=of wx2}
        \wki{wx2}{rx3}
        \event{wy1}{\DW{y}{1}}{right=of rx3}
        \po{rx3}{wy1}
        \event{wx1}{\DW{x}{1}}{right=2em of wy1}
        \event{rx2}{\DR{x}{2}}{right=of wx1}
        \wki{wx1}{rx2}
        \event{ry1}{\DR{y}{1}}{right=of rx2}
        \event{wx3}{\DW{x}{3}}{right=of ry1}
        \po{ry1}{wx3}
        \wki[in=165,out=15]{rx2}{wx3}
        \rf[in=170,out=10]{wy1}{ry1}
        \rf[in=170,out=10]{wx2}{rx2}
        \rf[out=-170,in=-10]{wx3}{rx3}
        \wk[out=-170,in=-10]{wx1}{wx2}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}

\cXI{} includes read-read
coherence between relaxed atomics in order to forbid the following.
We do not order reads by intra-thread coherence, and this allow the following:
\begin{gather*}
  \taglabel{Co2}
  \begin{gathered}
    \PW{x}{1}\SEMI \PW{x}{2}
    \PAR
    \PW{y}{\PR{x}{}} \SEMI \PW{z}{\PR{x}{}}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DW{x}{1}}{}
        \event{b}{\DW{x}{2}}{right=of a}
        \wki{a}{b}
        \event{c}{\DR{x}{2}}{right=3em of b}
        \event{d}{\DW{y}{2}}{right=of c}
        \po{c}{d}
        \event{e}{\DR{x}{1}}{right=of d}
        \event{f}{\DW{z}{1}}{right=of e}
        \po{e}{f}
        \rf{b}{c}
        \rf[out=10,in=170]{a}{e}
        \wk[out=-165,in=-15]{e}{b}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
Here, the reader sees $2$ then $1$, although they are written in the reverse
order.
% This behavior is allowed by Java in order to validate CSE without requiring
% aliasing analysis.

We also allow the following, similar execution:
\begin{gather*}
  \PW{x}{1}\SEMI \PW{x}{2}
  \PAR
  \PR{x}{r_1} \SEMI
  \PR{x}{r_2} \SEMI
  \PR{x}{r_3} \SEMI
  \\
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DW{x}{1}}{}
      \event{a2}{\DW{x}{2}}{right=of a1}
      \wk{a1}{a2}
      \event{b1}{\DR{x}{2}}{right=3em of a2}
      \event{b2}{\DR{x}{1}}{right=of b1}
      \event{b3}{\DR{x}{2}}{right=of b2}
      % \po{b1}{b2}
      % \po{b2}{b3}
      \rf{a2}{b1}
      \rf[out=15,in=165]{a1}{b2}
      \rf[out=15,in=165]{a2}{b3}
      \wk[out=-165,in=-15]{b2}{a2}
    \end{tikzinline}}
\end{gather*}

\citeauthor{DBLP:conf/java/Pugh99} [\citeyear{DBLP:conf/java/Pugh99},
\textsection2.3] presented the following example to show that Java's original
memory model required alias analysis to validate common subexpression
elimination (\CSE).
\begin{gather*}
  \PR{x}{r_1} \SEMI
  \PR{z}{r_2} \SEMI  
  \PR{x}{r_3} \SEMI
  \IF{r_3{\leq}1}\THEN y=r_2\FI
  \\
  \hbox{\begin{tikzinline}[node distance=.8em and 1em]
      \event{a1}{\DR{x}{1}}{}
      \event{a2}{\DR{z}{2}}{right=of a1}
      % \event{a3}{\DR{x}{1}}{right=of a2}
      \event{a4}{\DW{y}{2}}{right=of a2}
      \po{a2}{a4}
      \po[out=15,in=165]{a1}{a4}
    \end{tikzinline}}
\end{gather*}
Coalescing the two read of $x$ is obviously allowed if $z{\neq}x$.
But if $z{=}x$, coalescing is only permitted because we do not include
read-read pairs in $\eqreorderco$ (\textsection\ref{sec:actions}):
\begin{displaymath}
  {\eqreorderco}
  =
  \{(\DW{\aLoc}{}\Cb \DW{\aLoc}{})\Cc(\DR{\aLoc}{}\Cb \DW{\aLoc}{})\Cc(\DW{\aLoc}{}\Cb \DR{\aLoc}{})\}
\end{displaymath}
\cXI{} has read-read coherence, and therefore \CSE{} is only valid up to
alias analysis in \cXI{}.


% \begin{gather*}
%   \PR{x}{r_1} \SEMI
%   \PR{x}{r_2} \SEMI  
%   \LET{r_3}{r_1} \SEMI
%   \IF{r_3{\leq}1}\THEN y=r_2\FI
%   \\
%   \hbox{\begin{tikzinline}[node distance=.8em and 1em]
%     \event{a1}{\DR{x}{1}}{}
%     \event{a2}{\DR{x}{2}}{right=of a1}
%       %     \event{a3}{\DR{x}{1}}{right=of a2}
%     \event{a4}{\DW{y}{2}}{right=4em of a2}
%     \po{a2}{a4}
%     \po[out=15,in=165]{a1}{a4}
%   \end{tikzinline}}
% \end{gather*}
% I don't see the problem with this for now.  Is this sound????

\subsection{RA}
Our model is closer to strong RA (SRA)
\cite{DBLP:conf/popl/LahavGV16,DBLP:conf/pldi/LahavB20}, than RA, as in
\cXI{} and \rcXI{}.  For example, \rcXI{} allows the following, which we
disallow:
\begin{gather*}
  \taglabel{SRA}
  \begin{gathered}
    \PW{x}{2}
    \SEMI
    \PW[\mREL]{y}{1}
    \SEMI
    \PR{y}{r}
    \PAR
    \PW{y}{2}
    \SEMI
    \PW[\mREL]{x}{1}
    \SEMI
    \PR{x}{s}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a1}{\DW{x}{2}}{}
        \event{a2}{\DW[\mREL]{y}{1}}{right=of a1}
        \sync{a1}{a2}
        \event{a3}{\DR{y}{2}}{right=of a2}
        \wki{a2}{a3}
        \event{b1}{\DW{y}{2}}{right=3em of a3}
        \event{b2}{\DW[\mREL]{x}{1}}{right=of b1}
        \sync{b1}{b2}
        \event{b3}{\DR{x}{2}}{right=of b2}
        \wki{b2}{b3}
        \rf[out=10,in=170]{a1}{b3}
        \rf[out=-170,in=-10]{b1}{a3}
        \wk[out=10,in=170]{a2}{b1}
        \wk[out=-170,in=-10]{b2}{a1}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}


\subsection{MCA}

Here are a few litmus tests that distinguish \mca{} architectures from
non-\mca{} architectures.  
\ref{MCA1} is an example of \emph{write subsumption}
\cite[\textsection 3]{DBLP:journals/pacmpl/PulteFDFSS18}:
\begin{gather*}
  \taglabel{MCA1}
  \begin{gathered}
    \IF{z}\THEN \PW{x}{0} \FI \SEMI \PW{x}{1}
    \PAR
    \IF{x}\THEN \PW{y}{0} \FI \SEMI \PW{y}{1}
    \PAR
    \IF{y}\THEN \PW{z}{0} \FI \SEMI \PW{z}{1}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a1}{\DR{z}{1}}{}
        \event{a2}{\DW{x}{0}}{right=of a1}
        \po{a1}{a2}
        \event{a3}{\DW{x}{1}}{right=of a2}
        \wki{a2}{a3}
        \event{b1}{\DR{x}{1}}{right=3em of a3}
        \event{b2}{\DW{y}{0}}{right=of b1}
        \po{b1}{b2}
        \event{b3}{\DW{y}{1}}{right=of b2}
        \wki{b2}{b3}
        \event{c1}{\DR{y}{1}}{right=3em of b3}
        \event{c2}{\DW{z}{0}}{right=of c1}
        \po{c1}{c2}
        \event{c3}{\DW{z}{1}}{right=of c2}
        \wki{c2}{c3}
        \rf{a3}{b1}
        \rf{b3}{c1}
        \rf[out=-173,in=-7]{c3}{a1}  
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
Two thread variant:
\begin{gather*}
  \IF{x}\THEN \PW{y}{0} \FI \SEMI \PW{y}{1}
  \PAR
  \IF{y}\THEN \PW{x}{0} \FI \SEMI \PW{x}{1}  
  \\[-.5ex]
  \hbox{\begin{tikzinline}[node distance=1.5em]
  \event{a1}{\DR{x}{1}}{}
  \event{a2}{\DW{y}{0}}{right=of a1}
  \po{a1}{a2}
  \event{a3}{\DW{y}{1}}{right=of a2}
  \wki{a2}{a3}
  \event{b1}{\DR{y}{1}}{right=3em of a3}
  \event{b2}{\DW{x}{0}}{right=of b1}
  \po{b1}{b2}
  \event{b3}{\DW{x}{1}}{right=of b2}
  \wki{b2}{b3}
  \rf{a3}{b1}
  \rf[out=-173,in=-7]{b3}{a1}  
    \end{tikzinline}}
\end{gather*}
\ref{IRIW} is allowed if all accesses are relaxed, but not if the initial
reads are acquiring:
\begin{gather*}
  \taglabel{IRIW}
  \begin{gathered}
    % \PW{x}{0}\SEMI
    \PW{x}{1}
    \PAR
    \PR[\mRA]{x}{r}\SEMI \PR{y}{s}
    \PAR
    % \PW{y}{0}\SEMI
    \PW{y}{1}
    \PAR
    \PR[\mRA]{y}{s} \SEMI \PR{x}{r}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        % \event{wx0}{\DW{x}{0}}{}
        % \event{wx1}{\DW{x}{1}}{right=of wx0}
        % \event{wy0}{\DW{y}{0}}{below=4ex of wx0}
        % \event{wy1}{\DW{y}{1}}{right=of wy0}
        \event{wx1}{\DW{x}{1}}{}
        \event{rx1}{\DR[\mRA]{x}{1}}{right=3em of wx1}
        \event{ry0}{\DR{y}{0}}{right=of rx1}
        \event{wy1}{\DW{y}{1}}{right=3em of ry0}
        \event{ry1}{\DR[\mRA]{y}{1}}{right=3em of wy1}
        \event{rx0}{\DR{x}{0}}{right=of ry1}
        % \wk{wx0}{wx1}
        % \wk{wy0}{wy1}
        % \rf[bend left]{wy0}{ry0}
        % \rf[bend right]{wx0}{rx0}
        \sync{rx1}{ry0}
        \sync{ry1}{rx0}
        \rf{wx1}{rx1}
        \rf{wy1}{ry1}
        \wk[out=-170,in=-10]{rx0}{wx1}
        \wk{ry0}{wy1}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
\ref{MCA2} is a simplified version of \ref{IRIW}
\begin{gather*}
  \taglabel{MCA2}
  \begin{gathered}
    \PW{x}{0}\SEMI \PW{x}{1}
    \PAR
    \PW{y}{\PR{x}{}}
    \PAR
    \PR[\mRA]{y}{r} \SEMI \PR{x}{s}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{wx0}{\DW{x}{0}}{}
        \event{wx1}{\DW{x}{1}}{right=of wx0}
        \wki{wx0}{wx1}
        \event{rx1}{\DR{x}{1}}{right=3em of wx1}
        \event{wy1}{\DW{y}{1}}{right=of rx1}
        \po{rx1}{wy1}
        \event{ry1}{\DRAcq{y}{1}}{right=3em of wy1}
        \event{rx0}{\DR{x}{0}}{right=of ry1}
        \rf{wx1}{rx1}
        \rf{wy1}{ry1}
        \sync{ry1}{rx0}
        \wk[out=-170,in=-10]{rx0}{wx1}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
\cite{DBLP:conf/popl/FlurGPSSMDS16} and \cite[Fig.~4]{DBLP:conf/fm/LahavV16}
discuss the following, which is not valid in \armeight{}, although it was
valid under some earlier sketches of the model:
\begin{gather*}
  \taglabel{MCA3}
  \begin{gathered}
    \PR{x}{r}\SEMI
    \PW{x}{1}
    \PAR
    \PW{y}{\PR{x}{}}
    \PAR
    \PW{x}{\PR{y}{}}
    \\[-1.2ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DR{x}{1}}{}
        \event{b}{d:\DW{x}{1}}{right=of a}
        \wk{a}{b}
        \event{c}{\DR{x}{1}}{right=3em of b}
        \event{d}{\DW{y}{1}}{right=of c}
        \po{c}{d}
        \event{e}{\DR{y}{1}}{right=3em of d}
        \event{f}{e:\DW{x}{1}}{right=of e}
        \po{e}{f}
        \rf{b}{c}
        \rf{d}{e}
        \rf[out=-172,in=-8]{f}{a}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
These candidate executions are invalid, due to cycles.  

\subsection{Detour}

The following example \cite[Ex.~3.7]{DBLP:journals/pacmpl/PodkopaevLV19} is
disallowed by \IMM{} by including a detour relation.  It is also disallowed
by \PS{}.
\begin{gather*}
  \PW{x}{\PR{z}{}{-}1}\SEMI
  \PW{y}{\PR{x}{}}
  \PAR
  \PW{x}{1}
  \PAR
  \PW{z}{\PR{y}{}}
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{b1}{\DR{z}{1}}{}
      \event{b2}{\DW{x}{0}}{right=of b1}
      \po{b1}{b2}
      \event{b3}{\DR{x}{1}}{right=of b2}
      \event{b4}{\DW{y}{1}}{right=of b3}
      \po{b3}{b4}
      \event{c1}{\DR{y}{1}}{right=2em of b4}
      \event{c2}{\DW{z}{1}}{right=of c1}
      \po{c1}{c2}
      \event{a1}{\DW{x}{1}}{below right=2ex and -2ex of b2}
      \rf{b4}{c1}
      \rf{a1}{b3}
      \wk{b2}{a1} 
      \rf[out=-170,in=-10]{c2}{b1}
   \end{tikzinline}}
\end{gather*}

\subsection{Read-Read Dependencies and Java Final Field Semantics Versus If-Closure}

One might worry that the lack of read-read dependencies could cause \drfsc{}
to fail.  For example, the following execution has a control dependency
between the reads of the last thread, but this order is not enforced, neither
by our model, nor \armeight.
\begin{gather*}
  \PW{z}{1}\SEMI\PW[\mREL]{y}{1}
  \PAR
  \PR[\mACQ]{y}{r}\SEMI\PW[\mREL]{x}{1}
  \PAR
  \IF{\PR{x}{}}\THEN\PR{z}{s}\FI  
  \\
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{z}{1}}{}
      \event{b}{\DW[\mREL]{y}{1}}{right=of a}
      \event{c}{\DR[\mACQ]{y}{1}}{right=3em of b}
      \event{d}{\DW[\mREL]{x}{1}}{right=of c}
      \event{e}{\DR{x}{1}}{right=3em of d}
      \event{f}{\DR{z}{0}}{right=of e}
      \sync{a}{b}
      \rf{b}{c}
      \sync{c}{d}
      \rf{d}{e}
      % \ctrl{e}{f}
      \wk[out=-170,in=-10]{f}{a}
    \end{tikzinline}}
\end{gather*}
If the first read of the last thread is acquiring, then the execution is
disallowed, since acquiring reads are ordered with respect to the reads that
follow.
\begin{gather*}
  \PW{z}{1}\SEMI\PW[\mREL]{y}{1}
  \PAR
  \PR[\mACQ]{y}{r}\SEMI\PW[\mREL]{x}{1}
  \PAR
  \IF{\PR[\mACQ]{x}{}}\THEN\PR{z}{s}\FI  
  \\
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a}{\DW{z}{1}}{}
      \event{b}{\DW[\mREL]{y}{1}}{right=of a}
      \event{c}{\DR[\mACQ]{y}{1}}{right=3em of b}
      \event{d}{\DW[\mREL]{x}{1}}{right=of c}
      \event{e}{\DR[\mACQ]{x}{1}}{right=3em of d}
      \event{f}{\DR{z}{0}}{right=of e}
      \sync{a}{b}
      \rf{b}{c}
      \sync{c}{d}
      \rf{d}{e}
      \po{e}{f}
      \wk[out=-170,in=-10]{f}{a}
    \end{tikzinline}}
\end{gather*}

\armeight{} enforces address dependencies between reads, but not control
dependencies.  To support if-introduction (\AKA{} case-analysis), we drop all
dependencies between reads.  This, in turn, invalidates Java's final field
semantics.
\begin{gather*}
  \taglabel{addr2}
  \begin{gathered}
    \PBR{
      \LET{r}{1} \SEMI
      \PW{\REF{r}}{0} \SEMI
      \PW{\REF{r}}{1} \SEMI
      \PW[\mREL]{x}{r}
    }
    \PAR
    \PBR{
      \PR[\mACQ]{x}{r} \SEMI
      \PR{\REF{r}}{s}
    }
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a1}{\DW{\REF{1}}{0}}{}
        \event{a2}{\DW{\REF{1}}{1}}{right=of a1}
        \wk{a1}{a2}
        \event{a4}{\DWRel{x}{1}}{right=of a2}
        \sync{a2}{a4}
        \event{b1}{\DR[\mRA]{x}{1}}{right=3em of a4}
        \event{b2}{\DR{\REF{1}}{0}}{right=of b1}
        \sync{b1}{b2}
        \rf{a4}{b1}
        \wk[out=-170,in=-10]{b2}{a2}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
The acquire annotation is required to ensure publication.  If address
dependencies were enforced between reads then the acquire annotation could be
dropped.  However, the compiler would need to track address dependencies in
order to ensure that if-introduction did not convert them to control
dependencies.

\subsection{Local Invariant Reasoning and Value Range Analysis}
We have already seen \ref{TC1} in \textsection\ref{sec:lir}, \ref{TC2} in
\textsection\ref{sec:semreg} and \ref{JC-TC6} in \textsection\ref{sec:c11}.
Here is the complete program for \ref{TC6}:
\begin{gather*}
  \taglabel{TC6}
  \begin{gathered}
    \PW{y}{0}
    \SEMI
    \PBR{
      \PR{y}{r}
      \SEMI
      \IF{r{=}0}\THEN \PW{x}{1} \FI
      \SEMI
      \IF{r{=}1}\THEN \PW{x}{1} \FI
    } \PAR \PBR{
      \IF{\PR{x}{}\EQ1}\THEN \PW{y}{1} \FI
    }
    \\
    \hbox{\begin{tikzinlinesmall}[node distance=1.5em]
        \event{i1}{\DW{y}{0}}{}
        \event{a1}{\DR{y}{1}}{right=3em of i1}
        \event{a2}{\aForm\bigmid\DW{x}{1}}{right=of a1}
        \event{b1}{\DR{y}{1}}{right=3em of a2}
        \event{b2}{\DW{x}{1}}{right=of b1}
        \po{b1}{b2}
        \rf{a2}{b1}
        \rf[out=-165,in=-15]{b2}{a1}
      \end{tikzinlinesmall}}    
  \end{gathered}
  \\
  \aForm = (1{=}r \lor 0{=}r) \limplies (r{=}0 \lor r{=}1)
\end{gather*}

\todo{Discuss.}

Here are some additional examples:
\begin{gather*}
  \taglabel{TC8}
  \begin{gathered}
    \PW{y}{0}
    \SEMI
    \PBR{
      \PR{y}{r}
      \SEMI
      \PW{x}{1{+}r{*}r{-}r}
    } \PAR \PBR{
      \PW{y}{\PR{x}{}}
    }
    \\
    \hbox{\begin{tikzinlinesmall}[node distance=1.5em]
        \event{i1}{\DW{y}{0}}{}
        \event{a1}{\DR{y}{1}}{right=3em of i1}
        \event{a2}{\aForm\bigmid\DW{x}{1}}{right=of a1}
        \event{b1}{\DR{y}{1}}{right=3em of a2}
        \event{b2}{\DW{x}{1}}{right=of b1}
        \po{b1}{b2}
        \rf{a2}{b1}
        \rf[out=-165,in=-15]{b2}{a1}
      \end{tikzinlinesmall}}    
  \end{gathered}
  \\
  \aForm = (1{=}r \lor 0{=}r) \limplies 1{+}r{*}r{-}r=1
\end{gather*}
\begin{gather*}
  \taglabel{TC9}
  \begin{gathered}
    \PW{x}{0} \SEMI
    (\PR{x}{r}\SEMI\IF{r\geq0}\THEN \PW{y}{1} \FI
    \PAR
    \PW{x}{\PR{y}{}}
    \PAR
    \PW{x}{-2})
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{wx0}{\DW{x}{0}}{}
        \event{rx1}{\DR{x}{1}}{right=3em of wx0}
        \event{wy1}{0\geq0\bigmid\DW{y}{1}}{right=of rx1}
        \event{ry1}{\DR{y}{1}}{right=3em of wy1}
        \event{wx1}{\DW{x}{1}}{right=of ry1}
        \event{wx2}{\DW{x}{{-2}}}{right=3em of wx1}
        \po{ry1}{wx1}
        \rf[out=-168,in=-12]{wx1}{rx1}
        \rf{wy1}{ry1}
        \wk[out=10,in=170]{wx0}{wx1}
        \wk{wx0}{rx1}
        \wk{wx1}{wx2}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
\begin{gather*}
  \taglabel{Internal1}
  \begin{gathered}
    \PW{x}{1} \SEMI
    \PW[\mRA]{a}{1} \SEMI
    \IF{z^\mRA}\THEN  \PW{y}{\PR{x}{}} \FI
    \PAR
    \IF{a^\mRA}\THEN  \PW{x}{2}\SEMI \PW[\mRA]{z}{1} \FI
    \\
    \hbox{\begin{tikzinline}[node distance=1.2em]
        \event{a1}{\DW{x}{1}}{}
        \event{a2}{\DWRel{a}{1}}{right=of a1}
        \sync{a1}{a2}
        \event{b3}{\DRAcq{a}{1}}{below right=0em and 3em of a2}
        \rf{a2}{b3}
        \event{b4}{\DW{x}{2}}{right=of b3}
        \sync{b3}{b4}
        \event{b5}{\DWRel{z}{1}}{right=of b4}
        \sync{b4}{b5}
        \event{a6}{\DRAcq{b}{1}}{above right=0em and 3em of b5}
        \rf{b5}{a6}
        \event{a7}{\DR{x}{1}}{right=of a6}
        \sync{a6}{a7}
        \event{a8}{1{=}1\bigmid\DW{y}{1}}{right=of a7}
        \graypo{a7}{a8}
        \sync[out=18,in=162]{a6}{a8}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
\begin{gather*}
  \taglabel{Internal2}
  \begin{gathered}
    \PR{x}{\aReg}\SEMI
    \PW[\mRA]{y}{1}\SEMI
    \PR{y}{\bReg}\SEMI
    \PW{z}{\bReg}
    \PAR
    \PW{x}{\PR{z}{}}
    \\[-1ex]
    \nonumber
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a1}{\DR{x}{1}}{}
        \event{a2}{\DWRel{y}{1}}{right=of a1}
        \sync{a1}{a2}
        \event{a3}{\DR{y}{1}}{right=of a2}
        \event{a4}{1{=}1\bigmid\DW{z}{1}}{right=of a3}
        \rf{a2}{a3}
        \event{b1}{\DR{z}{1}}{right=3em of a4}
        \event{b2}{\DW{x}{1}}{right=of b1}
        \po{b1}{b2}
        \rf{a4}{b1}
        \rf[out=-170,in=-10]{b2}{a1}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}

% \subsection{TC17-20}

% \begin{verbatim}
% Initially,  x = y = 0
% Thread 1:         Thread 2: 
% r3 = x            r2 = y    
% if (r3 == 0)      x = r2    
% x = 1
% r1 = x
% y = r1
% Behavior in question: r1 == r2 == r3 == 1
% \end{verbatim}
% Decision: Allowed. A compiler could determine that the only legal values for
% $x$ are $0$ and $1$. From that, the compiler could deduce that $r3 \neq 0$
% implies $r3 = 1$.  A compiler could then determine that at $r1 = x$ in thread
% 1, is must be legal for to read $x$ and see the value $1$. Changing $r1 = x$
% to $r1 = 1$ would allow $y = r1$ to be transformed to $y = 1$ and performed
% earlier, resulting in the behavior in question.
Java Causality Test Case 18 asks that we justify the following execution:
\begin{displaymath}
  \taglabel{TC18}
  \begin{gathered}
    \PW{x}{0}
    \SEMI
    \PBR{
      \PW{x}{\PR{y}{}}
      \PAR
      \PR{x}{r}
      \SEMI
      \IF{r{=}0}\THEN \PW{x}{1}\FI
      \SEMI
      \PR{x}{s}
      \SEMI
      \PW{y}{s}
    }
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{i}{\DW{x}{0}}{}
        \event{e}{\DR{y}{1}}{right=3em of i}
        \event{f}{\DW{x}{1}}{right=of e}
        \event{a}{\DR{x}{1}}{right=3em of f}
        % \event{b}{\DW{x}{1}}{right=of a}
        \event{c}{\DR{x}{1}}{right=of a}
        \event{d}{\aForm\bigmid\DW{y}{1}}{right=of c}
        \po{e}{f}
        \rf[out=-165,in=-15]{d}{e}
        \rf{f}{a}
        \rf[out=15,in=165]{f}{c}
        \wki[out=15,in=165]{i}{f}
      \end{tikzinline}}
  \end{gathered}
\end{displaymath}
Before we prefix $\PW{x}{0}$, the precondition of $\DW{y}{1}$ is:
\begin{displaymath}
  \aForm\riff
  (1{=}r \lor x{=}r)
  \limplies
  \PBR{
    \SBR{r{=}0\land\PBR{(1{=}s \lor 1{=}s) \limplies s{=}1}}
    \lor
    \SBR{r{\neq}0\land\PBR{(1{=}s \lor x{=}s) \limplies s{=}1}}
  }
\end{displaymath}
Simplifying:
\begin{displaymath}
  \aForm\riff
  (1{=}r \lor x{=}r)
  \limplies
  \PBR{
    r{=}0
    \lor
    \SBR{r{\neq}0\land\PBR{(1{=}s \lor x{=}s) \limplies s{=}1}}
  }
\end{displaymath}
Prefixing $\PW{x}{0}$:
\begin{displaymath}
  \aForm\riff
  (1{=}r \lor 0{=}r)
  \limplies
  \PBR{
    r{=}0
    \lor
    \SBR{r{\neq}0\land\PBR{(1{=}s \lor 0{=}s) \limplies s{=}1}}
  }
\end{displaymath}
Drilling into the interesting part:
\begin{displaymath}
  \aForm\riff
  1{=}r
  \limplies
  \PBR{(1{=}s \lor 0{=}s) \limplies s{=}1}
\end{displaymath}
This is not a tautology.  But we get one by coalescing $s$ and $r$:
\begin{gather*}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{i}{\DW{x}{0}}{}
      \event{e}{\DR{y}{1}}{right=3em of i}
      \event{f}{\DW{x}{1}}{right=of e}
      \event{a}{\DR{x}{1}}{right=3em of f}
      % \event{b}{\DW{x}{1}}{right=of a}
      % \event{c}{\DR{x}{1}}{right=of a}
      \event{d}{\aForm\bigmid\DW{y}{1}}{right=of a}
      \po{e}{f}
      \rf[out=-165,in=-15]{d}{e}
      \rf{f}{a}
      \wki[out=15,in=165]{i}{f}
    \end{tikzinline}}
\end{gather*}
% \begin{displaymath}
%   \aForm\riff
%   (1{=}r \lor 0{=}r)
%   \limplies
%   \PBR{
%   r{=}0
%   \lor
%   \SBR{r{\neq}0\land\PBR{(1{=}r \lor 0{=}r) \limplies r{=}1}}
% }
% \end{displaymath}
% which is:
\begin{displaymath}
  \aForm\riff
  1{=}r
  \limplies
  \PBR{(1{=}r \lor 0{=}r) \limplies r{=}1}
\end{displaymath}

\ref{TC20} splits the first thread of \ref{TC18}:
\begin{gather*}  
  \taglabel{TC20}
  \begin{gathered}
    \PW{x}{0}
    \SEMI
    \PBR{
      \PW{x}{\PR{y}{}}
      \RPAR
      \PR{x}{r}\SEMI\IF{r{=}0}\THEN \PW{x}{1} \FI 
    }
    \SEMI \PR{x}{s}\SEMI \PW{y}{s}
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{i}{\DW{x}{0}}{}
        \event{e}{\DR{y}{1}}{right=3em of i}
        \event{f}{\DW{x}{1}}{right=of e}
        \event{a}{\DR{x}{1}}{right=3em of f}
        % \event{b}{\DW{x}{1}}{right=of a}
        % \event{c}{\DR{x}{1}}{right=of a}
        \event{d}{\aForm\bigmid\DW{y}{1}}{right=of a}
        \po{e}{f}
        \rf[out=-165,in=-15]{d}{e}
        \rf{f}{a}
        \wki[out=15,in=165]{i}{f}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
Because we take register state from the right, the example is the same as for
\ref{TC18} above.

TC17 replaces the condition $r{=}0$ by $r{\neq}1$ in \ref{TC18}:
\begin{displaymath}
  \aForm\riff
  (1{=}r \lor x{=}r)
  \limplies
  \PBR{
    \SBR{r{\neq}1\land\PBR{(1{=}s \lor 1{=}s) \limplies s{=}1}}
    \lor
    \SBR{r{=}1\land\PBR{(1{=}s \lor x{=}s) \limplies s{=}1}}
  }
\end{displaymath}
Simplifying and prefixing $\PW{x}{0}$:
\begin{displaymath}
  \aForm\riff
  (1{=}r \lor 0{=}r)
  \limplies
  \PBR{
    r{\neq}1
    \lor
    \SBR{r{=}1\land\PBR{(1{=}s \lor 0{=}s) \limplies s{=}1}}
  }
\end{displaymath}
Again, we have:
\begin{displaymath}
  \aForm\riff
  1{=}r
  \limplies
  \PBR{(1{=}s \lor 0{=}s) \limplies s{=}1}
\end{displaymath}
which is not a tautology.  But we get one by coalescing $s$ and $r$.

TC19 makes the same change for TC20, and follows for the same reason.


\subsection{Commuting release and acquire}
\todo{Discuss.}

RA example.  This is impossible, since $\DR{x}{1}$ unfulfilled.
\begin{gather*}
  \PW{x}{1} \SEMI
  \PW[\mREL]{a}{1} \SEMI
  \PR[\mACQ]{b}{r}\SEMI
  \PR{x}{s}\SEMI
  \PW{y}{r{+}s}
  \PAR
  \PR[\mACQ]{a}{r}\SEMI
  \PW{x}{2}\SEMI
  \PW[\mREL]{b}{10}
  \\
  \hbox{\begin{tikzinline}[node distance=.8em and 1em]
      \event{a1}{\DW{x}{1}}{}
      \event{a2}{\DWRel{a}{1}}{right=of a1}
      \sync{a1}{a2}
      \event{b3}{\DRAcq{a}{1}}{below=of a2}
      \rf{a2}{b3}
      \event{b4}{\DW{x}{2}}{right=of b3}
      \sync{b3}{b4}
      \event{b5}{\DWRel{b}{10}}{right=of b4}
      \sync{b4}{b5}
      \event{a6}{\DRAcq{b}{10}}{above=of b5}
      \rf{b5}{a6}
      \event{a7}{\DR{x}{1}}{right=of a6}
      \sync{a6}{a7}
      \event{a8}{\DW{y}{11}}{right=of a7}
      \po{a7}{a8}
      % \sync[out=10,in=170]{a6}{a8}
    \end{tikzinline}}
\end{gather*}
If you swap the release and acquire, then it is impossible for the second
thread to get in the middle.
\begin{gather*}
  \PW{x}{1} \SEMI
  \PR[\mACQ]{b}{r}\SEMI
  \PW[\mREL]{a}{1} \SEMI
  \PAR
  \PR[\mACQ]{a}{r}\SEMI
  \PW{x}{2}\SEMI
  \PW[\mREL]{b}{10}
  \\
  \hbox{\begin{tikzinline}[node distance=.8em and 1em]
      \event{a1}{\DW{x}{1}}{}
      \event{a2}{\DWRel{a}{1}}{right=of a1}
      \sync{a1}{a2}
      \event{b3}{\DRAcq{a}{1}}{below=of a2}
      \rf{a2}{b3}
      \event{b4}{\DW{x}{2}}{right=of b3}
      \sync{b3}{b4}
      \event{b5}{\DWRel{b}{10}}{right=of b4}
      \sync{b4}{b5}
      \event{a6}{\DRAcq{b}{10}}{above=of b5}
      \rf{b5}{a6}
      % \event{a7}{\DR{x}{1}}{right=of a6}
      % \sync{a6}{a7}
      % \event{a8}{\DW{y}{11}}{right=of a7}
      % \po{a7}{a8}
      \sync{a6}{a2}
      % \sync[out=10,in=170]{a6}{a8}
    \end{tikzinline}}
\end{gather*}
In this case, the following execution is possible:
\begin{gather*}
  \PW{x}{1} \SEMI
  \PR[\mACQ]{b}{r}\SEMI
  \PW[\mREL]{a}{1} \SEMI
  \PR{x}{s}\SEMI
  \PW{y}{r{+}s}
  \PAR
  \PR[\mACQ]{a}{r}\SEMI
  \PW{x}{2}\SEMI
  \PW[\mREL]{b}{10}
  \\
  \hbox{\begin{tikzinline}[node distance=.8em and 1em]
      \event{a1}{\DW{x}{1}}{}
      \event{a2}{\DRAcq{b}{10}}{right=of a1}
      \event{b5}{\DWRel{b}{10}}{below=of a2}
      \event{b4}{\DW{x}{2}}{left=of b5}
      \event{b3}{\DRAcq{a}{0}}{left=of b4}
      \sync{b4}{b5}
      \sync{b3}{b4}
      \event{a6}{\DWRel{a}{1}}{right=of a2}
      \rf{b5}{a2}
      \event{a7}{\DR{x}{1}}{right=of a6}
      \sync{a6}{a7}
      \event{a8}{\DW{y}{11}}{right=of a7}
      \po{a7}{a8}
      \sync[out=15,in=165]{a1}{a6}
      \sync{a2}{a6}
      \wk{b4}{a1}
      % \sync[out=10,in=170]{a6}{a8}
    \end{tikzinline}}
\end{gather*}
But not:
\begin{gather*}
  \PW{x}{1} \SEMI
  \PR[\mACQ]{b}{r}\SEMI
  \PW[\mREL]{a}{1} \SEMI
  \PR{x}{s}\SEMI
  \PW{y}{r{+}s}
  \PAR
  \PR[\mACQ]{a}{r}\SEMI
  \PW{x}{2}\SEMI
  \PW[\mREL]{b}{10}
  \\
  \hbox{\begin{tikzinline}[node distance=.8em and 1em]
      \event{a1}{\DW{x}{1}}{}
      \event{a2}{\DRAcq{b}{10}}{right=of a1}
      \event{b5}{\DWRel{b}{10}}{below=of a2}
      \event{b4}{\DW{x}{2}}{left=of b5}
      \event{b3}{\DRAcq{a}{0}}{left=of b4}
      \sync{b4}{b5}
      \sync{b3}{b4}
      \event{a6}{\DWRel{a}{1}}{right=of a2}
      \rf{b5}{a2}
      \event{a7}{\DR{x}{1}}{right=of a6}
      \sync{a6}{a7}
      \event{a8}{\DW{y}{11}}{right=of a7}
      \po{a7}{a8}
      \sync[out=15,in=165]{a1}{a6}
      \sync{a2}{a6}
      \wk{a1}{b4}
      \wk[out=-155,in=-30]{a7}{b4}
      % \sync[out=10,in=170]{a6}{a8}
    \end{tikzinline}}
\end{gather*}

\subsection{Sevcik examples}
\todo{Discuss.}

\citet[\textsection7]{DBLP:conf/esop/CenciarelliKS07} example. (I
incorrectly credit \citet{DBLP:conf/ecoop/SevcikA08}.)

\begin{gather*}
  \IF{x\land y}\THEN \PW{z}{1}\FI
  \PAR
  \IF{z}\THEN \PW{x}{1}\SEMI \PW{y}{1} \ELSE \PW{y}{1}\SEMI \PW{x}{1} \FI
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DR{x}{1}}{}
      \event{a2}{\DR{y}{1}}{right=of a1}
      \event{a3}{\DW{z}{1}}{right=of a2}
      \po{a2}{a3}
      \po[out=15,in=165]{a1}{a3}      
      \event{b1}{\DR{z}{1}}{right=3em of a3}
      \event{b2}{\DW{y}{1}}{right=of b1}
      \event{b3}{\DW{x}{1}}{right=of b2}
      % \po{b1}{b2}
      % \po[out=15,in=165]{b1}{b3}
      \rf{a3}{b1}
      \rf[out=-165,in=-15]{b2}{a2}
      \rf[out=-165,in=-15]{b3}{a1}
    \end{tikzinline}}
\end{gather*}


Examples from \cite[\textsection4.1]{DBLP:conf/ecoop/SevcikA08} are interesting:
Redundant write after read elimination:
\begin{verbatim}
|| lock m2; x=1; unlock m2
|| lock m1; x=2; unlock m1
|| lock m1; lock m2; r1=x; [x=r1;] r2=x; unlock m2; unlock m1 // [bracketed line removed]
\end{verbatim}
Even without the write, r1 and r2 must see the same values, whereas JMM
allows different values for the reads when the write is missing.

Redundant read after read elimination:
\begin{verbatim}
|| y=x
|| r2=y; if (r2==1){[r3=y]; x=r3}else{x=1} // [r3=r2]
\end{verbatim}
Interesting case is left $\DW{x}{1}$.  Initially has predicate
$r_3=1$. With read rule, we have $y=1$.  In read prefixing, we don't weaken.
Instead we weaken with the read into r2.
\begin{gather*}
  \begin{gathered}
    \IF{r_2{=}1}\THEN \PR{y}{r_3}\SEMI \PW{x}{r_3}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1em]
        \event{a1}{r_2{=}1 \bigmid \DR{y}{1}}{}
        \event{a2}{r_2{=}1 \land y{=}1 \bigmid \DW{x}{1}}{right=of a1}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \IF{r_2{\neq}1}\THEN \PW{x}{1}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1em]
        \event{a2}{r_2{\neq}1 \bigmid \DW{x}{1}}{}
      \end{tikzinline}}
  \end{gathered}
  \\
  \IF{r_2{=}1}\THEN \PR{y}{r_3}\SEMI \PW{x}{r_3} \ELSE \PW{x}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{r_2{=}1 \bigmid \DR{y}{1}}{}
      \event{a2}{(r_2{=}1 \land y{=}1) \lor (r_2{\neq}1) \bigmid \DW{x}{1}}{right=of a1}
    \end{tikzinline}}
  \\
  \PR{y}{r_2} \SEMI\IF{r_2{=}1}\THEN \PR{y}{r_3}\SEMI \PW{x}{r_3} \ELSE \PW{x}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DR{y}{1}}{}
      \event{a2}{(y{=}1 \land y{=}1) \lor (y{\neq}1) \bigmid\DW{x}{1}}{right=of a1}
      \event{a0}{\DR{y}{1}}{left=of a1}
      % \po[out=-15,in=-165]{a0}{a2}
    \end{tikzinline}}
\end{gather*}
To ignore the second read, we use the ``delay'' trick that we used for JMM
TC1, but this is fulfilled by a read rather than a write.
In any case, the execution with $x=y=1$ is allowed.


Roach Motel---all reads 1 impossible, but passible after swapping \verb:r1=x:
and \verb:lock m:
\begin{verbatim}
|| lock m; x=1; unlock m
|| lock m; x=2; unlock m
|| r1=x; lock m; r2=z; if(r1==2){y=1}else{y=r2}; unlock m
|| z=y
\end{verbatim}
So Question is whether you can read all 1 in
\begin{verbatim}
|| lock m; x=1; unlock m
|| lock m; x=2; unlock m
|| lock m; r1=x; r2=z; if(r1==2){y=1}else{y=r2}; unlock m
|| z=y
\end{verbatim}
In any execution, we must have 1 before 2, or 2 before 1.
\begin{itemize}
\item If thread sees 2, then read x is 2.
\item If thread sees 1, then read x is 1.
  \begin{gather*}
    \begin{gathered}
      \IF{r_1{=}2}\THEN \PW{y}{1} \ELSE \PW{y}{r_2}\FI
      \\
      \hbox{\begin{tikzinline}[node distance=.5em and 1em]
          \event{a2}{r_1{=}2\lor (r_1{\neq}2 \land r_2{=}1)\bigmid \DW{y}{1}}{}
        \end{tikzinline}}
    \end{gathered}
    \\
    \begin{gathered}
      \PR{x}{r_1}\SEMI
      \PR{z}{r_2}\SEMI
      \IF{r_1{=}2}\THEN \PW{y}{1} \ELSE \PW{y}{r_2}\FI
      \\
      \hbox{\begin{tikzinline}[node distance=.5em and 1em]
          \event{a2}{\DW{y}{1}}{}
          % \event{a2}{1{=}2\lor 1{=}1\bigmid \DW{y}{1}}{}
          \event{a1}{\DR{z}{1}}{left=of a2}
          \event{a0}{\DR{x}{1}}{left=of a1}
          \po{a1}{a2}
        \end{tikzinline}}
    \end{gathered}    
  \end{gather*}
  So impossible for y and z to be 1.
\end{itemize}

Irrelevant Read Introduction (can I read 1 for both y and z?)
\begin{verbatim}
|| r=z; if(!r){if(x){y=1}}else{[s=x;]y=r}
|| x=1; z=y
\end{verbatim}

\begin{gather*}
  \begin{gathered}
    \IF{\BANG r}\THEN \IF{x}\THEN \PW{y}{1}\FI\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1em]
        \event{a2}{r{=}0\bigmid\DW{y}{1}}{}
        \event{a1}{r{=}0\bigmid\DR{x}{1}}{left=of a2}
        \po{a1}{a2}
      \end{tikzinline}}
  \end{gathered}      
  \qquad
  \begin{gathered}
    \IF{r}\THEN \PR{x}{s}\SEMI \PW{y}{r}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1em]
        \event{a2}{r{=}1\bigmid\DW{y}{1}}{}
        \event{a1}{r{\neq}0\bigmid\DR{x}{1}}{left=of a2}
      \end{tikzinline}}
  \end{gathered}      
  \\
  \begin{gathered}
    \IF{\BANG r}\THEN \IF{x}\THEN \PW{y}{1}\FI\ELSE \PW{y}{r}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1em]
        \event{a2}{r{=}0\lor r{=}1\bigmid\DW{y}{1}}{}
        \event{a1}{\DR{x}{1}}{left=of a2}
        \po{a1}{a2}
      \end{tikzinline}}
  \end{gathered}          
  \\
  \begin{gathered}
    \PW{z}{0}\SEMI \PR{z}{r}\SEMI \IF{\BANG r}\THEN \IF{x}\THEN \PW{y}{1}\FI\ELSE \PW{y}{r}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1em]
        \event{a2}{0{=}0\lor 0{=}1\bigmid\DW{y}{1}}{}
        \event{a1}{\DR{x}{1}}{left=of a2}
        \po{a1}{a2}
        \event{a0}{\DR{z}{1}}{left=of a1}
        \event{a00}{\DW{z}{0}}{left=of a0}
        % \po[out=15,in=165]{a0}{a2}
      \end{tikzinline}}
  \end{gathered}          
\end{gather*}
\begin{gather*}
  \begin{gathered}
    \IF{\BANG r}\THEN \IF{x}\THEN \PW{y}{1}\FI\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1em]
        \event{a2}{r{=}0\bigmid\DW{y}{1}}{}
        \event{a1}{r{=}0\bigmid\DR{x}{1}}{left=of a2}
        \po{a1}{a2}
      \end{tikzinline}}
  \end{gathered}      
  \qquad
  \begin{gathered}
    \IF{r}\THEN \PW{y}{r}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1em]
        \event{a2}{r{=}1\bigmid\DW{y}{1}}{}
      \end{tikzinline}}
  \end{gathered}      
  \\
  \begin{gathered}
    \IF{\BANG r}\THEN \IF{x}\THEN \PW{y}{1}\FI\ELSE \PW{y}{r}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1em]
        \event{a2}{r{=}0\lor r{=}1\bigmid\DW{y}{1}}{}
        \event{a1}{r{=}0\bigmid\DR{x}{1}}{left=of a2}
        \po{a1}{a2}
      \end{tikzinline}}
  \end{gathered}          
  \\
  \begin{gathered}
    \PW{z}{0}\SEMI \PR{z}{r}\SEMI \IF{\BANG r}\THEN \IF{x}\THEN \PW{y}{1}\FI\ELSE \PW{y}{r}\FI
    \\
    \hbox{\begin{tikzinline}[node distance=.5em and 1em]
        \event{a2}{0{=}0\lor 0{=}1\bigmid\DW{y}{1}}{}
        \event{a1}{\DR{x}{1}}{left=of a2}
        \po{a1}{a2}
        \event{a0}{\DR{z}{1}}{left=of a1}
        \event{a00}{\DW{z}{0}}{left=of a0}
        % \po[out=15,in=165]{a0}{a2}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
If z is initialized to 2, rather than 0, then the dependencies remain and
both are disallowed.  This relies crucially on the fact that par takes
order from both sides.

\subsection{SC Access}
\todo{Discuss.}

\todo{Volatile read = full fence followed by acquire; Volatile write =
  release followed by full fence.  But this is not enough on power to
  guarantee that all-volatile program has only SC executions. On power,
  release-acquire implemented with lwsync}

\url{https://bugs.openjdk.java.net/browse/JDK-8262877}
\begin{verbatim}
volatile int x, y;

Thread 1: x = 2; r1 = y // 0

Thread 2: y = 1

Thread 3: r2 = y; x = 1 // 1

Thread 4: r3 = x; r4 = x // 1,2
\end{verbatim}
The state (r1,r2,r3,r4) = (0,1,1,2) is forbidden, as it violates sequential
consistency. (You can show it by constructing the syncronization order that
leads to this result and observing it is cyclic).

Current PPC code is one (the only?) platform that runs into the SC violation
with current barrier placement. Current placement seems to be:

Violation of SC-DRF from \cite[Fig.~9]{DBLP:conf/pldi/WattPPBDFPG20}:
\begin{verbatim}
Thread 1: x^sc = 1
Thread 2: x^sc = 2; r = x^sc; if (r==1) then s=x
\end{verbatim}
The program is DRF.
Should not be possible to have \verb|r==1,s==2|.



\cite[\textsection8.2]{Dolan:2018:BDR:3192366.3192421}:
\begin{gather*}
  \taglabel{SC1}
  \begin{gathered}
    \PR{y}{r}\SEMI \PW[\mSC]{x}{1}\SEMI \PR{x}{s}
    \PAR
    \PW[\mSC]{x}{2} \SEMI \PW{y}{1}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DR{y}{1}}{}
        \event{b}{\DW[\mSC]{x}{1}}{right=of a}
        \sync{a}{b}
        \event{bb}{\DR{x}{2}}{right=of b}
        \wk{b}{bb}
        \event{d}{\DW[\mSC]{x}{2}}{right=3em of bb}
        \event{e}{\DW{y}{1}}{right=of d}
        \rf{d}{bb}
        \rf[out=-170,in=-10]{e}{a}
        \wk[in=165,out=15]{b}{d}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
\citet[\textsection3.1]{DBLP:conf/pldi/WattPPBDFPG20}:
\begin{gather*}
  \taglabel{SC2}
  \begin{gathered}
    \PW[\mSC]{x}{1} \SEMI \PR[\mSC]{y}{r}
    \PAR
    \PW[\mSC]{y}{1} \SEMI \PW[\mSC]{y}{2} \SEMI \PW{x}{2} \SEMI \PR[\mSC]{x}{s}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a}{\DW[\mSC]{x}{1}}{}
        \event{b}{\DR[\mSC]{y}{1}}{right=of a}
        \event{c}{\DW[\mSC]{y}{1}}{right=3em of b}
        \event{d}{\DW[\mSC]{y}{2}}{right=of c}
        \event{e}{\DW{x}{2}}{right=of d}
        \event{f}{\DR[\mSC]{x}{1}}{right=of e}
        \sync{a}{b}
        \sync{c}{d}
        \sync[out=15,in=165]{d}{f}
        \rf{c}{b}
        \rf[out=8,in=172]{a}{f}
        \wk[in=-10,out=-170]{e}{a}
        \wk{e}{f}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}

\subsection{Fences}
\todo{Discuss.}

\begin{gather*}
  \taglabel{Pub2}
  \begin{gathered}
    x\GETS0\SEMI %y\GETS0\SEMI
    x\GETS 1\SEMI \FENCE{\mREL}\SEMI y \GETS1
    \PAR
    r\GETS y \SEMI \FENCE{\mACQ}\SEMI s\GETS x
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{wx0}{\DW{x}{0}}{}
        \event{wx1}{\DW{x}{1}}{right=of wx0}
        \event{fr}{\DFS{\mREL}}{right=of wx1}
        \event{wy1}{\DW{y}{1}}{right=of fr}
        \event{ry1}{\DR{y}{1}}{right=2.5em of wy1}
        \event{fa}{\DFS{\mACQ}}{right=of ry1}
        \event{rx0}{\DR{x}{0}}{right=of fa}
        \sync{wx1}{fr}
        \sync{fr}{wy1}
        \sync{ry1}{fa}
        \sync{fa}{rx0}
        \rf{wy1}{ry1}
        \wk{wx0}{wx1}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
\cite[Fig.~5]{DBLP:conf/pldi/LahavVKHD17}:
\begin{gather*}
  \taglabel{SC3}
  \begin{gathered}
    \PW{x}{1}
    \PAR
    \PR{x}{r}\SEMI   
    \FENCE{\mSC}\SEMI
    \PR{y}{r}  
    \PAR
    \PW{y}{1} \SEMI
    \FENCE{\mSC}\SEMI
    \PR{x}{r}  
    \\[-.1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a1}{\DW{x}{1}}{}
        \event{b1}{\DR{x}{1}}{right=3em of a1}
        \event{b2}{\DFS{\mSC}}{right=of b1}
        \sync{b1}{b2}
        \event{b3}{\DR{y}{0}}{right=of b2}
        \sync{b2}{b3}
        \event{c1}{\DW{y}{1}}{right=3em of b3}
        \event{c2}{\DFS{\mSC}}{right=of c1}
        \sync{c1}{c2}
        \event{c3}{\DR{x}{0}}{right=of c2}
        \sync{c2}{c3}
        \wk{b3}{c1}
        \rf{a1}{b1}
        \wk[out=-170,in=-10]{c3}{a1}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
\cite[Fig.~6]{DBLP:conf/pldi/LahavVKHD17}
\begin{gather*}
  \taglabel{SC4}
  \begin{gathered}
  \PW{x}{1}\SEMI   
    \PW[\mRA]{z}{1}\SEMI   
    \PAR
    \PR[\mACQ]{z}{r}\SEMI   
    \FENCE{\mSC}\SEMI
    \PR{y}{r}  
    \PAR
    \PW{y}{1} \SEMI
    \FENCE{\mSC}\SEMI
    \PR{x}{r}  
    \\[-.1ex]
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{a1}{\DW{x}{1}}{}
        \event{a2}{\DWRel{z}{1}}{right=of a1}
        \sync{a1}{a2}
        \event{b1}{\DRAcq{z}{1}}{right=2em of a2}
        \event{b2}{\DFS{\mSC}}{right=of b1}
        \sync{b1}{b2}
        \event{b3}{\DR{y}{0}}{right=of b2}
        \sync{b2}{b3}
        \event{c1}{\DW{y}{1}}{right=2em of b3}
        \event{c2}{\DFS{\mSC}}{right=of c1}
        \sync{c1}{c2}
        \event{c3}{\DR{x}{0}}{right=of c2}
        \sync{c2}{c3}
        \wk{b3}{c1}
        \rf{a2}{b1}
        \wk[out=-170,in=-10]{c3}{a1}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}

Here are several examples mixing fencing with release/acquire:
\begin{gather*}  
  \PW{x}{1}\SEMI
  %\FENCE{\mREL}\SEMI
  \PW[\mRA]{y}{1}
  \PAR
  \PR[\mACQ]{y}{r}\SEMI
  %\FENCE{\mACQ}\SEMI
  \PR{x}{s}
  \\[-1ex]
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{a1}{\DW{x}{1}}{}
      % \event{a2}{\DFS{\mREL}}{right=of a1}
      % \sync{a1}{a2}
      \event{a3}{\DWRel{y}{1}}{right=of a1}
      \sync{a1}{a3}
      \event{b1}{\DRAcq{y}{1}}{right=3em of a3}
      % \event{b2}{\DFS{\mACQ}}{right=of b1}
      % \sync{b1}{b2}
      \event{b3}{\DR{x}{0}}{right=of b1}
      \sync{b1}{b3}
      \rf{a3}{b1}
      \wk[out=-170,in=-10]{b3}{a1}
    \end{tikzinline}}
\end{gather*}
\begin{gather*}  
  \PW{x}{1}\SEMI
  \FENCE{\mREL}\SEMI
  \PW{y}{1}
  \PAR
  \PR[\mACQ]{y}{r}\SEMI
  %\FENCE{\mACQ}\SEMI
  \PR{x}{s}
  \\[-1ex]
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{a1}{\DW{x}{1}}{}
      \event{a2}{\DFS{\mREL}}{right=of a1}
      \sync{a1}{a2}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \sync{a2}{a3}
      \event{b1}{\DR{y}{1}}{right=3em of a3}
      % \event{b2}{\DFS{\mACQ}}{right=of b1}
      % \sync{b1}{b2}
      \event{b3}{\DR{x}{0}}{right=of b1}
      \sync{b1}{b3}
      \rf{a3}{b1}
      \wk[out=-170,in=-10]{b3}{a1}
    \end{tikzinline}}
\end{gather*}
\begin{gather*}  
  \PW{x}{1}\SEMI
  \PW[\mRA]{y}{1}
  \PAR
  \PR{y}{r}\SEMI
  \FENCE{\mACQ}\SEMI
  \PR{x}{s}
  \\[-1ex]
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{a1}{\DW{x}{1}}{}
      % \event{a2}{\DFS{\mREL}}{right=of a1}
      % \sync{a1}{a2}
      \event{a3}{\DWRel{y}{1}}{right=of a1}
      \sync{a1}{a3}
      \event{b1}{\DR{y}{1}}{right=3em of a3}
      \event{b2}{\DFS{\mACQ}}{right=of b1}
      \sync{b1}{b2}
      \event{b3}{\DR{x}{0}}{right=of b2}
      \sync{b2}{b3}
      \rf{a3}{b1}
      \wk[out=-170,in=-10]{b3}{a1}
    \end{tikzinline}}
\end{gather*}
\begin{gather*}  
  \PW{x}{1}\SEMI
  \FENCE{\mREL}\SEMI
  \PW{y}{1}
  \PAR
  \PR{y}{r}\SEMI
  \FENCE{\mACQ}\SEMI
  \PR{x}{s}
  \\[-1ex]
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{a1}{\DW{x}{1}}{}
      \event{a2}{\DFS{\mREL}}{right=of a1}
      \sync{a1}{a2}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \sync{a2}{a3}
      \event{b1}{\DR{y}{1}}{right=3em of a3}
      \event{b2}{\DFS{\mACQ}}{right=of b1}
      \sync{b1}{b2}
      \event{b3}{\DR{x}{0}}{right=of b2}
      \sync{b2}{b3}
      \rf{a3}{b1}
      \wk[out=-170,in=-10]{b3}{a1}
    \end{tikzinline}}
\end{gather*}

\cite[\textsection{}D]{DBLP:journals/pacmpl/PodkopaevLV19}:
The following execution graph is not consistent in the promise-free
declarative model of [Kang et al. 2017]. Nevertheless, its mapping to POWER
(obtained by simply replacing Fsc with Fsync) is POWER-consistent and ${\rpox}\cup {\rrf}$
is acyclic (so it is Strong-POWER-consistent). Note that, using promises, the
promising semantics allows this behavior.
\begin{gather*}  
  \PR{z}{r}\SEMI
  \FENCE{\mSC}\SEMI
  \PW{x}{1}
  \PAR
  \PW{x}{2}\SEMI
  \FENCE{\mSC}\SEMI
  \PW{y}{1}
  \PAR
  \PR{y}{r}\SEMI
  \PW{z}{1}
  \\[-1ex]
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{a1}{\DR{z}{1}}{}
      \event{a2}{\DFS{\mSC}}{right=of a1}
      \sync{a1}{a2}
      \event{a3}{\DW{x}{1}}{right=of a2}
      \sync{a2}{a3}
      \event{b1}{\DW{x}{2}}{right=3em of a3}
      \event{b2}{\DFS{\mSC}}{right=of b1}
      \sync{b1}{b2}
      \event{b3}{\DW{y}{1}}{right=of b2}
      \sync{b2}{b3}
      \event{c1}{\DR{y}{1}}{right=3em of b3}
      \event{c2}{\DW{z}{1}}{right=of c1}
      %\sync{c1}{c2}
      \wk{a3}{b1}
      \rf{b3}{c1}
      \rf[out=-170,in=-10]{c2}{a1}
      \sync[out=10,in=170]{a2}{b2}
    \end{tikzinline}}
\end{gather*}
Allowed behavior on POWER...
Is there a dependency in the last thread?
If so, this is a problem.

\cite[\textsection{}8]{DBLP:journals/pacmpl/PodkopaevLV19}:
To establish the correctness of compilation of the promising semantics to
POWER, Kang et al. [2017] followed the approach of Lahav and Vafeiadis
[2016]. This approach reduces compilation correctness to POWER to (i) the
correctness of compilation to the POWER model strengthened with ${\rpox}\cup {\rrf}$
acyclicity; and (ii) the soundness of local reorderings of memory
accesses. To establish (i), Kang et al. [2017] wrongly argued that the
strengthened POWER-consistency of mapped promise-free execution graphs imply
the promise-free consistency of the source execution graphs. This is not the
case due to SC fences, which have relatively strong semantics in the
promise-free declarative model (see [Podkopaev et al. 2018, Appendix D] for a
counter example). Nevertheless, our proof shows that the compilation claim of
Kang et al. [2017] is correct.



\subsection{RMWs}
If \RMW{}s simply use the same semantics as read and write, then we allow
\ref{LDRF-PF-Fail}, which is used to show failure of $\ldrfsc{}$ for the
promising semantics in \cite{promising-ldrf}.
\begin{gather*}  
  \taglabel{LDRF-PF-Fail}
  \begin{gathered}
    \PW{y}{0}\SEMI
    \IF{y}\THEN
    \IF{\BANG\PCAS{x}{}{0}{1}}\THEN
    \IF{z}\THEN
    \PW{x}{2}
    \FI\FI\FI
    \PAR
    \PW{y}{1}\SEMI
    \IF{1{\neq}\PCAS{x}{}{0}{3}}\THEN
    \PW{z}{1}
    \FI
    \\
    \hbox{\begin{tikzinline}[node distance=2em]
        \event{a1}{\DW{y}{0}}{}
        \event{a2}{\DR{y}{1}}{right=of a1}
        \event{a3}{\DR{x}{0}}{right=of a2}
        \event{a4}{\DW{x}{1}}{right=of a3}
        \event{a5}{\DR{z}{1}}{right=of a4}
        \event{a6}{\DW{x}{2}}{right=of a5}
        \event{b1}{\DW{y}{1}}{right=5em of a6}
        \event{b2}{\DR{x}{2}}{right=of b1}
        \event{b3}{\DW{z}{1}}{right=of b2}
        \wk{a1}{a2}
        \rmw{a3}{a4}
        \po[out=10,in=170]{a2}{a6}
        % \po[out=15,in=165]{a3}{a6}
        \po{a5}{a6}
        \wk[out=20,in=160]{a4}{a6}
        % \po{b2}{b3}
        \rf[out=15,in=165]{a6}{b2}
        \rf[out=-170,in=-10]{b3}{a5}
        \rf[out=-170,in=-10]{b1}{a2}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
To disallow this, we need to retain the dependency
\begin{math}
  \DRP{x}{2}\xpo \DWP{z}{1}.
\end{math}
For this, we need to avoid the substitution for $x$.  This is why we use
$\sLOADP{}{}$ instead of $\sLOAD{}{}$ in the independent case for \RMW{}s.

\begin{comment}
  \centering  
\begin{verbatim}
Y := 0                   Y := 1                 
a := Y                   d := CAS(X,0,1) /37?   
if a != 0 then           if d != 42 then        
  b := CAS(X,0,42)         L := 1               
  if b = 0 then
    c := L
    if c = 1 then
      Xsrlx := 37
\end{verbatim}
  \includegraphics[width=.8\textwidth]{LDRF-PF-Fail.png}
  \caption{LDRF-PF-Fail}
\end{comment}

It is not possible for two \RMW{}s to see the same write.
\begin{gather*}
  \begin{gathered}
    \PW{x}{0} \SEMI \bigl(\PFADD[\mRLX][\mRLX]{x}{}{1} \PAR \PFADD[\mRLX][\mRLX]{x}{}{1}\bigr)
    \\
    \hbox{\begin{tikzinline}[node distance=2em]
        \event{a0}{\DW{x}{0}}{}
        \event{a1}{\DR{x}{0}}{right=3em of a0}
        \event{a2}{\DW{x}{1}}{right=of a1}
        \event{b1}{\DR{x}{0}}{right=3em of a2}
        \event{b2}{\DW{x}{1}}{right=of b1}
        \rmw{a1}{a2}
        \rf{a0}{a1}
        \rf[out=15,in=165]{a0}{b1}
        \wk[out=15,in=165]{a1}{b2}
        \wk[out=-15,in=-165]{b1}{a2}
        \graywk{a2}{b1}
        \rmw{b1}{b2}
      \end{tikzinline}}
  \end{gathered}
  \taglabel{rmw0}
\end{gather*}
The gray arrow is required the \RMW{} atomicity axioms.

\citet{DBLP:conf/pldi/LeeCPCHLV20} introduce \PS{2.0} to refine the treatment of
\RMW{}s in the promising semantics (\PS{}).  Their examples have the expected
results here, with far less work.  First they recall that \PS{} requires
quantification over multiple futures in order to disallow executions such as
\ref{CDRF}.  (We showed the relaxed variant \eqref{CDRF-RLX} in \textsection\ref{sec:rmw}.)
\begin{gather*}
  \taglabel{CDRF}
  \begin{gathered}
    \PFADD[\mACQ][\mREL]{x}{r}{1}\SEMI \IF{r{=}0}\THEN \PW{y}{1} \FI
    \PAR
    \PFADD[\mACQ][\mREL]{x}{r}{1}\SEMI \IF{r{=}0}\THEN \IF{y}\THEN \PW{x}{0} \FI \FI
    \\
    \hbox{\begin{tikzinline}[node distance=2em]
        \event{a1}{\DR[\mACQ]{x}{0}}{}
        \event{a1b}{\DW[\mREL]{x}{1}}{below=1em of a1}
        \event{a2}{\DW{y}{1}}{right=of a1}
        \event{b0}{\DR[\mACQ]{x}{0}}{right=3em of a2}
        \event{b0b}{\DW[\mREL]{x}{1}}{below=1em of b0}
        \event{b1}{\DR{y}{1}}{right=of b0}
        \event{b2}{\DW{x}{0}}{right=of b1}
        \rmw{a1}{a1b}
        \rmw{b0}{b0b}
        \rf[out=13,in=163]{a2}{b1}
        \po{a1}{a2}
        \sync{b0}{b1}
        \po{b1}{b2}
        \rf[out=-165,in=-12]{b2}{a1}
      \end{tikzinline}}
    \\
    \hbox{\begin{tikzinline}[node distance=1.5em]
        \event{i}{\DW{x}{0}}{}
        \event{b0}{\DR[\mACQ]{x}{0}}{right=3em of i}
        \event{b0b}{\DW[\mREL]{x}{1}}{right=of b0}
        \event{b1}{\DR{y}{1}}{right=of b0b}
        \event{b2}{\DW{x}{0}}{right=of b1}
        \event{a1}{\DR[\mACQ]{x}{0}}{right=3em of b2}
        \event{a1b}{\DW[\mREL]{x}{1}}{right=of a1}
        \event{a2}{\DW{y}{1}}{right=of a1b}
        \rmw{a1}{a1b}
        \rmw{b0}{b0b}
        \rf{i}{b0}
        \rf[out=-165,in=-12]{a2}{b1}
        \wki[out=20,in=160]{b0b}{b2}
        % \sync{a1}{a2}
        % \sync{b0}{b1}
        \po{b1}{b2}
        \rf{b2}{a1}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
This execution is clearly impossible, due to the cycle above.  In this
diagram, we have not drawn order adjacent to the writes of the \RMW{}s, since
this is not necessary to produce the cycle.
If \ref{CDRF} is allowed then \drfra{} fails.



\PS{} does not support global value range analysis, as modeled by \ref{GA+E} below.  Our
semantics permits \ref{GA+E}:
\begin{gather*}
  \taglabel{GA+E}
  \begin{gathered}
    \PW{x}{0} \SEMI
    \bigl(
    \PCAS[\mRLX][\mRLX]{x}{r}{0}{1}\SEMI \IF{r{<}10}\THEN \PW{y}{1} \FI
    \PAR
    \PW{x}{42}\SEMI \PW{x}{\PR{y}{}}
    \bigr)
    \\
    \hbox{\begin{tikzinline}[node distance=2em]
        \event{a0}{\DW{x}{0}}{}
        \event{a1}{\DR{x}{1}}{right=3em of a0}
        \event{a2}{0{<}10\bigmid\DW{y}{1}}{right=of a1}
        \event{b0}{\DW{x}{42}}{right=3em of a2}
        \event{b1}{\DR{y}{1}}{right=of b0}
        \event{b2}{\DW{x}{1}}{right=of b1}
        % \rmw{a1}{a2}
        \rf[out=15,in=160]{a2}{b1}
        \po{b1}{b2}
        \rf[out=-165,in=-15]{b2}{a1}
        \wk[out=10,in=170]{a0}{b0}
        \wk[out=15,in=165]{b0}{b2}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
\PS{} also does not support register promotion, as modeled by \ref{RP} below.    Our
semantics permits \ref{RP}:
\begin{gather*}
  \taglabel{RP}
  \begin{gathered}
    \PR{x}{r}\SEMI
    \PFADD[\mRLX][\mRLX]{z}{s}{r}\SEMI \PW{y}{s{+}1}
    \PAR
    \PW{x}{\PR{y}{}}
    \\
    \hbox{\begin{tikzinline}[node distance=2em]
        \event{a0}{\DR{x}{1}}{}
        \event{a1}{\DR{z}{0}}{right=of a0}
        \event{a1b}{\DW{z}{1}}{right=of a1}
        \event{a2}{\DW{y}{1}}{right=of a1b}
        \event{b0}{\DR{y}{1}}{right=3em of a2}
        \event{b1}{\DW{x}{1}}{right=of b0}
        \rmw{a1}{a1b}
        \po[out=20,in=160]{a0}{a1b}
        \po[out=20,in=160]{a1}{a2}
        \po{b0}{b1}
        \rf{a2}{b0}
        \rf[out=-165,in=-15]{b1}{a0}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}



\begin{example}
  Recall \ref{pom-rmw-atomic}:
  if $\labeling(\cEv) \roverlaps \labeling(\bEv)$ and $\bEv \xrmw \aEv$ then
  \begin{enumerate*}        
  \item \label{pom-rmw-atomic1}
    $\cEv\lt \aEv$ implies $\cEv\le \bEv$ and
  \item \label{pom-rmw-atomic2}
    $\bEv\lt \cEv$ implies $\aEv\le \cEv$.
  \end{enumerate*}

  This definition ensures atomicity, disallowing executions such as
  \cite[Ex.~3.2]{DBLP:journals/pacmpl/PodkopaevLV19}:
  \begin{gather*}
    % \taglabel{RMW1}
    \begin{gathered}
      \PW{x}{0}\SEMI \PINC[\mRLX][\mRLX]{x}{}
      \PAR
      \PW{x}{2}\SEMI \PR{x}{r}
      % \\
      % \hbox{\begin{tikzinline}[node distance=1.5em]
      %   \event{a2}{\DR{x}{0}}{}
      %   \event{a1}{\DW{x}{0}}{left=of a2}
      %   \rf{a1}{a2}
      %   \event{a3}{\DW{x}{2}}{right=of a2}
      %   \wk{a2}{a3}
      %   \event{b2}{\DW{x}{1}}{right=of a3}
      %   \event{b3}{\DR{x}{1}}{right=of b2}
      %   \rmw[out=-15,in=-165]{a2}[below]{b2}
      %   \wk{a3}{b2}
      %   \rf{b2}{b3}
      %   \liftrmw[out=165,in=15]{a3}{a2}
      % \end{tikzinline}}
      \\
      \hbox{\begin{tikzinline}[node distance=1.5em]
          \event{a2}{\DR{x}{0}}{}
          \event{a1}{\DW{x}{0}}{left=of a2}
          \rf{a1}{a2}
          \event{a3}{\DW{x}{1}}{right=of a2}
          \event{b2}{\DW{x}{2}}{right=3em of a3}
          \event{b3}{\DR{x}{1}}{right=of b2}
          \rmw{a2}[below]{a3}
          \wk{b2}{a3}
          \wk[out=15,in=165]{a2}{b2}
          \rf[out=15,in=165]{a3}{b3}
          \liftrmw[out=-165,in=-15]{b2}{a2}
        \end{tikzinline}}
    \end{gathered}
  \end{gather*}
  By \ref{pom-rmw-atomic1}, since $\DWP{x}{2}\xwk\DWP{x}{1}$, it must be that
  $\DWP{x}{2}\xwk\DRP{x}{0}$, creating a cycle.
\end{example}

\begin{example}
  \label{ex:rmw-33}
  Two successful \RMW{}s cannot see the same write:
  \begin{gather*}
    \begin{gathered}
      \PW{x}{0}\SEMI (\PINC[\mRLX][\mRLX]{x}{} \PAR \PINC[\mRLX][\mRLX]{x}{})
      \\
      \hbox{\begin{tikzinline}[node distance=1.5em]
          \event{i}{\DW{x}{0}}{}
          \event{a1}{a{:}\DR{x}{0}}{right=3em of i}
          \event{a2}{b{:}\DW{x}{1}}{right=of a1}
          \event{b1}{c{:}\DR{x}{0}}{right=3em of a2}
          \event{b2}{d{:}\DW{x}{1}}{right=of b1}
          \rmw{a1}{a2}
          \rmw{b1}{b2}
          \rf{i}{a1}
          \rf[out=15,in=165]{i}{b1}
          \wk[out=15,in=165]{a1}{b2}
          \liftrmw[out=15,in=165]{a2}{b1}
          % \wk{a1}{b2}
          \wk{b1}{a2}
        \end{tikzinline}}
    \end{gathered}
  \end{gather*}
  The order from read-to-write is required by fulfillment.  
  Apply \ref{pom-rmw-atomic1} of the second \RMW{} to $a\xwk d$, we have that $a\xwk c$.  Subsequently
  applying \ref{pom-rmw-atomic2} of the first \RMW{}, we have $b \xwk c$, creating a cycle.
\end{example}

\begin{example}
  By using two actions rather than one, the definition allows examples such as the
  following, which is allowed by \armeight{} 
  \cite[Ex.~3.10]{DBLP:journals/pacmpl/PodkopaevLV19}:
  \begin{gather*}
    % \taglabel{RMW2}
    \begin{gathered}
      \PR{z}{r}\SEMI
      % \PW{x}{0}\SEMI
      \PINC[\mRLX][\mREL]{x}{s} \SEMI
      \PW{y}{s}{+}1
      \PAR
      \PR{y}{r}\SEMI
      \PW{z}{r}
      \\[-1ex]
      \hbox{\begin{tikzinline}[node distance=1.5em]
          \event{b1}{\DR{z}{1}}{}
          % \event{b2}{\DW{x}{0}}{right=of b1}
          \event{b3}{\DR{x}{0}}{right=of b1}
          % \rf{b2}{b3}
          \event{b4}{\DWRel{x}{1}}{right=2em of b3}
          \rmw{b3}{b4}
          \event{b5}{\DW{y}{1}}{right=of b4}
          \sync[out=20,in=160]{b1}{b4}
          \po[out=20,in=160]{b3}{b5}
          \event{a1}{\DR{y}{1}}{right=3em of b5}
          \event{a2}{\DW{z}{1}}{right=of a1}
          \po{a1}{a2}
          \rf{b5}{a1}
          \rf[out=-170,in=-10]{a2}{b1}
        \end{tikzinline}}
    \end{gathered}
  \end{gather*}
  A similar example, also allowed by \armeight{}
  \cite[Fig.~6]{DBLP:journals/pacmpl/ChakrabortyV19}:
  \begin{gather*}
    % \taglabel{RMW2}
    \begin{gathered}
      \PR{z}{r}\SEMI
      % \PW{x}{0}\SEMI
      \PFADD[\mRLX][\mRLX]{x}{s}{r} \SEMI
      \PW{y}{s}{+}1
      \PAR
      \PR{y}{r}\SEMI
      \PW{z}{r}
      \\[-1ex]
      \hbox{\begin{tikzinline}[node distance=1.5em]
          \event{b1}{\DR{z}{1}}{}
          % \event{b2}{\DW{x}{0}}{right=of b1}
          \event{b3}{\DR{x}{0}}{right=of b1}
          % \rf{b2}{b3}
          \event{b4}{\DW{x}{1}}{right=2em of b3}
          \rmw{b3}{b4}
          \event{b5}{\DW{y}{1}}{right=of b4}
          \po[out=20,in=160]{b1}{b4}
          \po[out=20,in=160]{b3}{b5}
          \event{a1}{\DR{y}{1}}{right=3em of b5}
          \event{a2}{\DW{z}{1}}{right=of a1}
          \po{a1}{a2}
          \rf{b5}{a1}
          \rf[out=-170,in=-10]{a2}{b1}
        \end{tikzinline}}
    \end{gathered}
  \end{gather*}
\end{example}
This is allowed by \weakestmo{}, but not \PS{}.

\begin{example}
  Consider the \textsc{cdrf} example from \cite{DBLP:conf/pldi/LeeCPCHLV20}:
  \begin{gather*}
    \begin{gathered}
      \begin{aligned}
        &\PINC[\mACQ][\mREL]{x}{r}\SEMI \IF{r{=}0}\THEN \PW{y}{1} \FI
        \\\PAR\;\;&
        \PINC[\mACQ][\mREL]{x}{r}\SEMI \IF{r{=}0}\THEN \IF{y}\THEN \PW{x}{0} \FI \FI
      \end{aligned}
      \\
      \hbox{\footnotesize\begin{tikzinline}[node distance=1.5em]
          \raevent{a1}{\DR[\mACQ]{x}{0}}{}
          \raevent{a1b}{\DW[\mREL]{x}{1}}{right=of a1}
          \event{a2}{\DW{y}{1}}{right=of a1b}
          \raevent{b0}{\DR[\mACQ]{x}{0}}{right=3em of a2}
          \raevent{b0b}{\DW[\mREL]{x}{1}}{right=of b0}
          \event{b1}{\DR{y}{1}}{right=of b0b}
          \event{b2}{\DW{x}{0}}{right=of b1}
          \rmw{a1}{a1b}
          \rmw{b0}{b0b}
          \rf[out=13,in=163]{a2}{b1}
          \sync[out=20,in=160]{a1}{a2}
          \sync[out=20,in=160]{b0}{b1}
          \po{b1}{b2}
          \rf[out=-165,in=-12]{b2}{a1}
        \end{tikzinline}}
    \end{gathered}
  \end{gather*}
\end{example}

\begin{example}
  Consider this example from \cite[\textsection C]{DBLP:conf/pldi/LeeCPCHLV20}:
  \begin{gather*}
    \begin{gathered}
      \begin{aligned}
        &\PCAS[\mRLX][\mRLX]{x}{r}{0}{1}\SEMI \IF{r{\leq}1}\THEN \PW{y}{1} \FI
        \\\PAR\;\;&
        \PCAS[\mRLX][\mRLX]{x}{r}{0}{2}\SEMI \IF{r{=}0}\THEN \IF{y}\THEN \PW{x}{0} \FI \FI
      \end{aligned}
      \\
      \hbox{\footnotesize\begin{tikzinline}[node distance=1.5em]
          \event{a1}{\DR{x}{0}}{}
          \event{a1b}{\DW{x}{1}}{right=of a1}
          \event{a2}{\DW{y}{1}}{right=of a1b}
          \event{b0}{\DR{x}{0}}{right=3em of a2}
          \event{b0b}{\DW{x}{2}}{right=of b0}
          \event{b1}{\DR{y}{1}}{right=of b0b}
          \event{b2}{\DW{x}{0}}{right=of b1}
          \rmw{a1}{a1b}
          \rmw{b0}{b0b}
          \rf[out=13,in=163]{a2}{b1}
          \po[out=20,in=160]{a1}{a2}
          \po[out=20,in=160]{b0}{b1}
          \po{b1}{b2}
          \rf[out=-165,in=-12]{b2}{a1}
        \end{tikzinline}}
    \end{gathered}
  \end{gather*}
\end{example}

\subsection{More RMW}
These following examples are from \cite{promising-ldrf}.

\ref{CDRF} shows that \PwT{} semantics is not too permissive for $\mRA$-\RMW{}s.
But what about $\mRLX$-\RMW{}s.  The following execution is allowed by \armeight,
and \PS{2.0}, but disallowed by \PS{2.1}.
\begin{gather*}
  \taglabel{RMW-W}
  \begin{gathered}
    \PFADD[\mRLX][\mRLX]{x}{r}{1}\SEMI \PW{y}{1}
    \PAR
    \PR{y}{r}\SEMI \PFADD[\mRLX][\mRLX]{x}{s}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=2em]
        \event{a1}{\DR{x}{1}}{}
        \event{a1b}{\DW{x}{2}}{below=1em of a1}
        \event{a2}{\DW{y}{1}}{right=of a1}
        \event{b1}{\DR{y}{1}}{right=3em of a2}
        \event{b2}{\DR{x}{0}}{right=of b1}
        \event{b2b}{\DW{x}{1}}{below=1em of b2}
        \rmw{a1}{a1b}
        \rmw{b2}{b2b}
        \rf{a2}{b1}
        \po{b1}{b2b}
        \rf[out=-175,in=-20]{b2b}{a1}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}

If this $\ldrfra{z}$?
\begin{gather*}
  \taglabel{Naive-LDRF-RA-Fail}
  \begin{gathered}
    \IF{y}\THEN \PW{x}{\PR{z}{}} \ELSE \PW{x}{1} \FI
    \PAR
    \PR{x}{r}\SEMI \PW{z}{1}\SEMI \PW{y}{r}
    \\
    \hbox{\begin{tikzinline}[node distance=2em]
        \event{a1}{\DR{y}{1}}{}
        \event{a2}{\DR{z}{1}}{right=of a1}
        \event{a3}{\DW{x}{1}}{right=of a2}
        \event{b1}{\DR{x}{1}}{right=3em of a3}
        \event{b2}{\DW{z}{1}}{right=of b1}
        \event{b3}{\DW{y}{1}}{right=of b2}
        \po{a2}{a3}
        \po[in=165,out=15]{b1}{b3}
        \rf[out=-165,in=-15]{b2}{a2}
        \rf[out=-165,in=-15]{b3}{a1}
        \rf{a3}{b1}
      \end{tikzinline}}
  \end{gathered}
  \intertext{Interpreting $\{z\}$ as $\mRA$:}
  \\
  \begin{gathered}
    \hbox{\begin{tikzinline}[node distance=2em]
        \event{a1}{\DR{y}{1}}{}
        \event{a2}{\DR[\mACQ]{z}{1}}{right=of a1}
        \event{a3}{\DW{x}{1}}{right=of a2}
        \event{b1}{\DR{x}{1}}{right=3em of a3}
        \event{b2}{\DW[\mREL]{z}{1}}{right=of b1}
        \event{b3}{\DW{y}{1}}{right=of b2}
        \po{a2}{a3}
        \po[in=165,out=15]{b1}{b3}
        \rf[out=-165,in=-15]{b2}{a2}
        \rf[out=-165,in=-15]{b3}{a1}
        \rf{a3}{b1}
        \sync{a1}{a2}
        \sync{b2}{b3}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}


% \begin{comment}
%   \centering  
% \begin{verbatim}
% a := X                  b := Z                 
% if a = 1 then           if b = 0 then          
% _ := FADD(W , 1)        X := 1               
% Y := 1                else                   
% Z := 1                  c := FADD(W, 1) /0   
% if c = 0 then        
% d := Y             
% X := d             
% \end{verbatim}
%   \includegraphics[width=\textwidth]{LDRF-Fail-PS}
%   \caption{LDRF-Fail-PS}
% \end{comment}



\subsection{Fences and RMW}
\todo{Discuss.}

\cite[Remark 2, After example 3.1]{DBLP:journals/pacmpl/PodkopaevLV19}: Aim:
allow the splitting of release writes and RMWs into release fences followed
by relaxed operations.  In RC11 [Lahav et al. 2017], as well as in C/C++11
[Batty et al. 2011], this rather intuitive transformation, as we found out,
is actually unsound.
\begin{gather*}
  \PW{y}{1}\SEMI
  \PW[\mRA]{x}{1}
  \PAR
  \PINC[\mRA][\mRA]{x}{}\SEMI
  \PW{x}{3}
  \PAR
  \PR[\mACQ]{x}{r} \SEMI %3
  \PR{y}{s} %0
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DW{y}{1}}{}
      \event{a2}{\DWRel{x}{1}}{right=of a1}
      \sync{a1}{a2}
      \event{b1}{\DRAcq{x}{1}}{right=2em of a2}
      \event{b2}{\DWRel{x}{2}}{right=1.5em of b1}
      \rmw{b1}{b2}
      \event{b3}{\DW{x}{3}}{right=of b2}
      \wkx{b2}{b3}
      \event{c1}{\DRAcq{x}{3}}{right=2em of b3}
      \event{c2}{\DR{y}{0}}{right=of c1}
      \sync{c1}{c2}
      \rf{b3}{c1}
      \rf{a2}{b1}
      \wky[out=-170,in=-10]{c2}{a1}
      \sync[out=15,in=165]{b1}{b3}
   \end{tikzinline}}
\end{gather*}
(R)C11 disallows the annotated behavior, due in particular to the release sequence formed from the
release exclusive write to x in the second thread to its subsequent relaxed write. However, if we
split the increment to fencerel; a := FADDacq,rlx(x, 1) (which intuitively may seem stronger), the
release sequence will no longer exist, and the annotated behavior will be allowed. IMM overcomes
this problem by strengthening sw in a way that ensures a synchronization edge for the transformed
program as well
\begin{gather*}
  \PW{y}{1}\SEMI
  \PW[\mRA]{x}{1}
  \PAR
  \FENCE{\mREL}\SEMI
  \PINC[\mRA][\mRLX]{x}{}\SEMI
  \PW{x}{3}
  \PAR
  \PR[\mACQ]{x}{r} \SEMI %3
  \PR{y}{s} %0
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DW{y}{1}}{}
      \event{a2}{\DWRel{x}{1}}{right=of a1}
      \sync{a1}{a2}
      \event{b0}{\DFS{\mREL}}{right=2em of a2}
      \event{b1}{\DRAcq{x}{1}}{right=of b0}
      \event{b2}{\DW{x}{2}}{right=1.5em of b1}
      \rmw{b1}{b2}
      \event{b3}{\DW{x}{3}}{right=of b2}
      \wkx{b2}{b3}
      \event{c1}{\DRAcq{x}{3}}{right=2em of b3}
      \event{c2}{\DR{y}{0}}{right=of c1}
      \sync{c1}{c2}
      \rf{b3}{c1}
      \rf[out=15,in=165]{a2}{b1}
      \sync[out=15,in=165]{b0}{b2}
      \wky[out=-170,in=-10]{c2}{a1}
      \sync[out=15,in=165]{b1}{b3}
      \sync[out=20,in=160]{b0}{b3}
   \end{tikzinline}}
\end{gather*}

We seem to disallow both of these out of the box.

In the case of a relaxed read in the RMW, the outcome is allowed in both
cases:
\begin{gather*}
  \PW{y}{1}\SEMI
  \PW[\mRA]{x}{1}
  \PAR
  \PINC[\mRLX][\mRA]{x}{}\SEMI
  \PW{x}{3}
  \PAR
  \PR[\mACQ]{x}{r} \SEMI %3
  \PR{y}{s} %0
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DW{y}{1}}{}
      \event{a2}{\DWRel{x}{1}}{right=of a1}
      \sync{a1}{a2}
      \event{b1}{\DR{x}{1}}{right=2em of a2}
      \event{b2}{\DWRel{x}{2}}{right=1.5em of b1}
      \rmw{b1}{b2}
      \event{b3}{\DW{x}{3}}{right=of b2}
      \wkx{b2}{b3}
      \event{c1}{\DRAcq{x}{3}}{right=2em of b3}
      \event{c2}{\DR{y}{0}}{right=of c1}
      \sync{c1}{c2}
      \rf{b3}{c1}
      \rf{a2}{b1}
      \wky[out=-170,in=-10]{c2}{a1}
      %\sync[out=-15,in=-165]{b1}{b3}
      %\wkx[out=-15,in=-165]{b1}{b3}
   \end{tikzinline}}
\end{gather*}
\begin{gather*}
  \PW{y}{1}\SEMI
  \PW[\mRA]{x}{1}
  \PAR
  \FENCE{\mREL}\SEMI
  \PINC[\mRLX][\mRLX]{x}{}\SEMI
  \PW{x}{3}
  \PAR
  \PR[\mACQ]{x}{r} \SEMI %3
  \PR{y}{s} %0
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DW{y}{1}}{}
      \event{a2}{\DWRel{x}{1}}{right=of a1}
      \sync{a1}{a2}
      \event{b0}{\DFS{\mREL}}{right=2em of a2}
      \event{b1}{\DR{x}{1}}{right=of b0}
      \event{b2}{\DW{x}{2}}{right=1.5em of b1}
      \rmw{b1}{b2}
      \event{b3}{\DW{x}{3}}{right=of b2}
      \wkx{b2}{b3}
      \event{c1}{\DRAcq{x}{3}}{right=2em of b3}
      \event{c2}{\DR{y}{0}}{right=of c1}
      \sync{c1}{c2}
      \rf{b3}{c1}
      \rf[out=15,in=165]{a2}{b1}
      \sync[out=15,in=165]{b0}{b2}
      \wky[out=-170,in=-10]{c2}{a1}
      %\sync[out=-15,in=-165]{b1}{b3}
      \sync[out=20,in=160]{b0}{b3}
      %\wkx[out=-15,in=-165]{b1}{b3}
   \end{tikzinline}}
\end{gather*}

% \endinput
\section{Not for publication}

\subsection{Recent discussion on JMM/JDK-dev}

\href{https://mail.openjdk.java.net/pipermail/jdk-dev/2021-August/005904.html}{Raffaello Giulietti}:
``JEP 188: Java Memory Model Update'' \href{https://openjdk.java.net/jeps/188}{[1]}, the JMM wiki \href{https://wiki.openjdk.java.net/display/jmm/Main}{[2]} and the 
jmm-dev mailing list \href{https://mail.openjdk.java.net/pipermail/jmm-dev/}{[3]} seem quite inactive. (The latter point explains 
why I'm posting to this list instead.)

The introduction of \texttt{j.l.i.VarHandle} \href{https://docs.oracle.com/en/java/javase/16/docs/api/java.base/java/lang/invoke/VarHandle.html}{[4]} brought more access modes to 
Java, but in a narrative and informal way. A paper by Bender \& Palsberg 
\href{https://dl.acm.org/doi/10.1145/3360568}{[5]}, addressing the formalization of the concurrent access modes, has 
been published in 2019 but I'm not sure if it caught the attention of 
the OpenJDK community.

So what is the current thinking for progressing the JMM spec?

\bigskip

\href{https://mail.openjdk.java.net/pipermail/jdk-dev/2021-August/005909.html}{Hans Boehm}:
I think it's safe to say that it has been slow going, not just for Java,
but for other languages as well.

In my view, the core problem, shared by pretty much all of them, is that we
don't have an established way to give well-defined semantics to potentially
racing unordered accesses, like ordinary variable accesses in Java, or
memory\_order\_relaxed accesses in C and C++. That's particularly essential
with the traditional Java language-based-security model, since we can't
just give up on racing accesses to ordinary variables.

I'm aware of a number of proposed solutions. But I don't think we currently
have enough confidence that they
\begin{itemize}
\item Are correct, and don't have issues similar to the older models,
\item Don't have unintended consequences, particularly for compilation, and
\item Are sufficiently comprehensible by programmers to actually be useful.
\end{itemize}
[Correctness] is hard because the models have gotten complex enough that reviewers
are scarce. (A problem that I gather you're familiar with.) The authors are
commonly experts at formally analyzing the models, but it's hard to analyze
whether the model conflicts with some well-known, but perhaps not
well-written-down compilation technique.

Probably even more controversially, I think we've realized that existing
compiler technology can compile such racing code in ways that some of us are
not 100\% sure should really be allowed. Demonstrably unexecuted code can
affect the semantics in ways that strike me as scary. (See
\url{https://wg21.link/p1217} for a down-to-assembly C++ version; [if I
understand correctly], Lochbihler and others earlier came up with some
closely related observations for Java.)

It might be possible to do what we've involuntarily done for C++: Punt the
hard cases for now, and define what the model is for programs without
racing ordinary accesses.

[p1217 is \cite{BoehmOOTA}.]

\bigskip

\href{https://mail.openjdk.java.net/pipermail/jmm-dev/2021-August/000447.html}{Andrew Haley}:
\begin{verbatim}
> Probably even more controversially, I think we've realized that
> existing compiler technology can compile such racing code in ways
> that some of us are not 100\% sure should really be allowed.
\end{verbatim}
This implies, does it not, that the problem is not formalization as
such, but that we don't really understand what the language is
supposed to mean? That's always been my problem with OOTA: I'm unsure
whether the problem is due to the inadequacy of formal models, in
which case the formalists can fix their own problem, or something we
all have to pay attention to.

\smallskip

\href{https://mail.openjdk.java.net/pipermail/jmm-dev/2021-August/000450.html}{Hans Boehm}:
In some sense, I'm not sure either. The p1217 examples bother me in that
they seem to violate  some global programming rules (``if \texttt{x} is only ever null
or refers to an object properly constructed by the same thread, then \texttt{x}
should never appear to refer to an incompletely constructed object'').
And there seems to be disagreement about whether the currently allowed
behavior is ``correct.''

On the other hand, in practice the weirdness doesn't seem to break things.
If you ask people advocating the current behavior, the answer will be
that it doesn't matter because nobody writes code that way. If you ask
people trying to analyzer or verify code, they'll probably be unhappy.
And I haven't been able to convince myself that you cannot get yourself
into these situations just by linking components together, each of which
does something perfectly reasonable.

And there are very common code
patterns (like the standard implementation of reentrant locks used
by all Java implementations) that break if you allow general OOTA
behavior. Which at least means that you can't currently formally verify such
code. The theorem you'd be trying to prove is false with respect to the
part of the language spec we know how to formalize.

It's a mess.


\bigskip

\href{https://mail.openjdk.java.net/pipermail/jmm-dev/2021-August/000447.html}{Andrew Haley}:
\begin{verbatim}
> Demonstrably unexecuted code can affect the semantics in ways that strike me 
> as scary. (See wg21.link/p1217 for a down-to-assembly C++ version; IIUC, Lochbihler 
> and others earlier came up with some closely related observations for Java.)
\end{verbatim}
Looking again at p1217, it seems to me that enforcing load-store
ordering would have severe effects on compilers, at least without new
optimization techniques. We hoist loads before loops and sink stores
after them. When it all works out, there are no memory accesses in the
loop. A load-store barrier in a loop would have the effect of forcing
succeeding stores out to memory, and forcing preceding loads to reload
from memory. It's not hard to imagine that this would cause an
order-of-margnitude performance reduction in common cases.

I suppose one could argue that such optimizations would continue to be
valid, so only those stores which would have been emitted anyway would
be affected. But that's not how compilers work, as far as I know. In
our IR for C2, memory accesses are not pinned in any way, so the only
way to make unrelated accesses execute in any particular order is to
add a dependency between all loads and stores.

\smallskip

\href{https://mail.openjdk.java.net/pipermail/jmm-dev/2021-August/000450.html}{Hans Boehm}:
I think it would be a fairly pervasive change to optimizers. It has also
become clear in WG21, the C++ committee, that there is not enough
support for requiring this. In that case, Ou and Demsky have a paper
saying that the overhead is likely to be on the order of 1\% or less.
For Java if it were applied everywhere, it would probably be
appreciably higher.

On the other hand, it's a bit harder than that to come up with examples
where
the generated x86 code has to be worse. Moving loads earlier in the
code, or delaying stores, as you suggest, would still be fine. The only
issue is with delaying loads past stores, which seems less common,
though it can certainly be beneficial for reducing live ranges, probably
some
vectorization etc.

But it seems unlikely that such a restriction will be applied even to
C++ memory\_order\_relaxed, much less Java ordinary variables.

\bigskip

\href{https://mail.openjdk.java.net/pipermail/jmm-dev/2021-August/000449.html}{Doug
  Lea}:
My stance in the less formal account 
(\url{http://gee.cs.oswego.edu/dl/html/j9mm.html}) as well as Shuyang Liu et 
al's ongoing formalization (see links from 
\url{http://compilers.cs.ucla.edu/people/}) is that the most you want to say 
about racy Java programs is that they are typesafe. As in: you can't see 
a String when expecting an int. Even this looser constraint is 
challenging to specify, prove, and extend. But it is a path for Java 
that might not apply to languages like C that are not guaranteed 
typesafe anyway, and so enter Undefined Behavior territory (as opposed 
to possibly-unexpected but still typesafe behavior).

\smallskip

\href{https://mail.openjdk.java.net/pipermail/jmm-dev/2021-August/000451.html}{Han Boehm}:
But this now breaks some common idioms, right? In particular, I think a
bunch of
code assumes that racing assignments of equivalent primitive values or
immutable
objects to the same field are OK.

If, in 2004, our view of language-based security had been the same as it is
now,
then I completely agree that this would have been the right approach. But I
think
doing it now would require significant user code changes. Which might still
be the best way forward ...



\subsection{A Note on Mixed-Mode Data Races}

In preparing this paper, we came across the following example, which appears
to invalidate Theorem 4.1 of \cite{DBLP:conf/ppopp/DongolJR19}.
\begin{gather}
  \nonumber
  \PW{x}{1}\SEMI
  \PW[\mREL]{y}{1}\SEMI
  \PR[\mACQ]{x}{r}
  \PAR
  \IF{\PR[\mACQ]{y}{}}\THEN \PW[\mREL]{x}{2}\FI
  \\
  \tag{\P}
  \label{mix1}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DW{x}{1}}{}
      \raevent{a2}{\DW[\mREL]{y}{1}}{right=of a1}
      \raevent{a3}{\DR[\mACQ]{x}{1}}{right=of a2}
      \raevent{b1}{\DR[\mACQ]{y}{1}}{right=3em of a3}
      % \raevent{b1}{\DR[\mACQ]{y}{1}}{below=of a1}
      \raevent{b2}{\DW[\mREL]{x}{2}}{right=of b1}
      \sync{a1}{a2}
      \rf[out=20,in=160]{a1}{a3}
      \rf[out=20,in=160]{a2}{b1}
      \wk[out=20,in=160]{a3}{b2}
      \sync{b1}{b2}
      % \node(ai)[left=3em of a1]{};
      % \bgoval[yellow!50]{(ai)}{P}
      % \bgoval[pink!50]{(a1)(a2)(b1)(b2)}{P'\setminus P}
      % \bgoval[green!10]{(a3)}{P'''\setminus P'}
    \end{tikzinline}}
  \\
  \nonumber
  % \label{mix2}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DW{x}{1}}{}
      \raevent{a2}{\DW[\mREL]{y}{1}}{right=of a1}
      \raevent{a3}{\DR[\mACQ]{x}{2}}{right=of a2}
      \raevent{b1}{\DR[\mACQ]{y}{1}}{right=3em of a3}
      \raevent{b2}{\DW[\mREL]{x}{2}}{right=of b1}
      \sync{a1}{a2}
      \rf[out=20,in=160]{a2}{b1}
      \rf[out=-160,in=-20]{b2}{a3}
      \sync{b1}{b2}
    \end{tikzinline}}
\end{gather}
The program is data-race free.  The two executions shown are the only
top-level executions that include $\DWP[\mREL]{x}{2}$.

Theorem 4.1 of \cite{DBLP:conf/ppopp/DongolJR19} is stated by extending
execution sequences.  In the terminology of
\cite{DBLP:conf/ppopp/DongolJR19}, a read is \emph{$L$-weak} if it is
sequentially stale.  Let
\begin{math}
  \rho=\DWP{x}{1}\allowbreak
  \DWP[\mREL]{y}{1}\allowbreak
  \DRP[\mACQ]{y}{1}\allowbreak
  \DWP[\mREL]{x}{2}
\end{math}
be a sequence and
\begin{math}
  \alpha=\DRP[\mACQ]{x}{1}.
\end{math}
$\rho$ is $L$-sequential and $\alpha$ is $L$-weak in $\rho\alpha$.  But there
is no execution of this program that includes a data race, contradicting the
theorem.  The error seems to be in Lemma A.4 of
\cite{DBLP:conf/ppopp/DongolJR19}, which states that if $\alpha$ is $L$-weak
after an $L$-sequential $\rho$, then $\alpha$ must be in a data race.  That
is clearly false here, since $\DRP[\mACQ]{x}{1}$ is stale, but the program is
data race free.

In proving the SC-LDRF result in \cite[\textsection8]{DBLP:journals/pacmpl/JagadeesanJR20}, we noted that our proof
technique is more robust than that of \cite{DBLP:conf/ppopp/DongolJR19},
because it limits the prefixes that must be considered.  In \eqref{mix1}, the
induction hypothesis requires that we add $\DRP[\mACQ]{x}{1}$ before
$\DWP[\mREL]{x}{2}$ since $\DRP[\mACQ]{x}{1}\xwk\DWP[\mREL]{x}{2}$.  In
particular,
\begin{gather*}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DW{x}{1}}{}
      \raevent{a2}{\DW[\mREL]{y}{1}}{right=of a1}
      % \raevent{a3}{\DR[\mACQ]{x}{1}}{right=of a2}
      \raevent{b1}{\DR[\mACQ]{y}{1}}{right=3em of a3}
      % \raevent{b1}{\DR[\mACQ]{y}{1}}{below=of a1}
      \raevent{b2}{\DW[\mREL]{x}{2}}{right=of b1}
      \sync{a1}{a2}
      % \rf[out=20,in=160]{a1}{a3}
      \rf{a2}{b1}
      % \wk[out=20,in=160]{a3}{b2}
      \sync{b1}{b2}
      % \node(ai)[left=3em of a1]{};
      % \bgoval[yellow!50]{(ai)}{P}
      % \bgoval[pink!50]{(a1)(a2)(b1)(b2)}{P'\setminus P}
      % \bgoval[green!10]{(a3)}{P'''\setminus P'}
    \end{tikzinline}}
\end{gather*}
is not a downset of \eqref{mix1}, because
$\DRP[\mACQ]{x}{1}\xwk\DWP[\mREL]{x}{2}$.  As noted in \cite[\textsection8]{DBLP:journals/pacmpl/JagadeesanJR20},
this affects the inductive order in which we move across pomsets, but does
not affect the set of pomsets that are considered.  In particular,
\begin{gather*}
  \hbox{\begin{tikzinline}[node distance=1.5em]
      \event{a1}{\DW{x}{1}}{}
      \raevent{a2}{\DW[\mREL]{y}{1}}{right=of a1}
      % \raevent{a3}{\DR[\mACQ]{x}{1}}{right=of a2}
      \raevent{b1}{\DR[\mACQ]{y}{1}}{right=3em of a3}
      % \raevent{b1}{\DR[\mACQ]{y}{1}}{below=of a1}
      % \raevent{b2}{\DW[\mREL]{x}{2}}{right=of b1}
      \sync{a1}{a2}
      % \rf[out=20,in=160]{a1}{a3}
      \rf{a2}{b1}
      % \wk[out=-20,in=-160]{a3}{b2}
      % \sync{b1}{b2}
      % \node(ai)[left=3em of a1]{};
      % \bgoval[yellow!50]{(ai)}{P}
      % \bgoval[pink!50]{(a1)(a2)(b1)(b2)}{P'\setminus P}
      % \bgoval[green!10]{(a3)}{P'''\setminus P'}
    \end{tikzinline}}
\end{gather*}
is a downset of \eqref{mix1}.


% \clearpage
% \section{Three semantics, repeated}

% \input{fig-addr.tex}
% \input{fig-ca-addr.tex}
% \input{fig-ca.tex}


\section{Old Notes}

\subsection{More optimizations}

\begin{itemize}
\item Sound to strengthen the annotation on an action from $\mRLX$ to
  $\mRA$, and from $\mRA$ to $\mSC$.
\end{itemize}

From \cite{Manson:2005:JMM:1047659.1040336}:
\begin{itemize}
\item synchronization on thread local objects can be ignored or removed
  altogether (the caveat to this is the fact that invocations of methods like
  wait and notify have to obey the correct semantics  for example, even if
  the lock is thread local, it must be acquired when perform- ing a wait),
  
\item volatile fields of thread local objects can be treated as normal
  fields.

\item redundant synchronization (e.g., when a synchronized method is called
  from another synchronized method on the same object) can be ignored or
  removed,
  
\end{itemize}

Counterexample for first two:
\begin{verbatim}
 y=1; x^AR=1; r=X^AR; z=1
\end{verbatim}
If you see $z=1$ you must see $y=1$

It would be nice if we could get at these with a strength reducing result:
synchronization actions can be replaced by relaxed actions in some cases.
Then the rules for relaxed read elimination and relaxed write elimination can
be used to get rid of them.

\subsection{Examples for semicolon semantics}

\begin{itemize}
\item Parallel asymmetric: state result for \emph{joint free} programs. 
\item Subsumption can be allowed on registers only
\item We build substitutions
\item Ignore substitutions when considering semantic equality.
\end{itemize}


Value for $r$ in $(r\EQ1\mid\DW{z}{1})$ from $(\DW{x}{1})$:
\begin{gather*}
  \PW{x}{1} \PAR \PW{x}{1}\SEMI \PR{x}{r} \SEMI \PW{y}{r}\SEMI \PW{z}{r}
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DW{x}{1}}{}
      \event{a2}{\DR{x}{1}}{right=of a1}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \event{a4}{\DW{z}{1}}{right=of a3}
      \po{a2}{a3}
      % \po[out=-15,in=-165]{a1}{a4}
      \event{a0}{\DW{x}{1}}{left=2em of a1}
      \rf[out=15,in=165]{a0}{a2}
    \end{tikzinline}}
\end{gather*}          
Value for $r$ in $(r\EQ1\mid\DW{z}{1})$ from $(\DW{x}{1})$:
\begin{gather*}
  \PW{x}{2} \PAR \PW{x}{1}\SEMI \PR{x}{r} \SEMI \IF{r{>}0}\THEN \PW{y}{1}\FI \SEMI \IF{r{>}0}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DW{x}{1}}{}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \event{a4}{\DW{z}{1}}{right=of a3}
      \po{a2}{a3}
      % \po[out=-15,in=-165]{a1}{a4}
      \event{a0}{\DW{x}{2}}{left=2em of a1}
      \rf[out=15,in=165]{a0}{a2}
    \end{tikzinline}}
\end{gather*}
Note that this also contains pomset where value for $r$ in
$(r\EQ1\mid\DW{y}{1})$ also comes from $(\DW{x}{1})$:
\begin{gather*}
  \PW{x}{2} \PAR \PW{x}{1}\SEMI \PR{x}{r} \SEMI \IF{r{>}0}\THEN \PW{y}{1}\FI \SEMI \IF{r{>}0}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DW{x}{1}}{}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \event{a4}{\DW{z}{1}}{right=of a3}
      % \po{a2}{a3}
      % \po[out=-15,in=-165]{a1}{a4}
      \event{a0}{\DW{x}{2}}{left=2em of a1}
      \rf[out=15,in=165]{a0}{a2}
    \end{tikzinline}}
\end{gather*}
So our semantics will calculate the least ordered version.  Then rely on
augmentation to get the others.
\begin{gather*}
  \begin{gathered}
    \PW{x}{1}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{a}{\DW{x}{1}}{}
        \final{f}{\SUB{1/x}}{below=of a}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \PR{x}{r}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{b}{\DRreg{r}{x}{2}}{}
        \final{f}{\SUB{x/r}}{below=of b}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \IF{r{>}0}\THEN \PW{y}{1}\FI
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{c}{r{>}0 \bigmid \DW{y}{1}}{}
        \final{f}{r{>}0 \bigmid \SUB{1/y}}{below=of c}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \IF{r{>}0}\THEN \PW{z}{1}\FI
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{d}{r{>}0 \bigmid \DW{z}{1}}{}
        \final{f}{r{>}0 \bigmid \SUB{1/z}}{below=of d}
      \end{tikzinline}}
  \end{gathered}
  \\
  \begin{gathered}
    \PW{x}{1}
    \SEMI
    \PR{x}{r}    
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{a}{\DW{x}{1}}{}
        \event{b}{\DRreg{r}{x}{2} \bigmid \SUB{1/x,1/r}}{right=of a}
        \final{f}{\SUB{1/x}}{below=of a}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \IF{r{>}0}\THEN \PW{y}{1}\FI
    \SEMI
    \IF{r{>}0}\THEN \PW{z}{1}\FI
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{c}{r{>}0 \bigmid \DW{y}{1}}{}
        \event{d}{r{>}0 \bigmid \DW{z}{1}}{right=of c}
        \final{f}{r{>}0 \bigmid \SUB{1/y,1/z}}{below=of c}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
It is also possible that the read is necessary to give a value for $r$:
\begin{gather*}
  \PW{x}{2} \PAR \PW{x}{0}\SEMI \PR{x}{r} \SEMI \IF{r{>}0}\THEN \PW{y}{1}\FI \SEMI \IF{r{>}0}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DW{x}{0}}{}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \event{a4}{\DW{z}{1}}{right=of a3}
      \po{a2}{a3}
      \po[out=15,in=165]{a2}{a4}
      \event{a0}{\DW{x}{2}}{left=2em of a1}
      \rf[out=15,in=165]{a0}{a2}
    \end{tikzinline}}
\end{gather*}
\begin{gather*}
  \begin{gathered}
    \PW{x}{0}
    \SEMI
    \PR{x}{r}    
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{a}{\DW{x}{0}}{}
        \event{b}{\DRreg{r}{x}{2} \bigmid \SUB{0/x,0/r}}{right=of a}
        \final{f}{\SUB{0/x}}{below=of a}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \IF{r{>}0}\THEN \PW{y}{1}\FI
    \SEMI
    \IF{r{>}0}\THEN \PW{z}{1}\FI
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{c}{r{>}0 \bigmid \DW{y}{1}}{}
        \event{d}{r{>}0 \bigmid \DW{z}{1}}{right=of c}
        \final{f}{r{>}0 \bigmid \SUB{1/y,1/z}}{below=of c}
      \end{tikzinline}}
  \end{gathered}  
\end{gather*}
Dependency on two reads:
\begin{gather*}
  \PR{x}{r} \SEMI \PR{y}{s}\SEMI \IF{r{<}s}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DRreg{r}{x}{1}}{}
      \event{a2}{\DRreg{s}{y}{2}}{right=of a1}
      \event{a3}{\DW{z}{1}}{right=of a2}
      \po{a2}{a3}
      \po[out=15,in=165]{a1}{a3}
    \end{tikzinline}}
\end{gather*}          
\begin{gather*}
  \begin{gathered}
    \PR{x}{r}\SEMI \PR{y}{s}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{a}{\DRreg{r}{x}{1}}{}
        \event{b}{\DRreg{s}{y}{2}}{right=of a}
        \final{f}{\SUB{x/r,y/s}}{below=of a}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \IF{r{<}s}\THEN \PW{z}{1}\FI
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{c}{r{<}s \bigmid \DW{z}{1}}{}
        \final{f}{r{<}s \bigmid \SUB{1/z}}{below=of c}
      \end{tikzinline}}
  \end{gathered}
  \\
  \begin{gathered}
    \PR{x}{r}\SEMI \PR{y}{s} \SEMI \IF{r{<}s}\THEN \PW{z}{1}\FI
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{a}{\DRreg{r}{x}{1}}{}
        \event{b}{\DRreg{s}{y}{2}}{right=of a}
        \event{c}{x{<}2 \bigmid \DW{z}{1}}{right=1em of b}
        \po{b}{c}
        \final{f}{r{<}s \bigmid \SUB{x/r,y/s,1/z}}{below=of a}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
Don't need to worry about confusing reads:
\begin{gather*}
  \PR{x}{r} \SEMI \PR{x}{s}\SEMI \IF{s{<}0}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DRreg{r}{x}{1}}{}
      \event{a2}{\DRreg{s}{x}{2}}{right=of a1}
      \event{a3}{\DW{z}{1}}{right=of a2}
      \po{a2}{a3}
    \end{tikzinline}}
\end{gather*}          
\begin{gather*}
  \begin{gathered}
    \PR{x}{r}\SEMI \PR{x}{s}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{a}{\DRreg{r}{x}{1}}{}
        \event{b}{\DRreg{s}{x}{2}}{right=of a}
        \final{f}{\SUB{x/r,x/s}}{below=of a}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \PW{z}{s}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{c}{s{<}0 \bigmid \DW{z}{1}}{}
        \final{f}{s{<}0 \bigmid \SUB{1/z}}{below=of c}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
But we also have
\begin{gather*}
  \PR{x}{r} \SEMI \PR{x}{s}\SEMI \IF{s{<}0}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DRreg{r}{x}{1}}{}
      \event{a2}{\DRreg{s}{x}{2}}{right=of a1}
      \event{a3}{\DW{z}{1}}{right=of a2}
      \po[out=15,in=165]{a1}{a3}
    \end{tikzinline}}
\end{gather*}          
\begin{gather*}
  \begin{gathered}
    \PR{x}{r}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{a}{\DRreg{r}{x}{1}}{}
        \final{f}{\SUB{x/r}}{below=of a}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \PR{x}{s} \SEMI \IF{s{<}0}\THEN \PW{z}{1}\FI
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{b}{\DRreg{s}{x}{2}}{}
        \event{c}{x{<}0 \bigmid \DW{z}{1}}{right=of b}
        \final{f}{x{<}0 \bigmid \SUB{x/s,1/z}}{below=of c}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
Dependency on two reads (No dependency here):
\begin{gather*}
  \PR{x}{r} \SEMI \PR{x}{s}\SEMI \IF{r{=}s}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DRreg{r}{x}{1}}{}
      \event{a2}{\DRreg{s}{x}{2}}{right=of a1}
      \event{a3}{\DW{z}{1}}{right=of a2}
      % \po{a2}{a3}
      % \po[out=15,in=165]{a1}{a3}
    \end{tikzinline}}
\end{gather*}          
\begin{gather*}
  \begin{gathered}
    \PR{x}{r}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{a}{\DRreg{r}{x}{1}}{}
        \final{f}{\SUB{x/r}}{below=of a}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \PR{x}{s} \SEMI \IF{r{=}s}\THEN \PW{z}{1}\FI
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{b}{\DRreg{s}{x}{2}}{}
        \event{c}{r{=}x \bigmid \DW{z}{1}}{right=of b}
        \final{f}{r{=}x \bigmid \SUB{x/s,1/z}}{below=of c}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}
Another example:
\begin{gather*}
  \PR{x}{r} \SEMI \PR{x}{s}\SEMI  \PW{z}{s}
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DRreg{r}{x}{1}}{}
      \event{a2}{\DRreg{s}{x}{1}}{right=of a1}
      \event{a3}{\DW{z}{1}}{right=of a2}
      % \po{a2}{a3}
      \po[out=15,in=165]{a1}{a3}
    \end{tikzinline}}
\end{gather*}          
\begin{gather*}
  \begin{gathered}
    \PR{x}{r}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{a}{\DRreg{r}{x}{1}}{}
        \final{f}{\SUB{x/r}}{below=of a}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \PR{x}{s} \SEMI \PW{z}{s}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{b}{\DRreg{s}{x}{1}}{}
        \event{c}{x{=}1 \bigmid \DW{z}{1}}{right=of b}
        \final{f}{x{=}1 \bigmid \SUB{x/s,1/z}}{below=of c}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}

Value for $r$ in $(r{<}s\mid\DW{z}{1})$ from $(\DW{x}{0})$:
\begin{gather*}
  \PW{x}{0}\SEMI \PR{x}{r} \SEMI \PR{y}{s}\SEMI \IF{r{<}s}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DRreg{r}{x}{1}}{}
      \event{a2}{\DRreg{s}{y}{2}}{right=of a1}
      \event{a3}{\DW{z}{1}}{right=of a2}
      \event{a0}{\DW{x}{0}}{left=of a1}
      \po{a2}{a3}
      % \po[out=15,in=165]{a0}{a3}
    \end{tikzinline}}
\end{gather*}          


Contrary to submission, reverse subsumption not okay.
\begin{gather*}
  \begin{gathered}
    \PW{x}{1}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{a}{\DRreg{r}{x}{1}}{}
        \final{f}{\SUB{1/x}}{below=of a}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \PW{x}{2}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{b}{\DRreg{s}{x}{2}}{}
        \final{f}{\SUB{}}{below=of b}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}

\subsection{Playing around with 5a and 4b}
If we do this, then swap 4b and 4c, In definition 2.10, take 1-4b of def 2.8,
rather than all of it.

Another
\begin{gather*}
  \PR{x}{r}
  \SEMI \PR{x}{s}
  \SEMI \IF{r{>}0}\THEN \PW{y}{1}\FI
  \SEMI \IF{s{>}0}\THEN \PW{z}{1}\FI
  \\
  \PR{x}{r}
  \SEMI \IF{r{>}0}\THEN \PW{y}{1}\FI
  \SEMI \PR{x}{s}
  \SEMI \IF{s{>}0}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{a}{\DRreg{r}{x}{1}}{}
      \event{b}{\DRreg{s}{x}{2}}{right=of a}
      \event{c}{\DW{y}{1}}{right=of b}
      \event{d}{\DW{z}{1}}{right=of c}
      \po[out=15,in=165]{a}{c}
      \po[out=15,in=165]{b}{d}
    \end{tikzinline}}
  \\
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{a}{\DRreg{r}{x}{1}}{}
      \event{b}{\DRreg{s}{x}{2}}{right=of a}
      \event{c}{\DW{y}{1}}{right=of b}
      \event{d}{\DW{z}{1}}{right=of c}
      \po[out=15,in=165]{a}{c}
      \po[out=15,in=165]{a}{d}
    \end{tikzinline}}
\end{gather*}          
\begin{gather*}
  \PR{x}{s}
  \SEMI \PR{x}{r}
  \SEMI \IF{r{>}0}\THEN \PW{y}{1}\FI
  \SEMI \IF{s{>}0}\THEN \PW{z}{1}\FI
  \\
  \PR{x}{s}
  \SEMI \IF{s{>}0}\THEN \PW{z}{1}\FI
  \SEMI \PR{x}{r}
  \SEMI \IF{r{>}0}\THEN \PW{y}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{a}{\DRreg{r}{x}{1}}{}
      \event{b}{\DRreg{s}{x}{2}}{right=of a}
      \event{c}{\DW{y}{1}}{right=of b}
      \event{d}{\DW{z}{1}}{right=of c}
      \po[out=15,in=165]{a}{c}
      \po[out=15,in=165]{b}{d}
    \end{tikzinline}}
  \\
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{a}{\DRreg{r}{x}{1}}{}
      \event{b}{\DRreg{s}{x}{2}}{right=of a}
      \event{c}{\DW{y}{1}}{right=of b}
      \event{d}{\DW{z}{1}}{right=of c}
      \po{b}{c}
      \po[out=15,in=165]{b}{d}
    \end{tikzinline}}
\end{gather*}          
\begin{gather*}
  \PR{x}{s}
  \SEMI \IF{r{>}0}\THEN \PW{y}{1}\FI
  \SEMI \IF{s{>}0}\THEN \PW{z}{1}\FI
  \\
  \hbox{\begin{tikzinline}[node distance=1em]
      \event{b}{\DRreg{s}{x}{2}}{}
      \event{c}{r{>}0\bigmid\DW{y}{1}}{right=of b}
      \event{d}{\DW{z}{1}}{right=of c}
      % \po{b}{c}
      \po[out=15,in=165]{b}{d}
    \end{tikzinline}}
\end{gather*}          
% For the desired result, it is sufficient if
% \begin{gather*}
%   \PR{x}{s}
%   \SEMI \IF{r{>}0}\THEN \PW{y}{1}\FI
%   \SEMI \IF{s{>}0}\THEN \PW{z}{1}\FI
%   \\
%   \hbox{\begin{tikzinline}[node distance=1em]
%     \event{b}{\DRreg{s}{x}{2}}{}
%     \event{c}{r{=}x\bigmid\DW{y}{1}}{right=of b}
%     \event{d}{\DW{z}{1}}{right=of c}
%     \po{b}{c}
%     \po[out=15,in=165]{b}{d}
%   \end{tikzinline}}
% \end{gather*}          

\begin{gather*}
  \begin{gathered}
    \PR{x}{r}
    \SEMI \PR{x}{s}
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{a}{\DRreg{r}{x}{1}}{}
        \event{b}{\DRreg{s}{x}{2}}{right=of a}
        \final{f}{\SUB{x/r,x/s}}{below=of a}
      \end{tikzinline}}
  \end{gathered}
  \qquad
  \begin{gathered}
    \IF{r{>}0}\THEN \PW{y}{1}\FI
    \SEMI \IF{s{>}0}\THEN \PW{z}{1}\FI
    \\[-1ex]
    \hbox{\begin{tikzinline}[node distance=.2em]
        \event{c}{r{>}0 \bigmid \DW{y}{1}}{}
        \event{d}{s{>}0 \bigmid \DW{z}{1}}{right=of c}
        \final{f}{r{>}0 \land s{>}0 \bigmid \SUB{1/y,1/z}}{below=of c}
      \end{tikzinline}}
  \end{gathered}
\end{gather*}

Idea to get rid of 4b and change 5a to the following:
\begin{itemize}
\item[5a.]  if $\aEv$ writes then either $\labelingForm'(\aEv)$ implies
  $\labelingForm(\aEv)$, or some $\cEv\lt'\aEv$ reads $\aVal$
  from $\aLoc$ and $\labelingForm'(\aEv)$ implies $\labelingForm(\aEv)[\aVal/\aLoc]$,
\end{itemize}
Need to get rid of 4b because it is sensitive to order of reads.

This change seems sound, because of consistency.  But it also fails to
validate read reordering on same variable, due to consistency.

Without 4b, we still do not allow:
\begin{gather*}
  \PR{x}{r}\SEMI
  \PR{x}{s}\SEMI
  \PW{y}{r}\SEMI
  \PW{z}{r}
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DR{x}{1}}{}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \event{a4}{\DW{z}{2}}{right=of a3}
      \po[out=15,in=165]{a1}{a3}
      \po[out=15,in=165]{a2}{a4}
    \end{tikzinline}}
\end{gather*}
The following is not a pomset (consistency):
\begin{gather*}
  \PW{y}{r}\SEMI
  \PW{z}{r}
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a3}{r\EQ1\bigmid\DW{y}{1}}{right=of a2}
      \event{a4}{r\EQ2\bigmid\DW{z}{2}}{right=of a3}
    \end{tikzinline}}
\end{gather*}

Without 4b, we still do not allow:
\begin{gather*}
  \PR{x}{r}\SEMI
  \PR{x}{s}\SEMI
  \PW{y}{r}\SEMI
  \PW{z}{s}\SEMI
  \IF{r{=}s}\THEN \PW{a}{1}\FI\SEMI
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DR{x}{1}}{}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \event{a4}{\DW{z}{2}}{right=of a3}
      \event{a5}{x{=}x\bigmid\DW{a}{1}}{right=of a4}
      \po[out=15,in=165]{a1}{a3}
      \po[out=15,in=165]{a2}{a4}
    \end{tikzinline}}
\end{gather*}
The following is not a pomset (consistency):
\begin{gather*}
  \PW{y}{r}\SEMI
  \PW{z}{s}\SEMI
  \IF{r{=}s}\THEN \PW{a}{1}\FI\SEMI
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a3}{r{=}1\bigmid\DW{y}{1}}{}
      \event{a4}{s{=}2\bigmid\DW{z}{2}}{right=of a3}
      \event{a5}{r{=}s\bigmid\DW{a}{1}}{right=of a4}
    \end{tikzinline}}
\end{gather*}

We do allow:
\begin{gather*}
  \PR{x}{r}\SEMI
  \PR{x}{s}\SEMI
  \IF{r{=}s}\THEN \PW{a}{1}\FI\SEMI
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DR{x}{1}}{}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{x{=}x\bigmid\DW{a}{1}}{right=of a2}
    \end{tikzinline}}
\end{gather*}
% \begin{gather*}
%   \PR{x}{s}\SEMI
%   \IF{r{=}s}\THEN \PW{a}{1}\FI\SEMI
%   \\[-1ex]
%   \nonumber
%   \hbox{\begin{tikzinline}[node distance=.5em and 1em]
%     \event{a2}{\DR{x}{2}}{}
%     \event{a3}{r{=}x\bigmid\DW{a}{1}}{right=of a2}
%   \end{tikzinline}}
% \end{gather*}
And also
\begin{gather*}
  \PR{x}{r_1}\SEMI
  \PR{x}{r_2}\SEMI
  \PR{x}{r_3}\SEMI
  \IF{r_3{\leq}1}\THEN \PW{y}{1}\FI\SEMI
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a0}{\DR{x}{0}}{}
      \event{a1}{\DR{x}{2}}{right=of a0}
      \event{a2}{\DR{x}{1}}{right=of a1}
      \event{a3}{1{\leq}1\bigmid\DW{y}{1}}{right=of a2}
      \po[out=15,in=165]{a0}{a3}
    \end{tikzinline}}
\end{gather*}

But we cannot wait forever to satisfy a precondition.
This is not a pomset:
\begin{gather*}
  \PR{x}{r}\SEMI
  \PR{x}{s}\SEMI
  \PW{y}{r}\SEMI
  \PW{z}{s}
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a3}{\DR{x}{3}}{}
      \event{a4}{\DR{x}{4}}{right=of a3}
      \event{a5}{x{=}1\bigmid\DW{y}{1}}{right=of a4}
      \event{a6}{x{=}2\bigmid\DW{z}{2}}{right=of a5}
    \end{tikzinline}}
\end{gather*}
Note that reads that we delay must all be consistent.

Also note that we cannot have:
\begin{gather*}
  \PR{x}{r}\SEMI \PW{a}{r}\SEMI
  \PR{x}{s}\SEMI \PW{b}{s}\SEMI
  \PW{y}{r}\SEMI
  \PW{z}{s}
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a3}{\DR{x}{3}}{}
      \event{a4}{\DR{x}{4}}{right=of a3}
      \event{a5}{x{=}1\bigmid\DW{y}{1}}{right=of a4}
      \event{a6}{x{=}1\bigmid\DW{z}{2}}{right=of a5}
      \event{b3}{\DW{a}{3}}{below=of a3}
      \event{b4}{\DW{b}{4}}{below=of a4}
      \po{a3}{b3}
      \po{a4}{b4}
    \end{tikzinline}}
\end{gather*}
Because the following is not a pomset:
\begin{gather*}
  \PW{b}{s}\SEMI
  \PW{y}{r}\SEMI
  \PW{z}{s}
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a5}{r{=}1\bigmid\DW{y}{1}}{right=of a4}
      \event{a6}{s{=}1\bigmid\DW{z}{2}}{right=of a5}
      \event{b4}{s{=}4\bigmid\DW{b}{4}}{below left=of a5}
    \end{tikzinline}}
\end{gather*}
But we can have the following, since there is no order the reads:
\begin{gather*}
  \PR{x}{r_1}\SEMI
  \PR{x}{s_1}\SEMI  
  \PR{x}{r_2}\SEMI
  \PR{x}{s_2}\SEMI
  \PW{y}{r_2}\SEMI
  \PW{z}{s_2}
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DR{x}{1}}{}
      \event{a2}{\DR{x}{2}}{right=of a1}
      \event{a3}{\DR{x}{3}}{right=of a2}
      \event{a4}{\DR{x}{4}}{right=of a3}
      \event{a5}{\DW{y}{1}}{right=of a4}
      \event{a6}{\DW{z}{2}}{right=of a5}
      \po[out=15,in=165]{a1}{a5}
      \po[out=15,in=165]{a2}{a6}
    \end{tikzinline}}
\end{gather*}
Because this is indistinguishable from:
\begin{gather*}
  \PR{x}{r_1}\SEMI
  \PR{x}{s_1}\SEMI  
  \PR{x}{r_2}\SEMI
  \PR{x}{s_2}\SEMI
  \PW{y}{r_2}\SEMI
  \PW{z}{s_2}
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DR{x}{3}}{}
      \event{a2}{\DR{x}{4}}{right=of a1}
      \event{a3}{\DR{x}{1}}{right=of a2}
      \event{a4}{\DR{x}{2}}{right=of a3}
      \event{a5}{\DW{y}{1}}{right=of a4}
      \event{a6}{\DW{z}{2}}{right=of a5}
      \po[out=15,in=165]{a3}{a5}
      \po[out=15,in=165]{a4}{a6}
    \end{tikzinline}}
\end{gather*}
which is the same as:
\begin{gather*}
  \PR{x}{r_1}\SEMI
  \PR{x}{r_2}\SEMI
  \PW{y}{r_2}\SEMI
  \PR{x}{s_1}\SEMI  
  \PR{x}{s_2}\SEMI
  \PW{z}{s_2}
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DR{x}{1}}{}
      \event{a2}{\DR{x}{3}}{right=of a1}
      \event{a3}{\DW{y}{1}}{right=of a2}
      \event{a4}{\DR{x}{2}}{right=of a3}
      \event{a5}{\DR{x}{4}}{right=of a4}
      \event{a6}{\DW{z}{2}}{right=of a5}
      \po[out=15,in=165]{a1}{a3}
      \po[out=15,in=165]{a4}{a6}
    \end{tikzinline}}
\end{gather*}

But we can have:
\begin{gather*}
  \PR{x}{p}\SEMI
  \PR{x}{r}\SEMI
  \PR{x}{s}\SEMI
  \PW{y}{r}\SEMI
  \PW{z}{s}
  \\[-1ex]
  \nonumber
  \hbox{\begin{tikzinline}[node distance=.5em and 1em]
      \event{a1}{\DR{x}{3}}{}
      \event{a2}{\DR{x}{4}}{right=of a1}
      \event{a3}{x{=}1\bigmid\DW{y}{1}}{right=of a2}
      \event{a4}{x{=}1\bigmid\DW{z}{1}}{right=of a3}
      \event{b2}{\DR{x}{1}}{left=of a1}
      \po[out=15,in=165]{b2}{a3}
      \po[out=15,in=165]{b2}{a4}
      % \po[out=15,in=165]{a1}{a3}
      % \po[out=15,in=165]{a2}{a4}
    \end{tikzinline}}
\end{gather*}

Reads can only swap when their values are interchangeable in the following
program.

\subsection{Alan comments}

\begin{verbatim}
  x=s; y=r; z=3s+2r

  x=s; y=r; z1=s; if(r odd){ z2=1} // using 1 and 3 as the reads
\end{verbatim}
